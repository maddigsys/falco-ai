{% extends "falco_base.html" %}

{% block title %}Falco AI Alert System - Dashboard{% endblock %}
{% block page_icon %}<i class="fas fa-tachometer-alt"></i>{% endblock %}
{% block page_title %}Security Dashboard{% endblock %}
{% block page_description %}Real-time security monitoring with AI-powered analysis and intelligent alerting{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard-specific layout */
    .dashboard-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-xl);
        min-height: calc(100vh - 180px);
    }

    /* Three Cards Grid Layout */
    .three-cards-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
    }

    /* Filter Card - now uses same styling as other cards */
    .filter-card {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--falco-primary);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .filter-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
        border-color: var(--falco-primary-light);
        border-top-color: var(--falco-primary-dark);
    }

    .section-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .filter-group {
        margin-bottom: var(--space-lg);
    }

    .filter-group label {
        display: block;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
        font-size: var(--text-sm);
    }

    .filter-group select {
        width: 100%;
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        font-size: var(--text-sm);
        transition: border-color 0.2s ease;
        background: var(--falco-white);
    }

    .filter-group select:focus {
        border-color: var(--falco-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    /* Alert Status Card */
    .alert-status-card {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--falco-accent);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .alert-status-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
        border-color: var(--falco-primary-light);
        border-top-color: var(--falco-accent);
    }

    .status-stats {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: var(--text-sm);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: var(--text-xs);
        min-width: 2.5rem;
        justify-content: center;
    }

    .status-unread {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-read {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-dismissed {
        background: rgba(107, 114, 128, 0.1);
        color: var(--text-muted);
        border: 1px solid rgba(107, 114, 128, 0.2);
    }

    .status-label {
        color: var(--text-primary);
        font-weight: 500;
    }

    .bulk-actions {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .btn-bulk {
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        color: var(--text-primary);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        justify-content: center;
    }

    .btn-bulk:hover {
        background: var(--primary-gradient);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-bulk:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Main Content */
    .dashboard-main {
        background: transparent;
        padding: 0;
        overflow-y: auto;
        flex: 1;
    }

    /* Stats Grid */
    .stats-grid-main {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-xl);
        margin-bottom: var(--space-xl);
    }

    .stat-card {
        background: var(--primary-gradient);
        color: white;
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        text-align: center;
        box-shadow: var(--shadow-md);
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .stat-card.clickable {
        cursor: pointer;
    }

    .stat-card.danger {
        background: var(--danger-gradient);
    }

    .stat-card.success {
        background: var(--success-gradient);
    }

    .stat-card.status-card.unread {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        color: var(--danger);
    }

    .stat-card.status-card.read {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        color: var(--success);
    }

    .stat-number {
        font-size: var(--text-4xl);
        font-weight: 700;
        margin-bottom: var(--space-sm);
    }

    .stat-label {
        font-size: var(--text-sm);
        opacity: 0.9;
    }

    /* Welcome Grid */
    .welcome-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-xl);
        margin: var(--space-xl) 0;
    }

    .feature-card {
        background: var(--bg-card);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }

    .feature-card.clickable {
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .feature-card.clickable:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
        border-color: var(--falco-primary);
        background: linear-gradient(135deg, rgba(0, 174, 199, 0.05), rgba(0, 212, 170, 0.05));
    }

    .feature-card h4 {
        color: var(--falco-primary);
        margin-bottom: var(--space-lg);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: var(--text-lg);
    }

    .feature-action {
        margin-top: var(--space-lg);
        padding: var(--space-md) var(--space-lg);
        background: var(--primary-gradient);
        color: white;
        border-radius: var(--radius-md);
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
    }

    .feature-card.clickable:hover .feature-action {
        background: linear-gradient(135deg, #00D4AA 0%, #00AEC7 100%);
        transform: scale(1.05);
    }

    /* Alert List */
    .alert-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .alert-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .alert-item:hover {
        border-color: var(--falco-primary);
        background: rgba(0, 174, 199, 0.05);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .alert-item.selected {
        border-color: var(--falco-primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-lg);
    }

    .alert-item.unread {
        border-left: 4px solid var(--danger);
        background: rgba(239, 68, 68, 0.02);
    }

    .alert-item.read {
        opacity: 0.8;
        border-left: 4px solid var(--success);
    }

    .alert-item.dismissed {
        opacity: 0.6;
        border-left: 4px solid var(--text-muted);
        background: rgba(107, 114, 128, 0.02);
    }

    .alert-rule {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-md);
        font-size: var(--text-base);
        line-height: 1.3;
    }

    .alert-meta {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        font-size: var(--text-sm);
        color: var(--text-secondary);
        gap: var(--space-sm);
    }

    .alert-priority {
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-weight: 500;
        text-transform: uppercase;
        font-size: var(--text-xs);
        letter-spacing: 0.025em;
    }

    .priority-critical { background: var(--danger); color: white; box-shadow: var(--shadow-sm); }
    .priority-error { background: #ea580c; color: white; box-shadow: var(--shadow-sm); }
    .priority-warning { background: var(--warning); color: white; box-shadow: var(--shadow-sm); }
    .priority-notice { background: var(--info); color: white; box-shadow: var(--shadow-sm); }
    .priority-informational { background: var(--text-muted); color: white; box-shadow: var(--shadow-sm); }

    .alert-badge {
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.025em;
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
    }

    .badge-ai-analyzed {
        background: var(--success);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .badge-ai-pending {
        background: var(--warning);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .badge-ai-error {
        background: var(--danger);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .badge-provider {
        background: var(--falco-primary);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .badge-source {
        background: var(--text-muted);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    /* Config sections */
    .config-section {
        margin-bottom: var(--space-xl);
    }

    .config-value-container {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-top: var(--space-sm);
    }

    .config-value {
        background: var(--bg-secondary);
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-light);
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: var(--text-sm);
        flex: 1;
        word-break: break-all;
    }

    .config-yaml-container {
        position: relative;
        margin-top: var(--space-sm);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-light);
        overflow: hidden;
    }

    .config-yaml {
        background: var(--bg-secondary);
        padding: var(--space-lg);
        border-radius: 0;
        border: none;
        font-family: 'Fira Code', 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: var(--text-sm);
        line-height: 1.5;
        margin: 0;
        white-space: pre;
        overflow-x: auto;
        color: var(--text-primary);
        tab-size: 2;
        -moz-tab-size: 2;
        -webkit-tab-size: 2;
        min-height: 300px;
    }

    .yaml-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-md) var(--space-lg);
        background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
        border-bottom: 1px solid var(--border-light);
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        font-size: var(--text-sm);
    }

    .yaml-filename {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-family: 'Fira Code', 'Monaco', 'Menlo', 'Consolas', monospace;
        font-weight: 600;
        color: var(--text-primary);
    }

    .yaml-filename i {
        color: var(--falco-primary);
    }

    .yaml-header .btn {
        padding: var(--space-xs) var(--space-sm);
        font-size: var(--text-xs);
        border-color: var(--border-medium);
    }

    /* Collapsible sections */
    .collapsible-header {
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        padding: var(--space-sm);
        border-radius: var(--radius-md);
    }

    .collapsible-header:hover {
        background: linear-gradient(135deg, rgba(0, 174, 199, 0.08), rgba(83, 86, 90, 0.08));
    }

    .card-title {
        width: 100%;
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .card-title .falco-config-toggle-icon,
    .card-title .card-toggle-icon {
        margin-left: auto;
    }

    .quick-stats-toggle-icon,
    .falco-config-toggle-icon,
    .card-toggle-icon {
        margin-left: auto;
        transition: transform 0.3s ease;
        color: var(--falco-primary);
        font-size: var(--text-sm);
    }

    #quickStatsCard.collapsed .quick-stats-content {
        display: none;
    }

    #quickStatsCard.collapsed .quick-stats-toggle-icon {
        transform: rotate(180deg);
    }

    #falcoConfigCard.collapsed .falco-config-content {
        display: none;
    }

    #falcoConfigCard.collapsed .falco-config-toggle-icon {
        transform: rotate(180deg);
    }

    #falcoIntegrationCard.collapsed .falco-config-content {
        display: none;
    }

    #falcoIntegrationCard.collapsed .falco-config-toggle-icon {
        transform: rotate(180deg);
    }

    /* Collapsed states for the three cards */
    #alertFiltersCard.collapsed .card-content {
        display: none;
    }

    #alertFiltersCard.collapsed .card-toggle-icon {
        transform: rotate(180deg);
    }

    #alertStatusCard.collapsed .card-content {
        display: none;
    }

    #alertStatusCard.collapsed .card-toggle-icon {
        transform: rotate(180deg);
    }

    #criticalStatsCard.collapsed .card-content {
        display: none;
    }

    #criticalStatsCard.collapsed .card-toggle-icon {
        transform: rotate(180deg);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
    }

    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: var(--space-lg);
    }

    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .three-cards-grid {
            grid-template-columns: 1fr;
            gap: var(--space-lg);
        }
        
        .stats-grid-main {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .three-cards-grid {
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }
        
        .welcome-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid-main {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
        
        .alert-meta {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Falco Integration Setup (Collapsible) -->
    <div class="falco-card" id="falcoIntegrationCard">
        <div class="card-header collapsible-header" onclick="toggleFalcoIntegration()">
            <h3 class="card-title">
                <i class="fas fa-cog"></i>
                Falco Integration Setup
                <i class="fas fa-chevron-up falco-config-toggle-icon"></i>
            </h3>
        </div>
        <div class="card-body falco-config-content">
            <div class="empty-state">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Configure Falco to send alerts to this system</strong><br>
                            Use the webhook URLs below in your Falco configuration to start receiving security alerts with AI analysis.
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="config-section">
                            <h5><i class="fas fa-link"></i> Webhook URLs</h5>
                            <p class="text-muted">Use these URLs to configure Falco HTTP output</p>
                            
                            <div class="mb-3">
                                <label class="fw-bold">🌐 External/Ingress URL:</label>
                                <div class="config-value-container">
                                    <input type="text" class="config-value" id="externalWebhookUrl" value="" readonly>
                                    <button class="btn btn-sm btn-outline" onclick="copyToClipboard('externalWebhookUrl')" title="Copy URL">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Use this URL if Falco runs outside Kubernetes or you have external access configured</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="fw-bold">🏠 Internal/Kubernetes URL:</label>
                                <div class="config-value-container">
                                    <input type="text" class="config-value" id="internalWebhookUrl" value="" readonly>
                                    <button class="btn btn-sm btn-outline" onclick="copyToClipboard('internalWebhookUrl')" title="Copy URL">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Use this URL if Falco runs inside the same Kubernetes cluster</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="config-section">
                            <h5><i class="fas fa-chart-line"></i> Test Webhook</h5>
                            <p class="text-muted">Send a test alert to verify configuration</p>
                            
                            <button class="btn btn-primary w-100" onclick="sendTestAlert()">
                                <i class="fas fa-paper-plane"></i>
                                Send Test Alert
                            </button>
                            
                            <div id="testResult" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="config-section">
                            <h5><i class="fas fa-file-code"></i> Falco Configuration (YAML)</h5>
                            <p class="text-muted">Basic falco.yaml configuration for HTTP output</p>
                            
                            <div class="config-yaml-container">
                                <div class="yaml-header">
                                    <span class="yaml-filename">
                                        <i class="fas fa-file"></i>
                                        falco.yaml
                                    </span>
                                    <button class="btn btn-sm btn-outline" onclick="copyToClipboard('falcoYamlConfig')" title="Copy Configuration">
                                        <i class="fas fa-copy"></i>
                                        Copy
                                    </button>
                                </div>
                                <pre class="config-yaml" id="falcoYamlConfig">Loading...</pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="config-section">
                            <h5><i class="fas fa-dharmachakra"></i> Kubernetes ConfigMap</h5>
                            <p class="text-muted">ConfigMap for Kubernetes deployment</p>
                            
                            <div class="config-yaml-container">
                                <div class="yaml-header">
                                    <span class="yaml-filename">
                                        <i class="fab fa-kubernetes"></i>
                                        falco-config.yaml
                                    </span>
                                    <button class="btn btn-sm btn-outline" onclick="copyToClipboard('falcoK8sConfig')" title="Copy Configuration">
                                        <i class="fas fa-copy"></i>
                                        Copy
                                    </button>
                                </div>
                                <pre class="config-yaml" id="falcoK8sConfig">Loading...</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Three Card Layout -->
    <div class="three-cards-grid">
        <!-- Alert Filters Card -->
        <div class="filter-card" id="alertFiltersCard">
            <div class="card-header collapsible-header" onclick="toggleAlertFilters()">
                <h3 class="card-title">
                    <i class="fas fa-filter"></i>
                    Alert Filters & Controls
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </h3>
            </div>
            <div class="card-body card-content">
                <div class="filter-group">
                    <label for="timeRange">Time Range</label>
                    <select id="timeRange" onchange="applyFilters()">
                        <option value="all">All Time</option>
                        <option value="1h">Last Hour</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d" selected>Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="priorityFilter">Priority</label>
                    <select id="priorityFilter" onchange="applyFilters()">
                        <option value="all">All Priorities</option>
                        <option value="critical">Critical</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="notice">Notice</option>
                        <option value="informational">Informational</option>
                        <option value="debug">Debug</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="ruleFilter">Rule</label>
                    <select id="ruleFilter" onchange="applyFilters()">
                        <option value="all">All Rules</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="all">All Status</option>
                        <option value="unread">Unread</option>
                        <option value="read">Read</option>
                        <option value="dismissed">Dismissed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="limitFilter">Show</label>
                    <select id="limitFilter" onchange="applyFilters()">
                        <option value="25">25 alerts</option>
                        <option value="50">50 alerts</option>
                        <option value="100">100 alerts</option>
                        <option value="all">All alerts</option>
                    </select>
                </div>
                
                <div class="bulk-actions">
                    <button class="btn-bulk" onclick="markAllAsRead()" title="Mark all visible alerts as read">
                        <i class="fas fa-check"></i>
                        Mark All Read
                    </button>
                    <button class="btn-bulk" onclick="dismissAllVisible()" title="Dismiss all visible alerts">
                        <i class="fas fa-times"></i>
                        Dismiss All
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Status Card -->
        <div class="alert-status-card" id="alertStatusCard">
            <div class="card-header collapsible-header" onclick="toggleAlertStatus()">
                <h3 class="card-title">
                    <i class="fas fa-eye"></i>
                    Alert Status
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </h3>
            </div>
            <div class="card-body card-content">
                <div class="status-stats">
                    <div class="status-item">
                        <span class="status-badge status-unread">
                            <i class="fas fa-circle"></i>
                            <span id="unreadCount">-</span>
                        </span>
                        <span class="status-label">Unread</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge status-read">
                            <i class="fas fa-check-circle"></i>
                            <span id="readCount">-</span>
                        </span>
                        <span class="status-label">Read</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge status-dismissed">
                            <i class="fas fa-times-circle"></i>
                            <span id="dismissedCount">-</span>
                        </span>
                        <span class="status-label">Dismissed</span>
                    </div>
                </div>
                
                <div class="bulk-actions">
                    <button class="btn-bulk" onclick="markAllAsRead()" title="Mark all visible alerts as read">
                        <i class="fas fa-check"></i>
                        Mark All Read
                    </button>
                    <button class="btn-bulk" onclick="dismissAllVisible()" title="Dismiss all visible alerts">
                        <i class="fas fa-times"></i>
                        Dismiss All
                    </button>
                </div>
            </div>
        </div>

        <!-- Critical Stats Card -->
        <div class="alert-status-card" id="criticalStatsCard">
            <div class="card-header collapsible-header" onclick="toggleCriticalStats()">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Critical Stats
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </h3>
            </div>
            <div class="card-body card-content">
                <div class="status-stats">
                    <div class="status-item">
                        <span class="status-badge status-unread">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="criticalCountControl">-</span>
                        </span>
                        <span class="status-label">Critical</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge status-read">
                            <i class="fas fa-clock"></i>
                            <span id="recentCountControl">-</span>
                        </span>
                        <span class="status-label">Last Hour</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge status-dismissed">
                            <i class="fas fa-shield-alt"></i>
                            <span id="totalCountControl">-</span>
                        </span>
                        <span class="status-label">Total</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-main">

        <!-- Welcome/Overview -->
        <div class="falco-card" id="welcomeCard">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-home"></i>
                    Welcome to Falco AI Alert System
                </h3>
            </div>
            <div class="card-body">
                <div class="empty-state">
                    <p>Your intelligent security monitoring dashboard is ready to help you stay ahead of threats.</p>
                    
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>Getting Started:</strong> Click to expand the <strong>Falco Integration Setup</strong> section at the top to configure Falco webhooks and start receiving AI-powered security analysis.
                    </div>
                    
                    <div class="welcome-grid">
                        <div class="feature-card">
                            <h4><i class="fas fa-shield-alt"></i> Real-time Monitoring</h4>
                            <p>Monitor security events from Falco with AI-powered analysis and intelligent alerting.</p>
                        </div>
                        <div class="feature-card clickable" onclick="window.location.href='/enhanced-chat'">
                            <h4><i class="fas fa-robot"></i> AI Security Command Center</h4>
                            <p>Central AI-powered security management with persona-based analysis, semantic search, and dynamic report generation.</p>
                            <div class="feature-action">
                                <i class="fas fa-arrow-right"></i> Launch Command Center
                            </div>
                        </div>
                        <div class="feature-card clickable" onclick="window.location.href='/chat'">
                            <h4><i class="fas fa-comments"></i> AI Security Chat</h4>
                            <p>Chat with AI about security alerts in real-time. Ask questions, get insights, and understand threats better.</p>
                            <div class="feature-action">
                                <i class="fas fa-arrow-right"></i> Start Chatting
                            </div>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                            <p>Get instant security insights and recommendations powered by advanced AI models.</p>
                        </div>
                        <div class="feature-card">
                            <h4><i class="fab fa-slack"></i> Slack Integration</h4>
                            <p>Receive critical alerts directly in Slack with actionable intelligence.</p>
                        </div>
                        <div class="feature-card clickable" onclick="window.location.href='/weaviate-analytics'">
                            <h4><i class="fas fa-chart-line"></i> AI-Powered Analytics</h4>
                            <p>Advanced ML-driven clustering, threat intelligence, and semantic search with real-time insights.</p>
                            <div class="feature-action">
                                <i class="fas fa-arrow-right"></i> Launch Analytics
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="falco-card" id="quickStatsCard" style="display: none;">
            <div class="card-header collapsible-header" onclick="toggleQuickStats()">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Quick Stats
                    <i class="fas fa-chevron-up quick-stats-toggle-icon"></i>
                </h3>
            </div>
            <div class="card-body quick-stats-content">
                <div class="stats-grid-main">
                    <div class="stat-card clickable" onclick="applyStatFilter('all', event)" title="Show all alerts">
                        <div class="stat-number" id="totalAlertsMain">-</div>
                        <div class="stat-label" data-translate="Total Alerts">Total Alerts</div>
                    </div>
                    <div class="stat-card danger clickable" onclick="applyStatFilter('critical', event)" title="Show critical alerts">
                        <div class="stat-number" id="criticalAlertsMain">-</div>
                        <div class="stat-label" data-translate="Critical Alerts">Critical Alerts</div>
                    </div>
                    <div class="stat-card success clickable" onclick="applyStatFilter('recent', event)" title="Show alerts from last hour">
                        <div class="stat-number" id="recentAlertsMain">-</div>
                        <div class="stat-label" data-translate="Last Hour">Last Hour</div>
                    </div>
                    <div class="stat-card status-card unread clickable" onclick="applyStatFilter('unread', event)" title="Show unread alerts">
                        <div class="stat-number" id="unreadCountMain">-</div>
                        <div class="stat-label" data-translate="Unread">Unread</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert List -->
        <div class="falco-card" id="alertsCard" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span data-translate="Recent Security Alerts">Recent Security Alerts</span>
                    <span class="badge bg-primary" id="alertCountBadge">0</span>
                </h3>
            </div>
            <div class="card-body">
                <div class="alert-list" id="alertList">
                    <!-- Alerts will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let alerts = [];
    let filteredAlerts = [];
    let currentFilters = {
        timeRange: '7d',
        priority: 'all',
        rule: 'all',
        status: 'all',
        limit: '25'
    };
    let alertStats = {
        total: 0,
        unread: 0,
        read: 0,
        dismissed: 0,
        critical: 0,
        recent: 0
    };

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Read URL parameters and set filters
        initializeFiltersFromURL();
        
        // Generate webhook URLs
        generateWebhookUrls();
        
        // Load alerts with filters
        loadAlerts();
        
        // Load alert counts
        loadAlertCounts();
        
        // Set up periodic refresh
        setInterval(loadAlerts, 30000); // Refresh every 30 seconds
        setInterval(loadAlertCounts, 30000);
    });

    // Initialize filters from URL parameters
    function initializeFiltersFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Set time range filter
        const timeRange = urlParams.get('time_range') || 'all';
        const timeRangeSelect = document.getElementById('timeRange');
        if (timeRangeSelect && timeRange !== 'all') {
            timeRangeSelect.value = timeRange;
            currentFilters.timeRange = timeRange;
        }
        
        // Set priority filter
        const priority = urlParams.get('priority') || 'all';
        const prioritySelect = document.getElementById('priorityFilter');
        if (prioritySelect && priority !== 'all') {
            prioritySelect.value = priority;
            currentFilters.priority = priority;
        }
        
        // Set rule filter (will be set after rules are loaded)
        const rule = urlParams.get('rule') || 'all';
        if (rule !== 'all') {
            currentFilters.rule = rule;
        }
        
        // Set status filter
        const status = urlParams.get('status') || 'all';
        const statusSelect = document.getElementById('statusFilter');
        if (statusSelect && status !== 'all') {
            statusSelect.value = status;
            currentFilters.status = status;
        }
        
        // Set limit filter
        const limit = urlParams.get('limit') || '25';
        const limitSelect = document.getElementById('limitFilter');
        if (limitSelect && limit !== '25') {
            limitSelect.value = limit;
            currentFilters.limit = limit;
        }
        
        // Set source filter (if provided)
        const source = urlParams.get('source');
        if (source) {
            currentFilters.source = source;
        }
    }

    // Load alerts with current filters
    async function loadAlerts() {
        try {
            // Build API URL with current filters
            const params = new URLSearchParams();
            if (currentFilters.timeRange !== 'all') params.append('time_range', currentFilters.timeRange);
            if (currentFilters.priority !== 'all') params.append('priority', currentFilters.priority);
            if (currentFilters.rule !== 'all') params.append('rule', currentFilters.rule);
            if (currentFilters.status !== 'all') params.append('status', currentFilters.status);
            if (currentFilters.limit !== '25') params.append('limit', currentFilters.limit);
            if (currentFilters.source) params.append('source', currentFilters.source);
            
            const apiUrl = '/api/alerts' + (params.toString() ? '?' + params.toString() : '');
            const response = await fetch(apiUrl);
            
            if (response.ok) {
                alerts = await response.json();
                
                // Apply source filter if set (since API doesn't support this yet)
                if (currentFilters.source) {
                    alerts = alerts.filter(alert => 
                        (alert.source || 'unknown').toLowerCase().includes(currentFilters.source.toLowerCase())
                    );
                }
                
                applyFilters();
                updateStats();
                updateDisplay();
                
                // Update page title based on filters
                updatePageTitle();
            } else {
                console.error('Failed to load alerts:', response.statusText);
            }
        } catch (error) {
            console.error('Error loading alerts:', error);
        }
    }

    // Update page title based on active filters
    function updatePageTitle() {
        let title = 'Security Dashboard';
        const activeFilters = [];
        
        if (currentFilters.priority !== 'all') {
            activeFilters.push(`${currentFilters.priority} priority`);
        }
        if (currentFilters.rule !== 'all') {
            activeFilters.push(`rule: ${currentFilters.rule}`);
        }
        if (currentFilters.status !== 'all') {
            activeFilters.push(`${currentFilters.status} status`);
        }
        if (currentFilters.timeRange !== 'all') {
            activeFilters.push(`${currentFilters.timeRange} timeframe`);
        }
        if (currentFilters.source) {
            activeFilters.push(`source: ${currentFilters.source}`);
        }
        
        if (activeFilters.length > 0) {
            title += ` - ${activeFilters.join(', ')}`;
        }
        
        document.title = title;
        
        // Update the page header to show active filters
        const pageDescription = document.querySelector('.page-description');
        if (pageDescription) {
            if (activeFilters.length > 0) {
                pageDescription.textContent = `Filtered by: ${activeFilters.join(', ')}`;
            } else {
                pageDescription.textContent = 'Real-time security monitoring with AI-powered analysis and intelligent alerting';
            }
        }
    }

    // Apply current filters to alerts
    function applyFilters() {
        filteredAlerts = alerts.filter(alert => {
            // Time range filter - already applied by API
            // Priority filter - already applied by API  
            // Rule filter - already applied by API
            // Status filter - already applied by API
            // Source filter - applied locally if set
            
            return true; // All filtering now done by API or locally above
        });
        
        // Apply limit
        if (currentFilters.limit !== 'all') {
            const limit = parseInt(currentFilters.limit);
            filteredAlerts = filteredAlerts.slice(0, limit);
        }
    }

    // Update statistics
    function updateStats() {
        alertStats = {
            total: alerts.length,
            unread: alerts.filter(a => a.status === 'unread').length,
            read: alerts.filter(a => a.status === 'read').length,
            dismissed: alerts.filter(a => a.status === 'dismissed').length,
            critical: alerts.filter(a => a.priority === 'critical').length,
            recent: alerts.filter(a => {
                const alertTime = new Date(a.time);
                const now = new Date();
                return (now - alertTime) / (1000 * 60 * 60) <= 1;
            }).length
        };
        
        updateStatElements();
    }

    // Update stat display elements
    function updateStatElements() {
        const elements = {
            'totalAlertsMain': alertStats.total,
            'criticalAlertsMain': alertStats.critical,
            'recentAlertsMain': alertStats.recent,
            'unreadCountMain': alertStats.unread,
            'unreadCount': alertStats.unread,
            'readCount': alertStats.read,
            'dismissedCount': alertStats.dismissed,
            'criticalCountControl': alertStats.critical,
            'recentCountControl': alertStats.recent,
            'totalCountControl': alertStats.total
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
        
        const alertCountBadge = document.getElementById('alertCountBadge');
        if (alertCountBadge) {
            alertCountBadge.textContent = filteredAlerts.length;
        }
    }

    // Update display based on alerts
    function updateDisplay() {
        if (alerts.length === 0) {
            showWelcomeState();
        } else {
            showAlertsState();
            renderAlertList();
            populateRuleFilter();
        }
    }

    // Show welcome state (no alerts)
    function showWelcomeState() {
        document.getElementById('welcomeCard').style.display = 'block';
        document.getElementById('quickStatsCard').style.display = 'none';
        document.getElementById('alertsCard').style.display = 'none';
    }

    // Show alerts state (has alerts)
    function showAlertsState() {
        document.getElementById('welcomeCard').style.display = 'none';
        document.getElementById('quickStatsCard').style.display = 'block';
        document.getElementById('alertsCard').style.display = 'block';
    }

    // Render alert list
    function renderAlertList() {
        const alertList = document.getElementById('alertList');
        if (!alertList) return;
        
        if (filteredAlerts.length === 0) {
            alertList.innerHTML = '<div class="empty-state"><h4>No alerts match your current filters</h4><p>Try adjusting your filter criteria to see more results.</p></div>';
            return;
        }
        
        alertList.innerHTML = filteredAlerts.map(alert => `
            <div class="alert-item ${alert.status}" onclick="selectAlert('${alert.id}')" data-alert-id="${alert.id}">
                <div class="alert-rule">${escapeHtml(alert.rule)}</div>
                <div class="alert-meta">
                    <div>
                        <span class="alert-priority priority-${alert.priority}">${alert.priority}</span>
                        ${alert.ai_analysis ? '<span class="alert-badge badge-ai-analyzed">AI Analyzed</span>' : '<span class="alert-badge badge-ai-pending">AI Pending</span>'}
                        <span class="alert-badge badge-provider">${alert.provider || 'Falco'}</span>
                    </div>
                    <div>
                        <small>${formatTimestamp(alert.time)}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Toggle functions (removed control panel)

    function toggleQuickStats() {
        const card = document.getElementById('quickStatsCard');
        card.classList.toggle('collapsed');
    }

    function toggleFalcoIntegration() {
        const card = document.getElementById('falcoIntegrationCard');
        card.classList.toggle('collapsed');
    }

    function toggleAlertFilters() {
        const card = document.getElementById('alertFiltersCard');
        card.classList.toggle('collapsed');
    }

    function toggleAlertStatus() {
        const card = document.getElementById('alertStatusCard');
        card.classList.toggle('collapsed');
    }

    function toggleCriticalStats() {
        const card = document.getElementById('criticalStatsCard');
        card.classList.toggle('collapsed');
    }

    // Webhook URL generation
    function generateWebhookUrls() {
        const protocol = window.location.protocol;
        const host = window.location.host;
        const externalUrl = `${protocol}//${host}/webhook`;
        const internalUrl = 'http://falco-ai-alerts:8080/webhook';
        
        document.getElementById('externalWebhookUrl').value = externalUrl;
        document.getElementById('internalWebhookUrl').value = internalUrl;
        
        generateFalcoConfig(externalUrl, internalUrl);
    }

    // Generate Falco configuration
    function generateFalcoConfig(externalUrl, internalUrl) {
        const falcoYaml = `# Falco Configuration (falco.yaml)
# Add this to your existing falco.yaml configuration file

http_output:
  enabled: true
  url: ${externalUrl}
  user_agent: "falco/0.34.0"
  # Optional: Add custom headers if needed
  # custom_headers:
  #   Authorization: "Bearer your-token-here"

# Enable JSON output for structured alerts
json_output: true
json_include_output_property: true
json_include_tags_property: true

# Optional: Configure buffering for better performance
buffered_outputs: true

# Optional: Set output priority threshold
priority: debug`;

        const falcoK8sConfig = `# Kubernetes ConfigMap for Falco Configuration
# Apply this with: kubectl apply -f falco-config.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-config
  namespace: falco
  labels:
    app: falco
    component: config
data:
  falco.yaml: |
    # HTTP Output Configuration
    http_output:
      enabled: true
      url: ${internalUrl}
      user_agent: "falco/0.34.0"
      # Use internal service name for in-cluster communication
      # custom_headers:
      #   Authorization: "Bearer your-token-here"
    
    # JSON Output Settings
    json_output: true
    json_include_output_property: true
    json_include_tags_property: true
    
    # Performance Settings
    buffered_outputs: true
    priority: debug
    
    # Optional: Configure additional outputs
    # stdout_output:
    #   enabled: false
    # 
    # file_output:
    #   enabled: false`;

        document.getElementById('falcoYamlConfig').textContent = falcoYaml;
        document.getElementById('falcoK8sConfig').textContent = falcoK8sConfig;
    }

    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / (1000 * 60));
        
        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        
        const diffDays = Math.floor(diffHours / 24);
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString();
    }

    // Refresh dashboard
    function refreshDashboard() {
        loadAlerts();
    }

    // Copy to clipboard
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            let textToCopy = '';
            
            // Handle different element types
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.select();
                textToCopy = element.value;
            } else if (element.tagName === 'PRE') {
                textToCopy = element.textContent;
            } else {
                textToCopy = element.innerText || element.textContent;
            }
            
            // Use modern clipboard API if available
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showNotification('success', 'Configuration copied to clipboard!');
                }).catch(() => {
                    // Fallback to execCommand
                    fallbackCopyToClipboard(textToCopy);
                });
            } else {
                fallbackCopyToClipboard(textToCopy);
            }
        }
    }
    
    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showNotification('success', 'Configuration copied to clipboard!');
        } catch (err) {
            showNotification('error', 'Failed to copy to clipboard');
        }
        document.body.removeChild(textArea);
    }
    
    function showNotification(type, message) {
        // Simple notification - can be enhanced with a proper notification system
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: ${type === 'success' ? '#10b981' : '#ef4444'};
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            font-size: 14px;
            font-weight: 500;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // Test alert
    async function sendTestAlert() {
        try {
            const response = await fetch('/api/test-alert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = document.getElementById('testResult');
            result.style.display = 'block';
            
            if (response.ok) {
                result.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Test alert sent successfully!</div>';
                setTimeout(loadAlerts, 2000);
            } else {
                throw new Error('Failed to send test alert');
            }
        } catch (error) {
            const result = document.getElementById('testResult');
            result.style.display = 'block';
            result.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
        }
    }

    // Select alert
    function selectAlert(alertId) {
        document.querySelectorAll('.alert-item.selected').forEach(item => {
            item.classList.remove('selected');
        });
        
        const alertItem = document.querySelector(`[data-alert-id="${alertId}"]`);
        if (alertItem) {
            alertItem.classList.add('selected');
        }
        
        window.location.href = `/alerts/${alertId}`;
    }

    // Bulk actions
    async function markAllAsRead() {
        try {
            const response = await fetch('/api/alerts/mark-read-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                loadAlerts();
            }
        } catch (error) {
            console.error('Error marking alerts as read:', error);
        }
    }

    async function dismissAllVisible() {
        try {
            const alertIds = filteredAlerts.map(alert => alert.id);
            const response = await fetch('/api/alerts/dismiss-multiple', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ alert_ids: alertIds })
            });
            
            if (response.ok) {
                loadAlerts();
            }
        } catch (error) {
            console.error('Error dismissing alerts:', error);
        }
    }

    // Populate rule filter with URL parameter support
    function populateRuleFilter() {
        const ruleFilter = document.getElementById('ruleFilter');
        if (!ruleFilter) return;
        
        const rules = [...new Set(alerts.map(alert => alert.rule))].sort();
        const currentValue = ruleFilter.value;
        
        ruleFilter.innerHTML = '<option value="all">All Rules</option>';
        rules.forEach(rule => {
            const option = document.createElement('option');
            option.value = rule;
            option.textContent = rule;
            ruleFilter.appendChild(option);
        });
        
        // Set rule filter from URL parameter if provided
        if (currentFilters.rule !== 'all') {
            ruleFilter.value = currentFilters.rule;
        } else {
            ruleFilter.value = currentValue;
        }
    }

    // Filter application with URL update
    function applyFilters() {
        currentFilters.timeRange = document.getElementById('timeRange')?.value || 'all';
        currentFilters.priority = document.getElementById('priorityFilter')?.value || 'all';
        currentFilters.rule = document.getElementById('ruleFilter')?.value || 'all';
        currentFilters.status = document.getElementById('statusFilter')?.value || 'all';
        currentFilters.limit = document.getElementById('limitFilter')?.value || '25';
        
        // Update URL parameters
        updateURLParameters();
        
        // Reload alerts with new filters
        loadAlerts();
    }

    // Update URL parameters without refreshing the page
    function updateURLParameters() {
        const params = new URLSearchParams();
        
        if (currentFilters.timeRange !== 'all') params.append('time_range', currentFilters.timeRange);
        if (currentFilters.priority !== 'all') params.append('priority', currentFilters.priority);
        if (currentFilters.rule !== 'all') params.append('rule', currentFilters.rule);
        if (currentFilters.status !== 'all') params.append('status', currentFilters.status);
        if (currentFilters.limit !== '25') params.append('limit', currentFilters.limit);
        if (currentFilters.source) params.append('source', currentFilters.source);
        
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.pushState({}, '', newUrl);
    }

    // Load alert counts
    async function loadAlertCounts() {
        try {
            const response = await fetch('/api/alerts/counts');
            if (response.ok) {
                const counts = await response.json();
                updateAlertCountElements(counts);
            } else {
                console.error('Failed to load alert counts:', response.statusText);
            }
        } catch (error) {
            console.error('Error loading alert counts:', error);
        }
    }

    // Update alert count elements
    function updateAlertCountElements(counts) {
        const elements = {
            'unreadCount': counts.unread,
            'readCount': counts.read,
            'dismissedCount': counts.dismissed,
            'totalCountControl': counts.total
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }
</script>
{% endblock %}
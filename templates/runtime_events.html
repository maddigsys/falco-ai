{% extends "falco_base.html" %}

{% block title %}Runtime Events{% endblock %}
{% block page_icon %}<i class="fas fa-bolt"></i>{% endblock %}
{% block page_title %}Runtime Events{% endblock %}
{% block page_description %}Real-time security events with detailed analysis and AI-powered insights{% endblock %}

{% block extra_css %}
<!-- Add Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    /* Enhanced Runtime Events Layout */
    .events-container {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-xl);
        height: calc(100vh - 140px);
        transition: all 0.3s ease;
    }

    .events-container.with-sidebar {
        grid-template-columns: 2fr 3fr;
    }

    .events-main {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .events-sidebar {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--accent);
        box-shadow: var(--shadow-lg);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease;
        min-width: 400px;
        max-width: none;
    }

    .events-sidebar.active {
        display: flex;
    }
    
    .detail-header {
        padding: var(--space-md);
        border-bottom: 2px solid var(--border-light);
        background: var(--bg-cards);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .detail-title {
        margin: 0;
        color: var(--text-heading);
        font-size: var(--text-base);
        font-weight: 600;
    }
    
    .detail-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-lg);
        cursor: pointer;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }
    
    .detail-close:hover {
        background: var(--bg-secondary);
        color: var(--text-heading);
    }
    
    .detail-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        background: var(--bg-cards);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    /* Alert Filters */
    .filters-card {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        padding: 0;
        margin-bottom: var(--space-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--primary);
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        flex-shrink: 0;
        overflow: hidden;
    }

    .filters-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-md) var(--space-lg);
        background: var(--bg-cards);
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filters-header:hover {
        background: var(--bg-secondary);
    }

    .filters-title {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .filters-title i {
        color: var(--primary);
    }

    .filters-toggle {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-base);
        cursor: pointer;
        transition: all 0.2s ease;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
    }

    .filters-toggle:hover {
        color: var(--primary);
        background: var(--bg-secondary);
    }

    .filters-toggle i {
        transition: transform 0.3s ease;
    }

    .filters-toggle.collapsed i {
        transform: rotate(-90deg);
    }

    .filters-content {
        padding: var(--space-lg);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        transition: all 0.3s ease;
        max-height: 1000px;
        overflow: hidden;
    }

    .filters-content.collapsed {
        max-height: 0;
        padding: 0 var(--space-lg);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .filter-label {
        font-weight: 600;
        color: var(--text-heading);
        font-size: var(--text-sm);
    }

    .filter-select {
        padding: var(--space-sm);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        background: var(--bg-cards);
        color: var(--text-heading);
        font-size: var(--text-sm);
        transition: all 0.2s ease;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .filter-actions {
        grid-column: 1 / -1;
        display: flex;
        gap: var(--space-sm);
        margin-top: var(--space-md);
    }

    .btn-filter {
        background: var(--primary-gradient);
        color: var(--text-inverse);
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .btn-filter:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-clear {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid var(--border-light);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .btn-clear:hover {
        color: var(--primary);
        border-color: var(--primary);
    }

    /* Quick Stats */
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        flex-shrink: 0;
    }

    .stat-item {
        background: var(--bg-cards);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        border: 2px solid var(--border-light);
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .stat-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        background: rgba(0, 174, 199, 0.05);
    }
    
    .stat-item:active {
        transform: translateY(0);
        box-shadow: var(--shadow-md);
    }
    
    .stat-item.active {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-md);
    }
    
    .stat-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
    }

    .stat-item:hover {
        border-color: var(--primary);
        transform: translateY(-1px);
    }

    .stat-number {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--text-heading);
        margin-bottom: var(--space-xs);
        transition: all 0.2s ease;
    }

    .stat-label {
        font-size: var(--text-xs);
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .stat-item.critical .stat-number { color: #ef4444; }
    .stat-item.warning .stat-number { color: #f59e0b; }
    .stat-item.success .stat-number { color: #10b981; }
    
    .stat-item:hover .stat-number {
        color: var(--primary);
        transform: scale(1.05);
    }
    
    .stat-item:hover .stat-label {
        color: var(--text-heading);
    }
    
    .stat-item.active .stat-number {
        color: var(--primary);
    }
    
    .stat-item.active .stat-label {
        color: var(--primary);
        font-weight: 600;
    }

    /* Alerts List */
    .alerts-container {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--accent);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .alerts-header {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-cards);
        flex-shrink: 0;
    }

    .alerts-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .alerts-title i {
        color: var(--accent);
    }

    .alerts-count {
        background: var(--primary);
        color: var(--text-inverse);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: 600;
    }

    .alerts-controls {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }

    .pagination-info {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-right: var(--space-md);
    }

    .alerts-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        min-height: 0;
    }

    .alert-item {
        background: var(--bg-secondary);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-bottom: var(--space-sm);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        width: 100%;
        box-sizing: border-box;
    }

    .alert-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
        background: rgba(0, 174, 199, 0.05);
        transform: translateX(2px);
    }

    .alert-item:last-child {
        margin-bottom: 0;
    }

    .alert-item.selected {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-md);
    }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-xs);
    }

    .alert-rule {
        font-weight: 600;
        color: var(--text-heading);
        flex: 1;
        font-size: var(--text-sm);
        line-height: 1.4;
    }

    .alert-priority {
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        margin-left: var(--space-sm);
        flex-shrink: 0;
    }

    .priority-critical { background: #dc2626; color: white; }
    .priority-error { background: #ea580c; color: white; }
    .priority-warning { background: #d97706; color: white; }
    .priority-notice { background: #2563eb; color: white; }
    .priority-info { background: #6b7280; color: white; }

    .alert-output {
        color: var(--text-secondary);
        font-size: var(--text-xs);
        margin-bottom: var(--space-xs);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .alert-metadata {
        display: flex;
        gap: var(--space-md);
        font-size: var(--text-xs);
        color: var(--text-muted);
        flex-wrap: wrap;
    }

    .alert-metadata span {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    /* Sidebar Detail View */
    .detail-header {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-cards);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .detail-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .detail-close {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-lg);
        cursor: pointer;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .detail-close:hover {
        background: var(--bg-secondary);
        color: var(--text-heading);
    }

    .detail-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        height: 0; /* Allow flex to work properly */
    }

    .detail-section {
        margin-bottom: var(--space-md);
    }

    .detail-section h4 {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-heading);
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .detail-content {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        border: 1px solid var(--border-light);
    }

    .detail-meta {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--space-sm) var(--space-md);
        font-size: var(--text-sm);
    }

    .detail-meta .label {
        font-weight: 600;
        color: var(--text-secondary);
    }

    .detail-meta .value {
        color: var(--text-heading);
        word-break: break-all;
    }

    .ai-chat-section {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 2px solid var(--border-light);
        margin-top: var(--space-md);
        overflow: hidden;
    }

    .chat-header {
        padding: var(--space-md);
        background: var(--bg-cards);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-weight: 600;
        color: var(--text-heading);
        font-size: var(--text-sm);
    }

    .chat-messages {
        max-height: 400px;
        overflow-y: auto;
        padding: var(--space-md);
        min-height: 200px;
    }

    .chat-message {
        margin-bottom: var(--space-md);
        font-size: var(--text-sm);
    }

    .chat-message.user {
        text-align: right;
    }

    .chat-message.assistant {
        text-align: left;
    }

    .chat-message.user::before {
        content: "👤";
        display: inline-block;
        margin-right: var(--space-xs);
        font-size: var(--text-sm);
        opacity: 0.7;
    }

    .chat-message.assistant::before {
        content: "🤖";
        display: inline-block;
        margin-right: var(--space-xs);
        font-size: var(--text-sm);
        opacity: 0.7;
    }

    .chat-message .content {
        display: inline-block;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        max-width: 80%;
        word-wrap: break-word;
        transition: all 0.2s ease;
    }

    .chat-message.user .content:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 180, 166, 0.3);
    }

    .chat-message.assistant .content:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .chat-message.user .content {
        background: var(--falco-primary, #00B4A6);
        color: white;
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 4px rgba(0, 180, 166, 0.2);
    }

    .chat-message.assistant .content {
        background: var(--bg-cards);
        border: 1px solid var(--border-light);
        color: var(--text-heading);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Markdown formatting styles for chat messages */
    .chat-message .content h1,
    .chat-message .content h2,
    .chat-message .content h3,
    .chat-message .content h4,
    .chat-message .content h5,
    .chat-message .content h6 {
        margin: var(--space-sm) 0 var(--space-xs) 0;
        color: var(--text-heading);
        font-weight: 600;
    }

    .chat-message .content h1 { font-size: 1.2em; }
    .chat-message .content h2 { font-size: 1.1em; }
    .chat-message .content h3 { font-size: 1.0em; }

    .chat-message .content ul,
    .chat-message .content ol {
        margin: var(--space-xs) 0;
        padding-left: var(--space-lg);
    }

    .chat-message .content li {
        margin: var(--space-xs) 0;
    }

    .chat-message .content code {
        background: var(--bg-secondary);
        padding: 1px 4px;
        border-radius: var(--radius-sm);
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: var(--primary);
    }

    .chat-message .content pre {
        background: var(--bg-secondary);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        overflow-x: auto;
        margin: var(--space-xs) 0;
        border: 1px solid var(--border-light);
    }

    .chat-message .content pre code {
        background: none;
        padding: 0;
        color: var(--text-heading);
    }

    .chat-message .content blockquote {
        border-left: 3px solid var(--primary);
        padding-left: var(--space-sm);
        margin: var(--space-xs) 0;
        color: var(--text-secondary);
        font-style: italic;
    }

    .chat-message .content strong {
        font-weight: 600;
        color: var(--text-heading);
    }

    .chat-message .content em {
        font-style: italic;
    }

    /* AI Analysis content styling */
    .ai-analysis-content h1,
    .ai-analysis-content h2,
    .ai-analysis-content h3,
    .ai-analysis-content h4,
    .ai-analysis-content h5,
    .ai-analysis-content h6 {
        margin: var(--space-sm) 0 var(--space-xs) 0;
        color: var(--text-heading);
        font-weight: 600;
    }

    .ai-analysis-content h1 { font-size: 1.1em; }
    .ai-analysis-content h2 { font-size: 1.0em; }
    .ai-analysis-content h3 { font-size: 0.95em; }

    .ai-analysis-content ul,
    .ai-analysis-content ol {
        margin: var(--space-xs) 0;
        padding-left: var(--space-lg);
    }

    .ai-analysis-content li {
        margin: var(--space-xs) 0;
    }

    .ai-analysis-content code {
        background: var(--bg-secondary);
        padding: 1px 4px;
        border-radius: var(--radius-sm);
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: var(--primary);
    }

    .ai-analysis-content pre {
        background: var(--bg-secondary);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        overflow-x: auto;
        margin: var(--space-xs) 0;
        border: 1px solid var(--border-light);
    }

    .ai-analysis-content pre code {
        background: none;
        padding: 0;
        color: var(--text-heading);
    }

    .ai-analysis-content blockquote {
        border-left: 3px solid var(--primary);
        padding-left: var(--space-sm);
        margin: var(--space-xs) 0;
        color: var(--text-secondary);
        font-style: italic;
    }

    .ai-analysis-content strong {
        font-weight: 600;
        color: var(--text-heading);
    }

    .ai-analysis-content em {
        font-style: italic;
    }

    .ai-provider-info {
        background: var(--bg-secondary);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-md);
        border-left: 3px solid var(--primary);
        font-size: var(--text-xs);
        color: var(--text-secondary);
    }

    .ai-analysis-empty,
    .ai-analysis-error {
        padding: var(--space-md);
        text-align: center;
        color: var(--text-secondary);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--border-light);
    }

    .ai-analysis-error {
        color: var(--danger);
        border-color: var(--danger);
    }

    .chat-input-area {
        padding: var(--space-md);
        border-top: 1px solid var(--border-light);
        background: var(--bg-cards);
    }

    .chat-input-container {
        display: flex;
        gap: var(--space-sm);
    }

    .chat-input {
        flex: 1;
        padding: var(--space-sm);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background: var(--bg-cards);
        color: var(--text-heading);
        resize: none;
        min-height: 36px;
        max-height: 100px;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .chat-send {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--text-sm);
        transition: all 0.2s ease;
    }

    .chat-send:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .chat-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Pagination */
    .pagination {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }

    .pagination button {
        background: var(--bg-cards);
        border: 2px solid var(--border-light);
        color: var(--text-secondary);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: var(--text-sm);
        transition: all 0.2s ease;
    }

    .pagination button:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Loading & Empty States */
    .loading, .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
        text-align: center;
    }

    .loading i, .empty-state i {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-md);
        color: var(--text-muted);
    }

    .loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .empty-state h3 {
        color: var(--text-heading);
        margin-bottom: var(--space-sm);
    }

    /* Large screen optimization */
    @media (min-width: 1600px) {
        .events-container.with-sidebar {
            grid-template-columns: 1fr 2fr;
        }
        
        .chat-messages {
            max-height: 500px;
        }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .events-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .events-container.with-sidebar {
            grid-template-columns: 1fr 2fr;
        }
        
        .events-sidebar {
            order: -1;
            max-height: 500px;
        }

        .filters-content {
            grid-template-columns: 1fr;
        }

        .stats-summary {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .events-container {
            margin: 0;
            gap: var(--space-md);
        }
        
        .events-container.with-sidebar {
            grid-template-columns: 1fr;
        }
        
        .events-sidebar {
            order: -1;
            max-height: 60vh;
        }

        .stats-summary {
            grid-template-columns: 1fr;
        }

        .alerts-header {
            flex-direction: column;
            gap: var(--space-sm);
            align-items: stretch;
        }

        .alerts-controls {
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="events-container">
    <!-- Main Events Area -->
    <div class="events-main">
        <!-- Alert Filters -->
        <div class="filters-card">
            <div class="filters-header" onclick="toggleFilters()">
                <h2 class="filters-title">
                    <i class="fas fa-filter"></i>
                    Filters & Controls
                </h2>
                <button class="filters-toggle" id="filtersToggle">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            
            <div class="filters-content" id="filtersContent">
                <div class="filter-group">
                    <label class="filter-label">Time Range</label>
                    <select id="timeRange" class="filter-select">
                        <option value="1h">Last Hour</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Priority</label>
                    <select id="priorityFilter" class="filter-select">
                        <option value="all">All Priorities</option>
                        <option value="critical">Critical</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="notice">Notice</option>
                        <option value="informational">Informational</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="all">All Status</option>
                        <option value="unread">Unread</option>
                        <option value="read">Read</option>
                        <option value="dismissed">Dismissed</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Per Page</label>
                    <select id="limitFilter" class="filter-select">
                        <option value="25">25 events</option>
                        <option value="50">50 events</option>
                        <option value="100" selected>100 events</option>
                        <option value="200">200 events</option>
                    </select>
                </div>
                
                <div class="filter-actions">
                    <button class="btn-filter" onclick="applyFilters()">
                        <i class="fas fa-filter"></i>
                        Apply
                    </button>
                    <button class="btn-clear" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-summary">
            <div class="stat-item" onclick="applyStatFilter('all')" data-filter="all" title="Show all events">
                <div class="stat-number" id="totalAlerts">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-item critical" onclick="applyStatFilter('critical')" data-filter="critical" title="Filter to critical priority events">
                <div class="stat-number" id="criticalAlerts">-</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat-item warning" onclick="applyStatFilter('unread')" data-filter="unread" title="Filter to unread events">
                <div class="stat-number" id="unreadAlerts">-</div>
                <div class="stat-label">Unread</div>
            </div>
            <div class="stat-item success" onclick="applyStatFilter('recent')" data-filter="recent" title="Filter to events from last hour">
                <div class="stat-number" id="recentAlerts">-</div>
                <div class="stat-label">Last Hour</div>
            </div>
        </div>

        <!-- Alerts List -->
        <div class="alerts-container">
            <div class="alerts-header">
                <div class="alerts-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Security Events
                    <span class="alerts-count" id="alertsCount">0</span>
                </div>
                <div class="alerts-controls">
                    <span class="pagination-info" id="paginationInfo">Loading...</span>
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="alerts-body">
                <div id="alertsList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading security events...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar - Alert Detail & AI Chat -->
    <div class="events-sidebar">
        <div class="detail-header">
            <h3 class="detail-title">
                <i class="fas fa-info-circle"></i>
                <span id="detailTitle">Select an event for details</span>
            </h3>
            <button class="detail-close" onclick="hideSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-body" id="detailContent">
            <div class="empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <h4>No Event Selected</h4>
                <p>Click on any security event to view detailed information and chat with AI about it.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let alerts = [];
    let filteredAlerts = [];
    let currentPage = 1;
    let itemsPerPage = 100;
    let totalPages = 1;
    let selectedAlert = null;
    let chatMessages = [];
    let currentFilters = {
        timeRange: '24h',
        priority: 'all',
        status: 'all',
        limit: '100',
        rule: null,
        source: null
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize filters as collapsed
        const filtersContent = document.getElementById('filtersContent');
        const filtersToggle = document.getElementById('filtersToggle');
        filtersContent.classList.add('collapsed');
        filtersToggle.classList.add('collapsed');
        
        // Read URL parameters and set filters
        initializeFiltersFromURL();
        
        loadAlerts();
        setInterval(loadAlerts, 30000); // Refresh every 30 seconds
    });

    // Initialize filters from URL parameters
    function initializeFiltersFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Set time range filter
        const timeRange = urlParams.get('time_range');
        if (timeRange) {
            const timeRangeSelect = document.getElementById('timeRange');
            if (timeRangeSelect) {
                timeRangeSelect.value = timeRange;
                currentFilters.timeRange = timeRange;
            }
        }
        
        // Set priority filter
        const priority = urlParams.get('priority');
        if (priority) {
            const prioritySelect = document.getElementById('priorityFilter');
            if (prioritySelect) {
                prioritySelect.value = priority;
                currentFilters.priority = priority;
            }
        }
        
        // Set status filter
        const status = urlParams.get('status');
        if (status) {
            const statusSelect = document.getElementById('statusFilter');
            if (statusSelect) {
                statusSelect.value = status;
                currentFilters.status = status;
            }
        }
        
        // Set limit filter
        const limit = urlParams.get('limit');
        if (limit) {
            const limitSelect = document.getElementById('limitFilter');
            if (limitSelect) {
                limitSelect.value = limit;
                currentFilters.limit = limit;
                itemsPerPage = parseInt(limit);
            }
        }
        
        // Set rule filter (this will be applied during filtering since there's no select for it)
        const rule = urlParams.get('rule');
        if (rule) {
            currentFilters.rule = rule;
        }
        
        // Set source filter (this will be applied during filtering since there's no select for it)
        const source = urlParams.get('source');
        if (source) {
            currentFilters.source = source;
        }
        
        // Update page title if filters are applied
        updatePageTitle();
        
        // Show filters panel if any URL parameters are set
        if (timeRange || priority || status || limit || rule || source) {
            const filtersContent = document.getElementById('filtersContent');
            const filtersToggle = document.getElementById('filtersToggle');
            if (filtersContent && filtersToggle) {
                filtersContent.classList.remove('collapsed');
                filtersToggle.classList.remove('collapsed');
            }
            
            // Show a notification about applied filters
            showFilterNotification();
        }
    }

    // Update page title based on active filters
    function updatePageTitle() {
        let title = 'Runtime Events';
        const activeFilters = [];
        
        if (currentFilters.priority && currentFilters.priority !== 'all') {
            activeFilters.push(`${currentFilters.priority} priority`);
        }
        if (currentFilters.rule) {
            activeFilters.push(`rule: ${currentFilters.rule}`);
        }
        if (currentFilters.status && currentFilters.status !== 'all') {
            activeFilters.push(`${currentFilters.status} status`);
        }
        if (currentFilters.timeRange && currentFilters.timeRange !== '24h') {
            activeFilters.push(`${currentFilters.timeRange} timeframe`);
        }
        if (currentFilters.source) {
            activeFilters.push(`source: ${currentFilters.source}`);
        }
        
        if (activeFilters.length > 0) {
            title += ` - ${activeFilters.join(', ')}`;
        }
        
        document.title = title;
        
        // Update the page description to show active filters
        const pageDescription = document.querySelector('.page-description');
        if (pageDescription && activeFilters.length > 0) {
            pageDescription.textContent = `Filtered by: ${activeFilters.join(', ')}`;
        }
    }

    // Show notification about applied filters from URL
    function showFilterNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            z-index: 9999;
            font-size: var(--text-sm);
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            max-width: 300px;
        `;
        
        const filterCount = Object.keys(currentFilters).filter(key => 
            currentFilters[key] && currentFilters[key] !== 'all' && currentFilters[key] !== '24h'
        ).length;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <i class="fas fa-filter"></i>
                <span>Filters applied from analytics (${filterCount})</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    // Toggle filters visibility
    function toggleFilters() {
        const filtersContent = document.getElementById('filtersContent');
        const filtersToggle = document.getElementById('filtersToggle');
        
        if (filtersContent.classList.contains('collapsed')) {
            filtersContent.classList.remove('collapsed');
            filtersToggle.classList.remove('collapsed');
        } else {
            filtersContent.classList.add('collapsed');
            filtersToggle.classList.add('collapsed');
        }
    }

    // Load alerts from API
    async function loadAlerts() {
        try {
            const response = await fetch('/api/alerts?limit=1000'); // Load more for better volume
            if (response.ok) {
                alerts = await response.json();
                applyFilters();
                updateStats();
            } else {
                console.error('Failed to load alerts:', response.statusText);
                showError('Failed to load alerts');
            }
        } catch (error) {
            console.error('Error loading alerts:', error);
            showError('Error loading alerts: ' + error.message);
        }
    }

    // Apply current filters
    function applyFilters() {
        // Get current filter values
        currentFilters.timeRange = document.getElementById('timeRange').value;
        currentFilters.priority = document.getElementById('priorityFilter').value;
        currentFilters.status = document.getElementById('statusFilter').value;
        currentFilters.limit = document.getElementById('limitFilter').value;
        
        itemsPerPage = parseInt(currentFilters.limit);

        filteredAlerts = alerts.filter(alert => {
            // Time range filter
            if (currentFilters.timeRange !== 'all') {
                const alertTime = new Date(alert.timestamp || alert.time);
                const now = new Date();
                const diffHours = (now - alertTime) / (1000 * 60 * 60);
                
                switch (currentFilters.timeRange) {
                    case '1h': if (diffHours > 1) return false; break;
                    case '24h': if (diffHours > 24) return false; break;
                    case '7d': if (diffHours > 24 * 7) return false; break;
                    case '30d': if (diffHours > 24 * 30) return false; break;
                }
            }

            // Priority filter
            if (currentFilters.priority !== 'all' && alert.priority !== currentFilters.priority) {
                return false;
            }

            // Status filter  
            if (currentFilters.status !== 'all' && alert.status !== currentFilters.status) {
                return false;
            }

            // Rule filter (from URL parameter)
            if (currentFilters.rule && alert.rule && !alert.rule.toLowerCase().includes(currentFilters.rule.toLowerCase())) {
                return false;
            }

            // Source filter (from URL parameter)
            if (currentFilters.source && alert.source && !alert.source.toLowerCase().includes(currentFilters.source.toLowerCase())) {
                return false;
            }

            return true;
        });

        // Sort by timestamp (newest first)
        filteredAlerts.sort((a, b) => {
            const timeA = new Date(a.timestamp || a.time);
            const timeB = new Date(b.timestamp || b.time);
            return timeB - timeA;
        });

        // Reset pagination
        currentPage = 1;
        totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);
        
        displayAlerts();
        updatePagination();
        updateStats();
        updateStatCards();
    }

    // Display alerts for current page
    function displayAlerts() {
        const container = document.getElementById('alertsList');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageAlerts = filteredAlerts.slice(startIndex, endIndex);
        
        if (pageAlerts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shield-alt"></i>
                    <h3>No Security Events</h3>
                    <p>No alerts match your current filters.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = pageAlerts.map((alert, index) => {
            const actualIndex = startIndex + index;
            
            return `
                <div class="alert-item" onclick="selectAlert(${actualIndex})" id="alert-${actualIndex}">
                    <div class="alert-header">
                        <div class="alert-rule">${alert.rule || 'Unknown Rule'}</div>
                        <div class="alert-priority priority-${alert.priority || 'info'}">${alert.priority || 'info'}</div>
                    </div>
                    <div class="alert-output">${alert.output || 'No output available'}</div>
                    <div class="alert-metadata">
                        <span><i class="fas fa-clock"></i> ${formatTime(alert.timestamp || alert.time)}</span>
                        <span><i class="fas fa-server"></i> ${alert.source || 'Unknown'}</span>
                        <span><i class="fas fa-tag"></i> ${alert.status || 'unread'}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('alertsCount').textContent = filteredAlerts.length;
    }

    // Test function to ensure sidebar works
    function testSidebar() {
        const mockAlert = {
            id: 'test-123',
            rule: 'Test Security Rule',
            priority: 'critical',
            output: 'This is a test security event to verify the sidebar functionality.',
            timestamp: new Date().toISOString(),
            source: 'test-source',
            status: 'unread'
        };
        
        selectedAlert = mockAlert;
        
        // Show sidebar using the same method as selectAlert
        const container = document.querySelector('.events-container');
        const sidebar = document.querySelector('.events-sidebar');
        
        if (container && sidebar) {
            container.classList.add('with-sidebar');
            sidebar.classList.add('active');
        }
        
        showAlertDetails(mockAlert);
        
        // Clear chat
        chatMessages = [];
        renderChatMessages();
    }

    // Select alert and show details
    function selectAlert(actualIndex) {
        // Calculate the correct index within the current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const relativeIndex = actualIndex - startIndex;
        const pageAlerts = filteredAlerts.slice(startIndex, startIndex + itemsPerPage);
        
        // Remove previous selection
        document.querySelectorAll('.alert-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Add selection to clicked item
        const alertElement = document.getElementById(`alert-${actualIndex}`);
        if (alertElement) {
            alertElement.classList.add('selected');
        }
        
        selectedAlert = pageAlerts[relativeIndex];
        
        if (!selectedAlert) {
            console.error('No alert found at index:', relativeIndex);
            return;
        }
        
        // Show sidebar and update container layout
        const container = document.querySelector('.events-container');
        const sidebar = document.querySelector('.events-sidebar');
        
        if (container && sidebar) {
            container.classList.add('with-sidebar');
            sidebar.classList.add('active');
        }
        
        showAlertDetails(selectedAlert);
        
        // Load chat history for this alert or start fresh
        loadChatHistoryForAlert(selectedAlert.id);
    }

    // Show alert details in sidebar
    function showAlertDetails(alert) {
        console.log('Showing alert details for:', alert);
        
        const detailTitle = document.getElementById('detailTitle');
        const detailContent = document.getElementById('detailContent');
        
        if (!detailTitle || !detailContent) {
            console.error('Detail elements not found');
            return;
        }
        
        detailTitle.textContent = `${alert.rule}`;
        
        detailContent.innerHTML = `
            <div class="detail-section">
                <h4><i class="fas fa-exclamation-triangle"></i> Alert Information</h4>
                <div class="detail-content">
                    <div class="detail-meta">
                        <span class="label">Rule:</span>
                        <span class="value">${alert.rule || 'Unknown'}</span>
                        
                        <span class="label">Priority:</span>
                        <span class="value">
                            <span class="alert-priority priority-${alert.priority || 'info'}">${alert.priority || 'info'}</span>
                        </span>
                        
                        <span class="label">Timestamp:</span>
                        <span class="value">${formatTime(alert.timestamp || alert.time)}</span>
                        
                        <span class="label">Source:</span>
                        <span class="value">${alert.source || 'Unknown'}</span>
                        
                        <span class="label">Status:</span>
                        <span class="value">${alert.status || 'unread'}</span>
                        
                        <span class="label">ID:</span>
                        <span class="value">${alert.id || 'Unknown'}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4><i class="fas fa-file-alt"></i> Alert Output</h4>
                <div class="detail-content">
                    <pre style="white-space: pre-wrap; font-size: var(--text-sm); line-height: 1.4; color: var(--text-heading);">${alert.output || 'No output available'}</pre>
                </div>
            </div>

            ${alert.fields ? `
            <div class="detail-section">
                <h4><i class="fas fa-code"></i> Additional Fields</h4>
                <div class="detail-content">
                    <pre style="white-space: pre-wrap; font-size: var(--text-xs); color: var(--text-secondary);">${JSON.stringify(typeof alert.fields === 'string' ? JSON.parse(alert.fields) : alert.fields || {}, null, 2)}</pre>
                </div>
            </div>
            ` : ''}

            ${alert.ai_analysis ? `
            <div class="detail-section">
                <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                <div class="detail-content">
                    <div class="ai-analysis-content" style="font-size: var(--text-sm); color: var(--text-heading); line-height: 1.5;">${formatAIAnalysis(alert.ai_analysis)}</div>
                    ${hasEmptyAIContent(alert.ai_analysis) ? `
                    <div class="ai-regenerate-section" style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px dashed var(--border-light);">
                        <p style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xs); color: var(--text-secondary);">
                            <i class="fas fa-info-circle"></i> AI analysis was generated but appears to be incomplete.
                        </p>
                        <button onclick="regenerateAIAnalysis(${alert.id})" class="btn btn-sm" style="background: var(--falco-primary); color: #fff; border: none; border-radius: var(--radius-md); padding: 0.5em 1.2em; font-weight: 500; box-shadow: var(--shadow-sm); transition: background 0.2s;">
                            <i class="fas fa-sync-alt"></i> Regenerate Analysis
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : `
            <div class="detail-section">
                <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                <div class="detail-content">
                    <div class="ai-analysis-empty">
                        <em>No AI analysis available for this alert.</em>
                        <div style="margin-top: var(--space-sm);">
                            <button onclick="regenerateAIAnalysis(${alert.id})" class="btn btn-sm" style="background: var(--falco-primary); color: #fff; border: none; border-radius: var(--radius-md); padding: 0.5em 1.2em; font-weight: 500; box-shadow: var(--shadow-sm); transition: background 0.2s;">
                                <i class="fas fa-magic"></i> Generate AI Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `}

            <!-- AI Chat Section -->
            <div class="ai-chat-section">
                <div class="chat-header">
                    <i class="fas fa-robot"></i>
                    Chat with AI about this alert
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message assistant">
                        <div class="content">
                            Hi! I can help you analyze this security alert. Ask me anything about it - what it means, potential risks, recommended actions, or how it relates to other security events.
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Ask about this alert..."
                            onkeydown="handleChatKeyDown(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button class="chat-send" onclick="sendChatMessage()" id="chatSendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        console.log('Alert details populated');
    }

    // Handle chat input
    function handleChatKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    }

    // Auto-resize textarea
    function adjustTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    // Send chat message
    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        const sendBtn = document.getElementById('chatSendBtn');
        
        if (!message || !selectedAlert) return;
        
        // Add user message to chat
        chatMessages.push({ role: 'user', content: message });
        renderChatMessages();
        // Save chat history for this alert
        if (selectedAlert && selectedAlert.id) {
            saveChatHistoryForAlert(selectedAlert.id);
        }
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        
        // Disable send button
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            const response = await fetch('/api/enhanced-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    context: {
                        alert: selectedAlert,
                        previous_messages: chatMessages.slice(-10) // Last 10 messages for context
                    },
                    persona: 'security_analyst',
                    language: 'en'
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    chatMessages.push({ role: 'assistant', content: data.response });
                    renderChatMessages();
                    // Save chat history for this alert
                    if (selectedAlert && selectedAlert.id) {
                        saveChatHistoryForAlert(selectedAlert.id);
                    }
                } else {
                    throw new Error(data.error || 'Chat failed');
                }
            } else {
                throw new Error('Chat service unavailable');
            }
        } catch (error) {
            console.error('Chat error:', error);
            chatMessages.push({ 
                role: 'assistant', 
                content: '❌ Sorry, I encountered an error. Please try again.' 
            });
            renderChatMessages();
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }

    // Render chat messages
    function renderChatMessages() {
        const container = document.getElementById('chatMessages');
        if (!container) return;
        
        container.innerHTML = chatMessages.map(msg => {
            // Parse markdown for assistant messages, escape HTML for user messages
            const formattedContent = msg.role === 'assistant' ? 
                marked.parse(msg.content) : 
                escapeHtml(msg.content);
            
            return `
                <div class="chat-message ${msg.role}">
                    <div class="content">${formattedContent}</div>
                </div>
            `;
        }).join('');
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    // Update pagination
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        const info = document.getElementById('paginationInfo');
        
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, filteredAlerts.length);
        
        info.textContent = `${startItem}-${endItem} of ${filteredAlerts.length}`;
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>`;
        
        // Page numbers (show 5 pages max)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        startPage = Math.max(1, endPage - 4);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
        }
        
        // Next button
        paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>`;
        
        pagination.innerHTML = paginationHTML;
    }

    // Change page
    function changePage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        displayAlerts();
        updatePagination();
        
        // Clear selection and hide sidebar when changing pages
        selectedAlert = null;
        hideSidebar();
        
        // Remove selection from all items
        document.querySelectorAll('.alert-item').forEach(item => {
            item.classList.remove('selected');
        });
    }

    // Update statistics
    function updateStats() {
        document.getElementById('totalAlerts').textContent = alerts.length;
        document.getElementById('criticalAlerts').textContent = 
            alerts.filter(a => a.priority === 'critical').length;
        document.getElementById('unreadAlerts').textContent = 
            alerts.filter(a => (a.status || 'unread') === 'unread').length;
        
        // Recent alerts (last hour)
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        document.getElementById('recentAlerts').textContent = 
            alerts.filter(a => new Date(a.timestamp || a.time) > oneHourAgo).length;
    }

    // Apply filter from stat card click
    function applyStatFilter(filterType) {
        // Remove active class from all stat items
        document.querySelectorAll('.stat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to clicked item
        const clickedItem = document.querySelector(`[data-filter="${filterType}"]`);
        if (clickedItem) {
            clickedItem.classList.add('active');
        }
        
        // Apply the appropriate filter
        switch (filterType) {
            case 'all':
                // Clear all filters
                document.getElementById('timeRange').value = '24h';
                document.getElementById('priorityFilter').value = 'all';
                document.getElementById('statusFilter').value = 'all';
                break;
            case 'critical':
                // Filter to critical priority
                document.getElementById('priorityFilter').value = 'critical';
                break;
            case 'unread':
                // Filter to unread status
                document.getElementById('statusFilter').value = 'unread';
                break;
            case 'recent':
                // Filter to last hour
                document.getElementById('timeRange').value = '1h';
                break;
        }
        
        // Apply the filters
        applyFilters();
        
        // Show visual feedback
        showFilterFeedback(filterType);
    }
    
    // Show feedback for applied filter
    function showFilterFeedback(filterType) {
        const messages = {
            'all': 'Showing all events',
            'critical': 'Filtered to critical priority events',
            'unread': 'Filtered to unread events',
            'recent': 'Filtered to events from last hour',
            'ai_regenerated': 'AI analysis regenerated successfully'
        };
        
        const message = messages[filterType] || 'Filter applied';
        
        // Create temporary feedback element
        const feedback = document.createElement('div');
        feedback.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            z-index: 9999;
            font-size: var(--text-sm);
            animation: slideInRight 0.3s ease;
        `;
        feedback.textContent = message;
        document.body.appendChild(feedback);
        
        // Remove after 2 seconds
        setTimeout(() => {
            feedback.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 300);
        }, 2000);
    }

    // Clear all filters
    function clearFilters() {
        // Remove active class from all stat items
        document.querySelectorAll('.stat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        document.getElementById('timeRange').value = '24h';
        document.getElementById('priorityFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('limitFilter').value = '100';
        applyFilters();
        
        showFilterFeedback('all');
    }

    // Update stat card active states based on current filters
    function updateStatCards() {
        // Remove active class from all stat items
        document.querySelectorAll('.stat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Determine which filter is active
        const timeRange = document.getElementById('timeRange').value;
        const priority = document.getElementById('priorityFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        // Set active state based on current filters
        if (priority === 'critical') {
            document.querySelector('[data-filter="critical"]')?.classList.add('active');
        } else if (status === 'unread') {
            document.querySelector('[data-filter="unread"]')?.classList.add('active');
        } else if (timeRange === '1h') {
            document.querySelector('[data-filter="recent"]')?.classList.add('active');
        } else if (timeRange === '24h' && priority === 'all' && status === 'all') {
            document.querySelector('[data-filter="all"]')?.classList.add('active');
        }
        // If multiple filters are active or it's a custom combination, no stat card is highlighted
    }

    // Load chat history for specific alert
    function loadChatHistoryForAlert(alertId) {
        try {
            const savedHistory = localStorage.getItem(`chat_history_${alertId}`);
            if (savedHistory) {
                chatMessages = JSON.parse(savedHistory);
            } else {
                chatMessages = [
                    { 
                        role: 'assistant', 
                        content: 'Hi! I can help you analyze this security alert. Ask me anything about it - what it means, potential risks, recommended actions, or how it relates to other security events.' 
                    }
                ];
            }
            renderChatMessages();
        } catch (error) {
            console.error('Error loading chat history:', error);
            chatMessages = [
                { 
                    role: 'assistant', 
                    content: 'Hi! I can help you analyze this security alert. Ask me anything about it - what it means, potential risks, recommended actions, or how it relates to other security events.' 
                }
            ];
            renderChatMessages();
        }
    }

    // Save chat history for specific alert
    function saveChatHistoryForAlert(alertId) {
        try {
            localStorage.setItem(`chat_history_${alertId}`, JSON.stringify(chatMessages));
        } catch (error) {
            console.error('Error saving chat history:', error);
        }
    }

    // Check if AI analysis has empty content
    function hasEmptyAIContent(aiAnalysis) {
        try {
            if (!aiAnalysis) return true;
            
            let analysis = aiAnalysis;
            if (typeof aiAnalysis === 'string') {
                try {
                    analysis = JSON.parse(aiAnalysis);
                } catch (e) {
                    return false; // If it's not JSON, assume it has content
                }
            }
            
            // Check if it's the structured format with sections
            if (analysis['Security Impact'] || analysis['Next Steps'] || analysis['Remediation Steps']) {
                const sections = ['Security Impact', 'Next Steps', 'Remediation Steps'];
                return sections.every(section => 
                    !analysis[section] || 
                    !analysis[section].content || 
                    analysis[section].content.trim() === ''
                );
            }
            
            // Check fallback format
            if (analysis.securityImpact || analysis.nextSteps || analysis.remediationSteps) {
                return (!analysis.securityImpact || analysis.securityImpact.trim() === '') &&
                       (!analysis.nextSteps || analysis.nextSteps.trim() === '') &&
                       (!analysis.remediationSteps || analysis.remediationSteps.trim() === '');
            }
            
            return false;
        } catch (error) {
            console.error('Error checking AI content:', error);
            return true;
        }
    }

    // Regenerate AI analysis for a specific alert
    async function regenerateAIAnalysis(alertId) {
        try {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            const response = await fetch(`/api/alerts/${alertId}/reprocess`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    // Refresh the alert details
                    if (selectedAlert && selectedAlert.id === alertId) {
                        selectedAlert.ai_analysis = result.ai_analysis;
                        showAlertDetails(selectedAlert);
                    }
                    
                    // Show success message
                    showFilterFeedback('ai_regenerated');
                } else {
                    throw new Error(result.error || 'Failed to regenerate AI analysis');
                }
            } else {
                throw new Error('Failed to regenerate AI analysis');
            }
        } catch (error) {
            console.error('Error regenerating AI analysis:', error);
            alert('Failed to regenerate AI analysis: ' + error.message);
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // Format AI Analysis with markdown
    function formatAIAnalysis(aiAnalysis) {
        try {
            if (!aiAnalysis) {
                return '<div class="ai-analysis-empty"><em>No AI analysis available for this alert.</em></div>';
            }
            
            // Parse if it's a string
            let analysis = aiAnalysis;
            if (typeof aiAnalysis === 'string') {
                try {
                    analysis = JSON.parse(aiAnalysis);
                } catch (e) {
                    // If it's not JSON, treat as plain text
                    return marked.parse(aiAnalysis);
                }
            }
            
            // Check if it's the structured format with sections
            if (analysis['Security Impact'] || analysis['Next Steps'] || analysis['Remediation Steps']) {
                let formattedAnalysis = '';
                
                // Add provider info if available
                if (analysis.llm_provider) {
                    formattedAnalysis += `<div class="ai-provider-info"><strong>AI Provider:</strong> ${analysis.llm_provider}</div>\n\n`;
                }
                
                // Security Impact
                if (analysis['Security Impact'] && analysis['Security Impact'].content) {
                    formattedAnalysis += `## Security Impact\n\n${analysis['Security Impact'].content}\n\n`;
                }
                
                // Next Steps
                if (analysis['Next Steps'] && analysis['Next Steps'].content) {
                    formattedAnalysis += `## Next Steps\n\n${analysis['Next Steps'].content}\n\n`;
                }
                
                // Remediation Steps
                if (analysis['Remediation Steps'] && analysis['Remediation Steps'].content) {
                    formattedAnalysis += `## Remediation Steps\n\n${analysis['Remediation Steps'].content}\n\n`;
                }
                
                // Suggested Commands
                if (analysis['Suggested Commands'] && analysis['Suggested Commands'].content) {
                    formattedAnalysis += `## Suggested Commands\n\n${analysis['Suggested Commands'].content}\n\n`;
                }
                
                // If no content found, show empty state
                if (!formattedAnalysis.trim()) {
                    return '<div class="ai-analysis-empty"><em>AI analysis is available but has no content.</em></div>';
                }
                
                return marked.parse(formattedAnalysis);
            }
            
            // Fallback for other formats
            if (analysis.securityImpact || analysis.nextSteps || analysis.remediationSteps) {
                let formattedAnalysis = '';
                
                if (analysis.llm_provider) {
                    formattedAnalysis += `<div class="ai-provider-info"><strong>AI Provider:</strong> ${analysis.llm_provider}</div>\n\n`;
                }
                
                if (analysis.securityImpact) {
                    formattedAnalysis += `## Security Impact\n\n${analysis.securityImpact}\n\n`;
                }
                
                if (analysis.nextSteps) {
                    formattedAnalysis += `## Next Steps\n\n${analysis.nextSteps}\n\n`;
                }
                
                if (analysis.remediationSteps) {
                    formattedAnalysis += `## Remediation Steps\n\n${analysis.remediationSteps}\n\n`;
                }
                
                if (analysis.suggestedCommands) {
                    formattedAnalysis += `## Suggested Commands\n\n${analysis.suggestedCommands}\n\n`;
                }
                
                return marked.parse(formattedAnalysis);
            }
            
            // If it's just a string, parse as markdown
            if (typeof analysis === 'string') {
                return marked.parse(analysis);
            }
            
            // Last resort - stringify and escape
            return escapeHtml(JSON.stringify(analysis, null, 2));
            
        } catch (error) {
            console.error('Error formatting AI analysis:', error);
            return '<div class="ai-analysis-error"><em>Error displaying AI analysis.</em></div>';
        }
    }

    // Utility functions
    function formatTime(timestamp) {
        if (!timestamp) return 'Unknown';
        try {
            return new Date(timestamp).toLocaleString();
        } catch {
            return timestamp;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        const container = document.getElementById('alertsList');
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                <h3>Error</h3>
                <p>${message}</p>
            </div>
        `;
    }

    function hideSidebar() {
        const sidebar = document.querySelector('.events-sidebar');
        const container = document.querySelector('.events-container');
        const detailTitle = document.getElementById('detailTitle');
        const detailContent = document.getElementById('detailContent');
        
        // Remove active classes
        sidebar.classList.remove('active');
        container.classList.remove('with-sidebar');
        
        // Remove any forced styling from debugging
        sidebar.style.display = '';
        
        // Reset selected alert
        selectedAlert = null;
        
        // Reset sidebar content to initial clean state
        detailTitle.textContent = 'Select an event for details';
        detailContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <h4>No Event Selected</h4>
                <p>Click on any security event to view detailed information and chat with AI about it.</p>
            </div>
        `;
        
        // Clear chat messages
        chatMessages = [];
        
        // Remove selection from all alert items
        document.querySelectorAll('.alert-item').forEach(item => {
            item.classList.remove('selected');
        });
    }
</script>
{% endblock %} 
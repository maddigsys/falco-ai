{% extends "falco_base.html" %}

{% block title %}Runtime Events{% endblock %}
{% block page_icon %}<i class="fas fa-bolt"></i>{% endblock %}
{% block page_title %}Runtime Events{% endblock %}
{% block page_description %}Real-time security events with detailed analysis and AI-powered insights{% endblock %}

{% block extra_css %}
<!-- Add Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    /* Override falco-main for runtime events page */
    .falco-main {
        flex: 1;
        padding: 0;
        overflow: visible;
        background: transparent;
        background-image: none;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        border: none;
        height: 100%;
        min-height: 0;
    }

    /* Enhanced Runtime Events Layout */
    .events-container {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-xl);
        height: 100%;
        transition: all 0.3s ease;
        /* Use flexbox approach instead of calc */
        flex: 1;
        min-height: 0;
    }

    .events-container.with-sidebar {
        grid-template-columns: 2fr 3fr;
        grid-template-rows: 1fr;
        align-items: stretch;
    }

    .events-main {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
        height: 100%;
        padding-top: var(--space-lg);
    }

    .events-sidebar {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--accent);
        box-shadow: var(--shadow-lg);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease;
        min-width: 400px;
        max-width: none;
        height: 100%;
        min-height: 0;
    }

    .events-sidebar.active {
        display: flex;
    }
    
    .detail-header {
        padding: var(--space-md);
        border-bottom: 2px solid var(--border-light);
        background: var(--bg-cards);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .detail-title {
        margin: 0;
        color: var(--text-heading);
        font-size: var(--text-base);
        font-weight: 600;
    }
    
    .detail-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-lg);
        cursor: pointer;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }
    
    .detail-close:hover {
        background: var(--bg-secondary);
        color: var(--text-heading);
    }
    
    .detail-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        background: var(--bg-cards);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    /* Alert Filters */
    .filters-card {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        padding: 0;
        margin-bottom: var(--space-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--primary);
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        flex-shrink: 0;
        overflow: hidden;
    }

    .filters-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-md) var(--space-lg);
        background: var(--bg-cards);
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filters-header:hover {
        background: var(--bg-secondary);
    }

    .filters-title {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .filters-title i {
        color: var(--primary);
    }

    .filters-toggle {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-base);
        cursor: pointer;
        transition: all 0.2s ease;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
    }

    .filters-toggle:hover {
        color: var(--primary);
        background: var(--bg-secondary);
    }

    .filters-toggle i {
        transition: transform 0.3s ease;
    }

    .filters-toggle.collapsed i {
        transform: rotate(-90deg);
    }

    .filters-content {
        padding: var(--space-lg);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        transition: all 0.3s ease;
        max-height: 1000px;
        overflow: hidden;
    }

    .filters-content.collapsed {
        max-height: 0;
        padding: 0 var(--space-lg);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .filter-label {
        font-weight: 600;
        color: var(--text-heading);
        font-size: var(--text-sm);
    }

    .filter-select {
        padding: var(--space-sm);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        background: var(--bg-cards);
        color: var(--text-heading);
        font-size: var(--text-sm);
        transition: all 0.2s ease;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .filter-actions {
        grid-column: 1 / -1;
        display: flex;
        gap: var(--space-sm);
        margin-top: var(--space-md);
    }

    .btn-filter {
        background: var(--primary-gradient);
        color: var(--text-inverse);
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .btn-filter:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-clear {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid var(--border-light);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .btn-clear:hover {
        color: var(--primary);
        border-color: var(--primary);
    }

    /* Quick Stats */
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        flex-shrink: 0;
    }

    .stat-item {
        background: var(--bg-cards);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        border: 2px solid var(--border-light);
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .stat-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        background: rgba(0, 174, 199, 0.05);
    }
    
    .stat-item:active {
        transform: translateY(0);
        box-shadow: var(--shadow-md);
    }
    
    .stat-item.active {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-md);
    }
    
    .stat-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
    }

    .stat-item:hover {
        border-color: var(--primary);
        transform: translateY(-1px);
    }

    .stat-number {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--text-heading);
        margin-bottom: var(--space-xs);
        transition: all 0.2s ease;
    }

    .stat-label {
        font-size: var(--text-xs);
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .stat-item.critical .stat-number { color: #ef4444; }
    .stat-item.warning .stat-number { color: #f59e0b; }
    .stat-item.success .stat-number { color: #10b981; }
    
    .stat-item:hover .stat-number {
        color: var(--primary);
        transform: scale(1.05);
    }
    
    .stat-item:hover .stat-label {
        color: var(--text-heading);
    }
    
    .stat-item.active .stat-number {
        color: var(--primary);
    }
    
    .stat-item.active .stat-label {
        color: var(--primary);
        font-weight: 600;
    }

    /* Alerts List */
    .alerts-container {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--accent);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
        min-height: 400px;
    }

    .alerts-header {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-cards);
        flex-shrink: 0;
        min-height: 60px;
    }

    .alerts-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .alerts-title i {
        color: var(--accent);
    }

    .alerts-count {
        background: var(--primary);
        color: var(--text-inverse);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: 600;
    }

    .alerts-controls {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        flex-shrink: 0;
        min-width: 0;
    }

    .pagination-info {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-right: var(--space-md);
        flex-shrink: 0;
        white-space: nowrap;
    }

    .alerts-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        min-height: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    #alertsList {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 200px;
        background: var(--bg-cards);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .alert-item {
        background: var(--bg-cards);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-bottom: var(--space-sm);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        width: 100%;
        box-sizing: border-box;
    }

    .alert-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
        background: rgba(0, 174, 199, 0.05);
        transform: translateX(2px);
    }

    .alert-item:last-child {
        margin-bottom: 0;
    }

    .alert-item.selected {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-md);
    }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-xs);
    }

    .alert-rule {
        font-weight: 600;
        color: var(--text-heading);
        flex: 1;
        font-size: var(--text-sm);
        line-height: 1.4;
    }

    .alert-priority {
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        margin-left: var(--space-sm);
        flex-shrink: 0;
    }

    .priority-critical { background: #dc2626; color: white; }
    .priority-error { background: #ea580c; color: white; }
    .priority-warning { background: #d97706; color: white; }
    .priority-notice { background: #2563eb; color: white; }
    .priority-info { background: #6b7280; color: white; }

    .alert-output {
        color: var(--text-secondary);
        font-size: var(--text-xs);
        margin-bottom: var(--space-xs);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .alert-metadata {
        display: flex;
        gap: var(--space-md);
        font-size: var(--text-xs);
        color: var(--text-muted);
        flex-wrap: wrap;
    }

    .alert-metadata span {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    /* Sidebar Detail View */
    .detail-header {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-cards);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .detail-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .detail-close {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-lg);
        cursor: pointer;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .detail-close:hover {
        background: var(--bg-secondary);
        color: var(--text-heading);
    }

    .detail-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        height: 0; /* Allow flex to work properly */
    }

    .detail-section {
        margin-bottom: var(--space-md);
    }

    .detail-section h4 {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-heading);
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .detail-content {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        border: 1px solid var(--border-light);
    }

    .detail-meta {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--space-sm) var(--space-md);
        font-size: var(--text-sm);
    }

    .detail-meta .label {
        font-weight: 600;
        color: var(--text-secondary);
    }

    .detail-meta .value {
        color: var(--text-heading);
        word-break: break-all;
    }

    .ai-chat-section {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 2px solid var(--border-light);
        margin-top: var(--space-md);
        overflow: hidden;
    }

    .chat-header {
        padding: var(--space-md);
        background: var(--bg-cards);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-weight: 600;
        color: var(--text-heading);
        font-size: var(--text-sm);
    }

    .chat-messages {
        max-height: 400px;
        overflow-y: auto;
        padding: var(--space-md);
        min-height: 200px;
    }

    .chat-message {
        margin-bottom: var(--space-md);
        font-size: var(--text-sm);
    }

    .chat-message.user {
        text-align: right;
    }

    .chat-message.assistant {
        text-align: left;
    }

    .chat-message.user::before {
        content: "👤";
        display: inline-block;
        margin-right: var(--space-xs);
        font-size: var(--text-sm);
        opacity: 0.7;
    }

    .chat-message.assistant::before {
        content: "🤖";
        display: inline-block;
        margin-right: var(--space-xs);
        font-size: var(--text-sm);
        opacity: 0.7;
    }

    .chat-message .content {
        display: inline-block;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        max-width: 80%;
        word-wrap: break-word;
        transition: all 0.2s ease;
    }

    .chat-message.user .content:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 180, 166, 0.3);
    }

    .chat-message.assistant .content:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .chat-message.user .content {
        background: var(--falco-primary, #00B4A6);
        color: white;
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 4px rgba(0, 180, 166, 0.2);
    }

    .chat-message.assistant .content {
        background: var(--bg-cards);
        border: 1px solid var(--border-light);
        color: var(--text-heading);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Markdown formatting styles for chat messages */
    .chat-message .content h1,
    .chat-message .content h2,
    .chat-message .content h3,
    .chat-message .content h4,
    .chat-message .content h5,
    .chat-message .content h6 {
        margin: var(--space-sm) 0 var(--space-xs) 0;
        color: var(--text-heading);
        font-weight: 600;
    }

    .chat-message .content h1 { font-size: 1.2em; }
    .chat-message .content h2 { font-size: 1.1em; }
    .chat-message .content h3 { font-size: 1.0em; }

    .chat-message .content ul,
    .chat-message .content ol {
        margin: var(--space-xs) 0;
        padding-left: var(--space-lg);
    }

    .chat-message .content li {
        margin: var(--space-xs) 0;
    }

    .chat-message .content code {
        background: var(--bg-secondary);
        padding: 1px 4px;
        border-radius: var(--radius-sm);
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: var(--primary);
    }

    .chat-message .content pre {
        background: var(--bg-secondary);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        overflow-x: auto;
        margin: var(--space-xs) 0;
        border: 1px solid var(--border-light);
    }

    .chat-message .content pre code {
        background: none;
        padding: 0;
        color: var(--text-heading);
    }

    .chat-message .content blockquote {
        border-left: 3px solid var(--primary);
        padding-left: var(--space-sm);
        margin: var(--space-xs) 0;
        color: var(--text-secondary);
        font-style: italic;
    }

    .chat-message .content strong {
        font-weight: 600;
        color: var(--text-heading);
    }

    .chat-message .content em {
        font-style: italic;
    }

    /* AI Analysis content styling */
    .ai-analysis-content h1,
    .ai-analysis-content h2,
    .ai-analysis-content h3,
    .ai-analysis-content h4,
    .ai-analysis-content h5,
    .ai-analysis-content h6 {
        margin: var(--space-sm) 0 var(--space-xs) 0;
        color: var(--text-heading);
        font-weight: 600;
    }

    .ai-analysis-content h1 { font-size: 1.1em; }
    .ai-analysis-content h2 { font-size: 1.0em; }
    .ai-analysis-content h3 { font-size: 0.95em; }

    .ai-analysis-content ul,
    .ai-analysis-content ol {
        margin: var(--space-xs) 0;
        padding-left: var(--space-lg);
    }

    .ai-analysis-content li {
        margin: var(--space-xs) 0;
    }

    .ai-analysis-content code {
        background: var(--bg-secondary);
        padding: 1px 4px;
        border-radius: var(--radius-sm);
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: var(--primary);
    }

    .ai-analysis-content pre {
        background: var(--bg-secondary);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        overflow-x: auto;
        margin: var(--space-xs) 0;
        border: 1px solid var(--border-light);
    }

    .ai-analysis-content pre code {
        background: none;
        padding: 0;
        color: var(--text-heading);
    }

    .ai-analysis-content blockquote {
        border-left: 3px solid var(--primary);
        padding-left: var(--space-sm);
        margin: var(--space-xs) 0;
        color: var(--text-secondary);
        font-style: italic;
    }

    .ai-analysis-content strong {
        font-weight: 600;
        color: var(--text-heading);
    }

    .ai-analysis-content em {
        font-style: italic;
    }

    .ai-provider-info {
        background: var(--bg-secondary);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-md);
        border-left: 3px solid var(--primary);
        font-size: var(--text-xs);
        color: var(--text-secondary);
    }

    .ai-analysis-empty,
    .ai-analysis-error {
        padding: var(--space-md);
        text-align: center;
        color: var(--text-secondary);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .ai-analysis-error {
        color: var(--danger);
        border-color: var(--danger);
    }

    .chat-input-area {
        padding: var(--space-md);
        border-top: 1px solid var(--border-light);
        background: var(--bg-cards);
    }

    .chat-input-container {
        display: flex;
        gap: var(--space-sm);
    }

    .chat-input {
        flex: 1;
        padding: var(--space-sm);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background: var(--bg-cards);
        color: var(--text-heading);
        resize: none;
        min-height: 36px;
        max-height: 100px;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .chat-send {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--text-sm);
        transition: all 0.2s ease;
    }

    .chat-send:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .chat-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Pagination */
    .pagination {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        flex-shrink: 0;
        min-width: 0;
    }

    .pagination button {
        background: var(--bg-cards);
        border: 2px solid var(--border-light);
        color: var(--text-secondary);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: var(--text-sm);
        transition: all 0.2s ease;
        min-width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .pagination button:hover:not(:disabled) {
        border-color: var(--falco-primary);
        color: var(--falco-primary);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination button.active {
        background: var(--falco-primary);
        color: white;
        border-color: var(--falco-primary);
        font-weight: 600;
    }

    /* Loading & Empty States */
    .loading, .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
        text-align: center;
        flex: 1;
        min-height: 200px;
        background: var(--bg-cards);
        border-radius: var(--radius-md);
        margin: var(--space-sm);
        border: 2px dashed var(--border-light);
    }

    .loading i, .empty-state i {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-md);
        color: var(--text-muted);
    }

    .loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .empty-state h3 {
        color: var(--text-heading);
        margin-bottom: var(--space-sm);
    }

    /* Large screen optimization */
    @media (min-width: 1600px) {
        .events-container.with-sidebar {
            grid-template-columns: 1fr 2fr;
        }
        
        .chat-messages {
            max-height: 500px;
        }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .events-container {
            grid-template-columns: 1fr;
            height: 100%;
        }
        
        .events-container.with-sidebar {
            grid-template-columns: 1fr 2fr;
        }
        
        .events-sidebar {
            order: -1;
            max-height: 500px;
        }

        .filters-content {
            grid-template-columns: 1fr;
        }

        .stats-summary {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .events-container {
            margin: 0;
            gap: var(--space-md);
            height: 100%;
        }
        
        .events-container.with-sidebar {
            grid-template-columns: 1fr;
        }
        
        .events-sidebar {
            order: -1;
            max-height: 60vh;
        }

        .stats-summary {
            grid-template-columns: 1fr;
        }

        .alerts-header {
            flex-direction: column;
            gap: var(--space-sm);
            align-items: stretch;
        }

        .alerts-controls {
            justify-content: space-between;
        }
    }

    /* Filter Enhancements */
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
        margin-bottom: var(--space-md);
        align-items: end;
    }

    .filter-group.filter-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        justify-content: flex-start;
    }

    .filter-input {
        width: 100%;
        padding: var(--space-sm);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-sm);
        background: var(--bg-cards);
        color: var(--text-heading);
        font-size: var(--text-sm);
        transition: all 0.2s ease;
    }

    .filter-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .filter-input::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .filters-status {
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .filter-count {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-weight: 500;
        padding: var(--space-xs) var(--space-sm);
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-light);
    }

    .filter-count.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-save-filter {
        background: var(--success);
        color: white;
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    .btn-save-filter:hover {
        background: var(--success-dark);
        transform: translateY(-1px);
    }

    /* Filter responsiveness */
    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
            gap: var(--space-sm);
        }
        
        .filter-group.filter-actions {
            justify-content: center;
            margin-top: var(--space-md);
        }
        
        .filter-group.filter-actions button {
            flex: 1;
            max-width: 120px;
        }
    }

    /* Filter state indicators */
    .filter-group.has-value .filter-label {
        color: var(--primary);
        font-weight: 600;
    }

    .filter-group.has-value .filter-input,
    .filter-group.has-value .filter-select {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="events-container">
    <!-- Main Events Area -->
    <div class="events-main">
        <!-- Alert Filters -->
        <div class="filters-card">
            <div class="filters-header" onclick="toggleFilters()">
                <h2 class="filters-title">
                    <i class="fas fa-filter"></i>
                    Advanced Filters & Controls
                </h2>
                <div class="filters-status">
                    <span id="filterStatus" class="filter-count">No filters active</span>
                    <button class="filters-toggle" id="filtersToggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            
            <div class="filters-content" id="filtersContent">
                <!-- Primary Filters Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Time Range</label>
                        <select id="timeRange" class="filter-select">
                            <option value="1h">Last Hour</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Priority</label>
                        <select id="priorityFilter" class="filter-select">
                            <option value="all">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="error">Error</option>
                            <option value="warning">Warning</option>
                            <option value="notice">Notice</option>
                            <option value="info">Info</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">All Status</option>
                            <option value="unread">Unread</option>
                            <option value="read">Read</option>
                            <option value="dismissed">Dismissed</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Per Page</label>
                        <select id="limitFilter" class="filter-select">
                            <option value="10">10 events</option>
                            <option value="25" selected>25 events</option>
                            <option value="50">50 events</option>
                            <option value="100">100 events</option>
                            <option value="200">200 events</option>
                        </select>
                    </div>
                </div>

                <!-- Secondary Filters Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Rule Name</label>
                        <input type="text" id="ruleFilter" class="filter-input" placeholder="Filter by rule name...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Container</label>
                        <input type="text" id="containerFilter" class="filter-input" placeholder="Filter by container name...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">User</label>
                        <input type="text" id="userFilter" class="filter-input" placeholder="Filter by user name...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Process</label>
                        <input type="text" id="processFilter" class="filter-input" placeholder="Filter by process name...">
                    </div>
                </div>

                <!-- Tertiary Filters Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Command</label>
                        <input type="text" id="commandFilter" class="filter-input" placeholder="Filter by command line...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">File Path</label>
                        <input type="text" id="fileFilter" class="filter-input" placeholder="Filter by file path...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Source/Host</label>
                        <input type="text" id="sourceFilter" class="filter-input" placeholder="Filter by source host...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Kubernetes</label>
                        <input type="text" id="k8sFilter" class="filter-input" placeholder="Filter by pod/namespace...">
                    </div>
                </div>

                <!-- Advanced Options Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Alert Content</label>
                        <input type="text" id="outputFilter" class="filter-input" placeholder="Search in alert description...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">AI Analysis</label>
                        <select id="aiAnalysisFilter" class="filter-select">
                            <option value="all">All Alerts</option>
                            <option value="with_ai">With AI Analysis</option>
                            <option value="without_ai">Without AI Analysis</option>
                            <option value="ai_error">AI Analysis Failed</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sortBy" class="filter-select">
                            <option value="timestamp_desc">Newest First</option>
                            <option value="timestamp_asc">Oldest First</option>
                            <option value="priority_desc">Priority (High→Low)</option>
                            <option value="priority_asc">Priority (Low→High)</option>
                            <option value="rule_asc">Rule Name (A→Z)</option>
                            <option value="rule_desc">Rule Name (Z→A)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group filter-actions">
                        <button class="btn-filter" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Apply
                        </button>
                        <button class="btn-reset" onclick="resetFilters()">
                            <i class="fas fa-times"></i> Reset
                        </button>
                        <button class="btn-save-filter" onclick="saveFilter()">
                            <i class="fas fa-bookmark"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-summary">
            <div class="stat-item" onclick="applyStatFilter('all')" data-filter="all" title="Show all events">
                <div class="stat-number" id="totalAlerts">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-item critical" onclick="applyStatFilter('critical')" data-filter="critical" title="Filter to critical priority events">
                <div class="stat-number" id="criticalAlerts">-</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat-item warning" onclick="applyStatFilter('unread')" data-filter="unread" title="Filter to unread events">
                <div class="stat-number" id="unreadAlerts">-</div>
                <div class="stat-label">Unread</div>
            </div>
            <div class="stat-item success" onclick="applyStatFilter('recent')" data-filter="recent" title="Filter to events from last hour">
                <div class="stat-number" id="recentAlerts">-</div>
                <div class="stat-label">Last Hour</div>
            </div>
        </div>

        <!-- Alerts List -->
        <div class="alerts-container">
            <div class="alerts-header">
                <div class="alerts-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Security Events
                    <span class="alerts-count" id="alertsCount">0</span>
                </div>
                <div class="alerts-controls">
                    <span class="pagination-info" id="paginationInfo">Loading...</span>
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="alerts-body">
                <div id="alertsList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading security events...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar - Alert Detail & AI Chat -->
    <div class="events-sidebar">
        <div class="detail-header">
            <h3 class="detail-title">
                <i class="fas fa-info-circle"></i>
                <span id="detailTitle">Select an event for details</span>
            </h3>
            <button class="detail-close" onclick="hideSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-body" id="detailContent">
            <div class="empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <h4>No Event Selected</h4>
                <p>Click on any security event to view detailed information and chat with AI about it.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let alerts = [];
    let filteredAlerts = [];
    let currentPage = 1;
    let itemsPerPage = 25;
    let totalPages = 1;
    let selectedAlert = null;
    let chatMessages = [];
    let currentFilters = {
        timeRange: '24h',
        priority: 'all',
        status: 'all',
        limit: '25',
        rule: '',
        container: '',
        user: '',
        process: '',
        command: '',
        file: '',
        source: '',
        k8s: '',
        output: '',
        aiAnalysis: 'all',
        sortBy: 'timestamp_desc'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize filters as collapsed
        const filtersContent = document.getElementById('filtersContent');
        const filtersToggle = document.getElementById('filtersToggle');
        filtersContent.classList.add('collapsed');
        filtersToggle.classList.add('collapsed');
        
        // Initialize filter event listeners
        const timeRangeEl = document.getElementById('timeRange');
        const priorityFilterEl = document.getElementById('priorityFilter');
        const statusFilterEl = document.getElementById('statusFilter');
        const limitFilterEl = document.getElementById('limitFilter');
        const ruleFilterEl = document.getElementById('ruleFilter');
        const containerFilterEl = document.getElementById('containerFilter');
        const userFilterEl = document.getElementById('userFilter');
        const processFilterEl = document.getElementById('processFilter');
        const commandFilterEl = document.getElementById('commandFilter');
        const fileFilterEl = document.getElementById('fileFilter');
        const sourceFilterEl = document.getElementById('sourceFilter');
        const k8sFilterEl = document.getElementById('k8sFilter');
        const outputFilterEl = document.getElementById('outputFilter');
        const aiAnalysisFilterEl = document.getElementById('aiAnalysisFilter');
        const sortByEl = document.getElementById('sortBy');
        
        // Add change event listeners for select elements
        if (timeRangeEl) timeRangeEl.addEventListener('change', applyFilters);
        if (priorityFilterEl) priorityFilterEl.addEventListener('change', applyFilters);
        if (statusFilterEl) statusFilterEl.addEventListener('change', applyFilters);
        if (limitFilterEl) limitFilterEl.addEventListener('change', applyFilters);
        if (aiAnalysisFilterEl) aiAnalysisFilterEl.addEventListener('change', applyFilters);
        if (sortByEl) sortByEl.addEventListener('change', applyFilters);
        
        // Add input event listeners for text inputs (with debouncing)
        let filterTimeout;
        const debounceApplyFilters = () => {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(applyFilters, 300); // 300ms debounce
        };
        
        if (ruleFilterEl) ruleFilterEl.addEventListener('input', debounceApplyFilters);
        if (containerFilterEl) containerFilterEl.addEventListener('input', debounceApplyFilters);
        if (userFilterEl) userFilterEl.addEventListener('input', debounceApplyFilters);
        if (processFilterEl) processFilterEl.addEventListener('input', debounceApplyFilters);
        if (commandFilterEl) commandFilterEl.addEventListener('input', debounceApplyFilters);
        if (fileFilterEl) fileFilterEl.addEventListener('input', debounceApplyFilters);
        if (sourceFilterEl) sourceFilterEl.addEventListener('input', debounceApplyFilters);
        if (k8sFilterEl) k8sFilterEl.addEventListener('input', debounceApplyFilters);
        if (outputFilterEl) outputFilterEl.addEventListener('input', debounceApplyFilters);
        
        // Read URL parameters and set filters
        initializeFiltersFromURL();
        
        // Load initial data
        loadAlerts();
        
        // Set up periodic refresh
        setInterval(loadAlerts, 30000); // Refresh every 30 seconds
        
        console.log('Runtime Events page initialized');
    });

    // Initialize filters from URL parameters
    function initializeFiltersFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Set time range filter
        const timeRange = urlParams.get('time_range');
        if (timeRange) {
            const timeRangeSelect = document.getElementById('timeRange');
            if (timeRangeSelect) {
                timeRangeSelect.value = timeRange;
                currentFilters.timeRange = timeRange;
            }
        }
        
        // Set priority filter
        const priority = urlParams.get('priority');
        if (priority) {
            const prioritySelect = document.getElementById('priorityFilter');
            if (prioritySelect) {
                prioritySelect.value = priority;
                currentFilters.priority = priority;
            }
        }
        
        // Set status filter
        const status = urlParams.get('status');
        if (status) {
            const statusSelect = document.getElementById('statusFilter');
            if (statusSelect) {
                statusSelect.value = status;
                currentFilters.status = status;
            }
        }
        
        // Set limit filter
        const limit = urlParams.get('limit');
        if (limit) {
            const limitSelect = document.getElementById('limitFilter');
            if (limitSelect) {
                limitSelect.value = limit;
                currentFilters.limit = limit;
                itemsPerPage = parseInt(limit);
            }
        }
        
        // Set rule filter (this will be applied during filtering since there's no select for it)
        const rule = urlParams.get('rule');
        if (rule) {
            currentFilters.rule = rule;
        }
        
        // Set source filter (this will be applied during filtering since there's no select for it)
        const source = urlParams.get('source');
        if (source) {
            currentFilters.source = source;
        }
        
        // Set AI analysis filter
        const aiAnalysis = urlParams.get('aiAnalysis');
        if (aiAnalysis) {
            const aiAnalysisSelect = document.getElementById('aiAnalysisFilter');
            if (aiAnalysisSelect) {
                aiAnalysisSelect.value = aiAnalysis;
                currentFilters.aiAnalysis = aiAnalysis;
            }
        }
        
        // Set container filter
        const container = urlParams.get('container');
        if (container) {
            const containerInput = document.getElementById('containerFilter');
            if (containerInput) {
                containerInput.value = container;
                currentFilters.container = container;
            }
        }
        
        // Set user filter
        const user = urlParams.get('user');
        if (user) {
            const userInput = document.getElementById('userFilter');
            if (userInput) {
                userInput.value = user;
                currentFilters.user = user;
            }
        }
        
        // Set process filter
        const process = urlParams.get('process');
        if (process) {
            const processInput = document.getElementById('processFilter');
            if (processInput) {
                processInput.value = process;
                currentFilters.process = process;
            }
        }
        
        // Set command filter
        const command = urlParams.get('command');
        if (command) {
            const commandInput = document.getElementById('commandFilter');
            if (commandInput) {
                commandInput.value = command;
                currentFilters.command = command;
            }
        }
        
        // Set file filter
        const file = urlParams.get('file');
        if (file) {
            const fileInput = document.getElementById('fileFilter');
            if (fileInput) {
                fileInput.value = file;
                currentFilters.file = file;
            }
        }
        
        // Set k8s filter
        const k8s = urlParams.get('k8s');
        if (k8s) {
            const k8sInput = document.getElementById('k8sFilter');
            if (k8sInput) {
                k8sInput.value = k8s;
                currentFilters.k8s = k8s;
            }
        }
        
        // Set output filter
        const output = urlParams.get('output');
        if (output) {
            const outputInput = document.getElementById('outputFilter');
            if (outputInput) {
                outputInput.value = output;
                currentFilters.output = output;
            }
        }
        
        // Set sort order
        const sortBy = urlParams.get('sortBy');
        if (sortBy) {
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.value = sortBy;
                currentFilters.sortBy = sortBy;
            }
        }
        
        // Update page title if filters are applied
        updatePageTitle();
        
        // Show filters panel if any URL parameters are set
        if (timeRange || priority || status || limit || rule || source || aiAnalysis || 
            container || user || process || command || file || k8s || output || sortBy) {
            const filtersContent = document.getElementById('filtersContent');
            const filtersToggle = document.getElementById('filtersToggle');
            if (filtersContent && filtersToggle) {
                filtersContent.classList.remove('collapsed');
                filtersToggle.classList.remove('collapsed');
            }
            
            // Show a notification about applied filters
            showFilterNotification();
        }
    }

    // Update page title based on active filters
    function updatePageTitle() {
        let title = 'Runtime Events';
        const activeFilters = [];
        
        if (currentFilters.priority && currentFilters.priority !== 'all') {
            activeFilters.push(`${currentFilters.priority} priority`);
        }
        if (currentFilters.rule) {
            activeFilters.push(`rule: ${currentFilters.rule}`);
        }
        if (currentFilters.status && currentFilters.status !== 'all') {
            activeFilters.push(`${currentFilters.status} status`);
        }
        if (currentFilters.timeRange && currentFilters.timeRange !== '24h') {
            activeFilters.push(`${currentFilters.timeRange} timeframe`);
        }
        if (currentFilters.source) {
            activeFilters.push(`source: ${currentFilters.source}`);
        }
        if (currentFilters.aiAnalysis && currentFilters.aiAnalysis !== 'all') {
            const aiLabel = currentFilters.aiAnalysis === 'without_ai' ? 'without AI analysis' :
                           currentFilters.aiAnalysis === 'with_ai' ? 'with AI analysis' :
                           currentFilters.aiAnalysis === 'ai_error' ? 'AI analysis errors' :
                           currentFilters.aiAnalysis;
            activeFilters.push(aiLabel);
        }
        if (currentFilters.container) {
            activeFilters.push(`container: ${currentFilters.container}`);
        }
        if (currentFilters.user) {
            activeFilters.push(`user: ${currentFilters.user}`);
        }
        if (currentFilters.process) {
            activeFilters.push(`process: ${currentFilters.process}`);
        }
        if (currentFilters.command) {
            activeFilters.push(`command: ${currentFilters.command}`);
        }
        if (currentFilters.file) {
            activeFilters.push(`file: ${currentFilters.file}`);
        }
        if (currentFilters.k8s) {
            activeFilters.push(`k8s: ${currentFilters.k8s}`);
        }
        if (currentFilters.output) {
            activeFilters.push(`output: ${currentFilters.output}`);
        }
        if (currentFilters.sortBy && currentFilters.sortBy !== 'timestamp_desc') {
            activeFilters.push(`sorted by: ${currentFilters.sortBy.replace('_', ' ')}`);
        }
        
        if (activeFilters.length > 0) {
            title += ` - ${activeFilters.join(', ')}`;
        }
        
        document.title = title;
        
        // Update the page description to show active filters
        const pageDescription = document.querySelector('.page-description');
        if (pageDescription && activeFilters.length > 0) {
            pageDescription.textContent = `Filtered by: ${activeFilters.join(', ')}`;
        }
    }

    // Show notification about applied filters from URL
    function showFilterNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--falco-primary);
            color: var(--text-inverse);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            z-index: 9999;
            font-size: var(--text-sm);
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            border: 2px solid var(--falco-primary-dark);
        `;
        
        const filterCount = Object.keys(currentFilters).filter(key => 
            currentFilters[key] && currentFilters[key] !== 'all' && currentFilters[key] !== '24h'
        ).length;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <i class="fas fa-filter"></i>
                <span>Filters applied from analytics (${filterCount})</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    // Toggle filters visibility
    function toggleFilters() {
        const filtersContent = document.getElementById('filtersContent');
        const filtersToggle = document.getElementById('filtersToggle');
        
        if (filtersContent.classList.contains('collapsed')) {
            filtersContent.classList.remove('collapsed');
            filtersToggle.classList.remove('collapsed');
        } else {
            filtersContent.classList.add('collapsed');
            filtersToggle.classList.add('collapsed');
        }
    }

    // Load alerts from API
    async function loadAlerts() {
        try {
            console.log('🔄 Loading alerts...');
            const alertsContainer = document.getElementById('alertsList');
            
            if (!alertsContainer) {
                console.error('❌ alerts container not found!');
                return;
            }
            
            const response = await fetch('/api/alerts?limit=1000'); // Load more for better volume
            
            console.log('📡 API Response status:', response.status);
            console.log('📡 API Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
                const newAlerts = await response.json();
                console.log('📊 Raw API response:', newAlerts);
                console.log('📊 Type of response:', typeof newAlerts);
                console.log('📊 Is array:', Array.isArray(newAlerts));
                
                if (Array.isArray(newAlerts)) {
                    alerts = newAlerts;
                    console.log(`✅ Loaded ${alerts.length} alerts successfully`);
                    
                    // Log sample alert structure
                    if (alerts.length > 0) {
                        console.log('📋 Sample alert structure:', alerts[0]);
                    } else {
                        console.log('ℹ️ No alerts found in database');
                    }
                    
                    applyFilters();
                    updateStats();
                } else {
                    console.error('❌ Invalid alerts data format:', newAlerts);
                    console.error('❌ Expected array, got:', typeof newAlerts);
                    alerts = [];
                    showError(`Invalid data format received from server. Expected array, got ${typeof newAlerts}`);
                    applyFilters();
                    updateStats();
                }
            } else {
                const errorText = await response.text();
                console.error('❌ Failed to load alerts:', response.status, response.statusText);
                console.error('❌ Error response body:', errorText);
                showError(`Failed to load alerts: ${response.status} ${response.statusText}`);
                // Don't reset alerts on error, keep existing data
            }
        } catch (error) {
            console.error('❌ Error loading alerts:', error);
            console.error('❌ Error stack:', error.stack);
            showError('Error loading alerts: ' + error.message);
            // Initialize empty alerts if this is the first load
            if (!alerts) {
                alerts = [];
                applyFilters();
                updateStats();
            }
        }
    }

    // Apply current filters
    function applyFilters() {
        try {
            console.log('🔍 APPLY FILTERS: Starting filter application...');
            
            // Get current filter values
            currentFilters.timeRange = document.getElementById('timeRange')?.value || 'all';
            currentFilters.priority = document.getElementById('priorityFilter')?.value || 'all';
            currentFilters.status = document.getElementById('statusFilter')?.value || 'all';
            currentFilters.limit = document.getElementById('limitFilter')?.value || '25';
            currentFilters.rule = document.getElementById('ruleFilter')?.value || '';
            currentFilters.container = document.getElementById('containerFilter')?.value || '';
            currentFilters.user = document.getElementById('userFilter')?.value || '';
            currentFilters.process = document.getElementById('processFilter')?.value || '';
            currentFilters.command = document.getElementById('commandFilter')?.value || '';
            currentFilters.file = document.getElementById('fileFilter')?.value || '';
            currentFilters.source = document.getElementById('sourceFilter')?.value || '';
            currentFilters.k8s = document.getElementById('k8sFilter')?.value || '';
            currentFilters.output = document.getElementById('outputFilter')?.value || '';
            currentFilters.aiAnalysis = document.getElementById('aiAnalysisFilter')?.value || 'all';
            currentFilters.sortBy = document.getElementById('sortBy')?.value || 'timestamp_desc';
            
            console.log('🔍 Current filters:', currentFilters);
            
            itemsPerPage = parseInt(currentFilters.limit);

            // Ensure alerts array exists
            if (!alerts || !Array.isArray(alerts)) {
                console.log('❌ No alerts data available for filtering');
                filteredAlerts = [];
                displayAlerts();
                updatePagination();
                updateStats();
                updateStatCards();
                updateFilterStatus();
                return;
            }
            
            console.log(`🔍 Starting with ${alerts.length} total alerts`);

            filteredAlerts = alerts.filter((alert, index) => {
                if (!alert) {
                    console.log(`❌ Alert ${index} is null/undefined`);
                    return false;
                }

                // Time range filter
                if (currentFilters.timeRange !== 'all') {
                    const alertTime = new Date(alert.timestamp || alert.time);
                    if (isNaN(alertTime.getTime())) {
                        console.log(`❌ Alert ${index} has invalid timestamp:`, alert.timestamp || alert.time);
                        return false; // Skip alerts with invalid timestamps
                    }
                    
                    const now = new Date();
                    const diffHours = (now - alertTime) / (1000 * 60 * 60);
                    
                    switch (currentFilters.timeRange) {
                        case '1h': 
                            if (diffHours > 1) {
                                console.log(`⏰ Alert ${index} filtered out: ${diffHours.toFixed(1)}h > 1h`);
                                return false; 
                            }
                            break;
                        case '24h': 
                            if (diffHours > 24) {
                                console.log(`⏰ Alert ${index} filtered out: ${diffHours.toFixed(1)}h > 24h`);
                                return false; 
                            }
                            break;
                        case '7d': 
                            if (diffHours > 24 * 7) {
                                console.log(`⏰ Alert ${index} filtered out: ${diffHours.toFixed(1)}h > 168h`);
                                return false; 
                            }
                            break;
                        case '30d': 
                            if (diffHours > 24 * 30) {
                                console.log(`⏰ Alert ${index} filtered out: ${diffHours.toFixed(1)}h > 720h`);
                                return false; 
                            }
                            break;
                    }
                }

                // Priority filter
                if (currentFilters.priority !== 'all') {
                    const alertPriority = alert.priority || 'info';
                    if (alertPriority !== currentFilters.priority) {
                        console.log(`🚨 Alert ${index} filtered out: priority '${alertPriority}' !== '${currentFilters.priority}'`);
                        return false;
                    }
                }

                // Status filter  
                if (currentFilters.status !== 'all') {
                    const alertStatus = alert.status || 'unread';
                    if (alertStatus !== currentFilters.status) {
                        console.log(`📊 Alert ${index} filtered out: status '${alertStatus}' !== '${currentFilters.status}'`);
                        return false;
                    }
                }

                console.log(`✅ Alert ${index} passed filters: ${alert.rule}`);
                
                // Rule filter
                if (currentFilters.rule) {
                    const alertRule = alert.rule || '';
                    if (!alertRule.toLowerCase().includes(currentFilters.rule.toLowerCase())) {
                        console.log(`📝 Alert ${index} filtered out: rule '${alertRule}' doesn't contain '${currentFilters.rule}'`);
                        return false;
                    }
                }

                // Container filter
                if (currentFilters.container) {
                    const containerName = alert.source || 
                                        alert.fields?.['container.name'] || 
                                        alert.output_fields?.['container.name'] || '';
                    if (!containerName.toLowerCase().includes(currentFilters.container.toLowerCase())) {
                        console.log(`🐳 Alert ${index} filtered out: container '${containerName}' doesn't contain '${currentFilters.container}'`);
                        return false;
                    }
                }

                // User filter
                if (currentFilters.user) {
                    const userName = alert.fields?.['user.name'] || 
                                   alert.output_fields?.['user.name'] || '';
                    if (!userName.toLowerCase().includes(currentFilters.user.toLowerCase())) {
                        console.log(`👤 Alert ${index} filtered out: user '${userName}' doesn't contain '${currentFilters.user}'`);
                        return false;
                    }
                }

                // Process filter
                if (currentFilters.process) {
                    const processName = alert.fields?.['proc.name'] || 
                                      alert.output_fields?.['proc.name'] || '';
                    if (!processName.toLowerCase().includes(currentFilters.process.toLowerCase())) {
                        console.log(`⚙️ Alert ${index} filtered out: process '${processName}' doesn't contain '${currentFilters.process}'`);
                        return false;
                    }
                }

                // Command filter
                if (currentFilters.command) {
                    const command = alert.fields?.['proc.cmdline'] || 
                                  alert.output_fields?.['proc.cmdline'] || '';
                    if (!command.toLowerCase().includes(currentFilters.command.toLowerCase())) {
                        console.log(`💻 Alert ${index} filtered out: command '${command}' doesn't contain '${currentFilters.command}'`);
                        return false;
                    }
                }

                // File filter
                if (currentFilters.file) {
                    const fileName = alert.fields?.['fd.name'] || 
                                   alert.output_fields?.['fd.name'] || '';
                    if (!fileName.toLowerCase().includes(currentFilters.file.toLowerCase())) {
                        console.log(`📁 Alert ${index} filtered out: file '${fileName}' doesn't contain '${currentFilters.file}'`);
                        return false;
                    }
                }

                // Source filter
                if (currentFilters.source) {
                    const source = alert.source || '';
                    if (!source.toLowerCase().includes(currentFilters.source.toLowerCase())) {
                        console.log(`🖥️ Alert ${index} filtered out: source '${source}' doesn't contain '${currentFilters.source}'`);
                        return false;
                    }
                }

                // Kubernetes filter
                if (currentFilters.k8s) {
                    const k8sPod = alert.fields?.['k8s.pod.name'] || 
                                 alert.output_fields?.['k8s.pod.name'] || '';
                    const k8sNamespace = alert.fields?.['k8s.ns.name'] || 
                                       alert.output_fields?.['k8s.ns.name'] || '';
                    const k8sData = `${k8sPod} ${k8sNamespace}`;
                    if (!k8sData.toLowerCase().includes(currentFilters.k8s.toLowerCase())) {
                        console.log(`☸️ Alert ${index} filtered out: k8s '${k8sData}' doesn't contain '${currentFilters.k8s}'`);
                        return false;
                    }
                }

                // Output content filter
                if (currentFilters.output) {
                    const output = alert.output || '';
                    if (!output.toLowerCase().includes(currentFilters.output.toLowerCase())) {
                        console.log(`📄 Alert ${index} filtered out: output doesn't contain '${currentFilters.output}'`);
                        return false;
                    }
                }

                // AI Analysis filter
                if (currentFilters.aiAnalysis !== 'all') {
                    const hasAI = alert.ai_analysis && Object.keys(alert.ai_analysis).length > 0;
                    const hasAIError = alert.ai_analysis && alert.ai_analysis.error;
                    
                    switch (currentFilters.aiAnalysis) {
                        case 'with_ai':
                            if (!hasAI || hasAIError) {
                                console.log(`🤖 Alert ${index} filtered out: no valid AI analysis`);
                                return false;
                            }
                            break;
                        case 'without_ai':
                            if (hasAI && !hasAIError) {
                                console.log(`🤖 Alert ${index} filtered out: has AI analysis`);
                                return false;
                            }
                            break;
                        case 'ai_error':
                            if (!hasAIError) {
                                console.log(`🤖 Alert ${index} filtered out: no AI error`);
                                return false;
                            }
                            break;
                    }
                }

                console.log(`✅ Alert ${index} passed ALL filters: ${alert.rule}`);
                return true; // Temporarily return true here to bypass other filters for debugging
            });

            console.log(`🔍 After filtering: ${filteredAlerts.length} alerts remain`);

            // Apply sorting
            applySorting();

            // Reset pagination
            currentPage = 1;
            totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);
            
            // Update display
            displayAlerts();
            updatePagination();
            updateStats();
            updateStatCards();
            updateFilterStatus();
            
            console.log(`✅ Filter application complete: ${filteredAlerts.length} of ${alerts.length} alerts shown`);
            
        } catch (error) {
            console.error('❌ Error applying filters:', error);
            console.error('Error stack:', error.stack);
            showError('Error applying filters: ' + error.message);
        }
    }

    // Display alerts for current page
    function displayAlerts() {
        const container = document.getElementById('alertsList');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageAlerts = filteredAlerts.slice(startIndex, endIndex);
        
        if (pageAlerts.length === 0) {
            const totalAlertsMessage = alerts.length === 0 
                ? 'No security alerts have been received yet.' 
                : `${alerts.length} alerts available, but none match your current filters.`;
            
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shield-alt"></i>
                    <h3>No Security Events</h3>
                    <p>${totalAlertsMessage}</p>
                    ${alerts.length === 0 ? `
                        <div style="margin-top: var(--space-lg);">
                            <p><strong>To get started:</strong></p>
                            <ol style="text-align: left; max-width: 400px;">
                                <li>Configure Falco to send alerts to this system</li>
                                <li>Use webhook URL: <code>http://localhost:8080/webhook</code></li>
                                <li>Or send a test alert to verify the system is working</li>
                            </ol>
                            <button onclick="sendTestAlert()" class="btn" style="margin-top: var(--space-md); background: var(--falco-primary); color: white; border: none; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-md); cursor: pointer;">
                                <i class="fas fa-paper-plane"></i> Send Test Alert
                            </button>
                        </div>
                    ` : `
                        <div style="margin-top: var(--space-lg);">
                            <button onclick="resetFilters()" class="btn" style="background: var(--falco-primary); color: white; border: none; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-md); cursor: pointer;">
                                <i class="fas fa-times"></i> Clear All Filters
                            </button>
                        </div>
                    `}
                </div>
            `;
            return;
        }

        container.innerHTML = pageAlerts.map((alert, index) => {
            const actualIndex = startIndex + index;
            
            return `
                <div class="alert-item" onclick="selectAlert(${actualIndex})" id="alert-${actualIndex}">
                    <div class="alert-header">
                        <div class="alert-rule">${alert.rule || 'Unknown Rule'}</div>
                        <div class="alert-priority priority-${alert.priority || 'info'}">${alert.priority || 'info'}</div>
                    </div>
                    <div class="alert-output">${alert.output || 'No output available'}</div>
                    <div class="alert-metadata">
                        <span><i class="fas fa-clock"></i> ${formatTime(alert.timestamp || alert.time)}</span>
                        <span><i class="fas fa-server"></i> ${alert.source || 'Unknown'}</span>
                        <span><i class="fas fa-tag"></i> ${alert.status || 'unread'}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('alertsCount').textContent = filteredAlerts.length;
    }

    // Test function to ensure sidebar works
    function testSidebar() {
        const mockAlert = {
            id: 'test-123',
            rule: 'Test Security Rule',
            priority: 'critical',
            output: 'This is a test security event to verify the sidebar functionality.',
            timestamp: new Date().toISOString(),
            source: 'test-source',
            status: 'unread'
        };
        
        selectedAlert = mockAlert;
        
        // Show sidebar using the same method as selectAlert
        const container = document.querySelector('.events-container');
        const sidebar = document.querySelector('.events-sidebar');
        
        if (container && sidebar) {
            container.classList.add('with-sidebar');
            sidebar.classList.add('active');
        }
        
        showAlertDetails(mockAlert);
        
        // Clear chat
        chatMessages = [];
        renderChatMessages();
    }

    // Select alert and show details
    async function selectAlert(actualIndex) {
        // Calculate the correct index within the current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const relativeIndex = actualIndex - startIndex;
        const pageAlerts = filteredAlerts.slice(startIndex, startIndex + itemsPerPage);
        
        // Remove previous selection
        document.querySelectorAll('.alert-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Add selection to clicked item
        const alertElement = document.getElementById(`alert-${actualIndex}`);
        if (alertElement) {
            alertElement.classList.add('selected');
        }
        
        selectedAlert = pageAlerts[relativeIndex];
        
        if (!selectedAlert) {
            console.error('No alert found at index:', relativeIndex);
            return;
        }
        
        // Auto-mark alert as read when selected
        await markAlertAsRead(selectedAlert.id, alertElement);
        
        // Show sidebar and update container layout
        const container = document.querySelector('.events-container');
        const sidebar = document.querySelector('.events-sidebar');
        
        if (container && sidebar) {
            container.classList.add('with-sidebar');
            sidebar.classList.add('active');
        }
        
        showAlertDetails(selectedAlert);
        
        // Load chat history for this alert or start fresh
        loadChatHistoryForAlert(selectedAlert.id);
    }

    // Mark single alert as read
    async function markAlertAsRead(alertId, alertElement) {
        try {
            const response = await fetch(`/api/alerts/${alertId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'read' })
            });
            
            if (response.ok) {
                // Update the alert in our local data
                const alert = alerts.find(a => a.id == alertId);
                if (alert && alert.status === 'unread') {
                    alert.status = 'read';
                    
                    // Update the UI to reflect the status change
                    if (alertElement) {
                        alertElement.classList.remove('unread');
                        alertElement.classList.add('read');
                        
                        // Update the status text in the metadata
                        const statusSpan = alertElement.querySelector('.alert-metadata span:last-child');
                        if (statusSpan) {
                            statusSpan.innerHTML = '<i class="fas fa-tag"></i> read';
                        }
                    }
                    
                    // Update the selected alert status if it's the same one
                    if (selectedAlert && selectedAlert.id == alertId) {
                        selectedAlert.status = 'read';
                    }
                    
                    // Update statistics
                    updateStats();
                    
                    console.log(`✅ Marked alert ${alertId} as read`);
                }
            } else {
                console.error('Failed to mark alert as read:', response.statusText);
            }
        } catch (error) {
            console.error('Error marking alert as read:', error);
        }
    }

    // Show alert details in sidebar
    function showAlertDetails(alert) {
        console.log('Showing alert details for:', alert);
        
        const detailTitle = document.getElementById('detailTitle');
        const detailContent = document.getElementById('detailContent');
        
        if (!detailTitle || !detailContent) {
            console.error('Detail elements not found');
            return;
        }
        
        detailTitle.textContent = `${alert.rule}`;
        
        detailContent.innerHTML = `
            <div class="detail-section">
                <h4><i class="fas fa-exclamation-triangle"></i> Alert Information</h4>
                <div class="detail-content">
                    <div class="detail-meta">
                        <span class="label">Rule:</span>
                        <span class="value">${alert.rule || 'Unknown'}</span>
                        
                        <span class="label">Priority:</span>
                        <span class="value">
                            <span class="alert-priority priority-${alert.priority || 'info'}">${alert.priority || 'info'}</span>
                        </span>
                        
                        <span class="label">Timestamp:</span>
                        <span class="value">${formatTime(alert.timestamp || alert.time)}</span>
                        
                        <span class="label">Source:</span>
                        <span class="value">${alert.source || 'Unknown'}</span>
                        
                        <span class="label">Status:</span>
                        <span class="value">${alert.status || 'unread'}</span>
                        
                        <span class="label">ID:</span>
                        <span class="value">${alert.id || 'Unknown'}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4><i class="fas fa-file-alt"></i> Alert Output</h4>
                <div class="detail-content">
                    <pre style="white-space: pre-wrap; font-size: var(--text-sm); line-height: 1.4; color: var(--text-heading);">${alert.output || 'No output available'}</pre>
                </div>
            </div>

            ${alert.fields ? `
            <div class="detail-section">
                <h4><i class="fas fa-code"></i> Additional Fields</h4>
                <div class="detail-content">
                    <pre style="white-space: pre-wrap; font-size: var(--text-xs); color: var(--text-secondary);">${JSON.stringify(typeof alert.fields === 'string' ? JSON.parse(alert.fields) : alert.fields || {}, null, 2)}</pre>
                </div>
            </div>
            ` : ''}

            ${alert.ai_analysis ? `
            <div class="detail-section">
                <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                <div class="detail-content">
                    <div class="ai-analysis-content" style="font-size: var(--text-sm); color: var(--text-heading); line-height: 1.5;">${formatAIAnalysis(alert.ai_analysis)}</div>
                    ${hasEmptyAIContent(alert.ai_analysis) ? `
                    <div class="ai-regenerate-section" style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-sm);">
                        <p style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xs); color: var(--text-secondary);">
                            <i class="fas fa-info-circle"></i> AI analysis was generated but appears to be incomplete.
                        </p>
                        <button onclick="regenerateAIAnalysis(${alert.id})" class="btn btn-sm" style="background: var(--falco-primary); color: #fff; border: none; border-radius: var(--radius-md); padding: 0.5em 1.2em; font-weight: 500; box-shadow: var(--shadow-sm); transition: background 0.2s;">
                            <i class="fas fa-sync-alt"></i> Regenerate Analysis
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : `
            <div class="detail-section">
                <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                <div class="detail-content">
                    <div class="ai-analysis-empty">
                        <em>No AI analysis available for this alert.</em>
                        <div style="margin-top: var(--space-sm);">
                            <button onclick="regenerateAIAnalysis(${alert.id})" class="btn btn-sm" style="background: var(--falco-primary); color: #fff; border: none; border-radius: var(--radius-md); padding: 0.5em 1.2em; font-weight: 500; box-shadow: var(--shadow-sm); transition: background 0.2s;">
                                <i class="fas fa-magic"></i> Generate AI Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `}

            <!-- AI Chat Section -->
            <div class="ai-chat-section">
                <div class="chat-header">
                    <i class="fas fa-robot"></i>
                    Chat with AI about this alert
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message assistant">
                        <div class="content">
                            Hi! I can help you analyze this security alert. Ask me anything about it - what it means, potential risks, recommended actions, or how it relates to other security events.
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Ask about this alert..."
                            onkeydown="handleChatKeyDown(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button class="chat-send" onclick="sendChatMessage()" id="chatSendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        console.log('Alert details populated');
    }

    // Handle chat input
    function handleChatKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    }

    // Auto-resize textarea
    function adjustTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    // Send chat message
    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        const sendBtn = document.getElementById('chatSendBtn');
        
        if (!message || !selectedAlert) return;
        
        // Add user message to chat
        chatMessages.push({ role: 'user', content: message });
        renderChatMessages();
        // Save chat history for this alert
        if (selectedAlert && selectedAlert.id) {
            saveChatHistoryForAlert(selectedAlert.id);
        }
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        
        // Disable send button
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            const response = await fetch('/api/enhanced-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    context: {
                        alert: selectedAlert,
                        previous_messages: chatMessages.slice(-10) // Last 10 messages for context
                    },
                    persona: 'security_analyst',
                    language: 'en'
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    chatMessages.push({ role: 'assistant', content: data.response });
                    renderChatMessages();
                    // Save chat history for this alert
                    if (selectedAlert && selectedAlert.id) {
                        saveChatHistoryForAlert(selectedAlert.id);
                    }
                } else {
                    throw new Error(data.error || 'Chat failed');
                }
            } else {
                throw new Error('Chat service unavailable');
            }
        } catch (error) {
            console.error('Chat error:', error);
            chatMessages.push({ 
                role: 'assistant', 
                content: '❌ Sorry, I encountered an error. Please try again.' 
            });
            renderChatMessages();
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }

    // Render chat messages
    function renderChatMessages() {
        const container = document.getElementById('chatMessages');
        if (!container) return;
        
        container.innerHTML = chatMessages.map(msg => {
            // Parse markdown for assistant messages, escape HTML for user messages
            const formattedContent = msg.role === 'assistant' ? 
                marked.parse(msg.content) : 
                escapeHtml(msg.content);
            
            return `
                <div class="chat-message ${msg.role}">
                    <div class="content">${formattedContent}</div>
                </div>
            `;
        }).join('');
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    // Update pagination
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        const info = document.getElementById('paginationInfo');
        
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, filteredAlerts.length);
        
        info.textContent = `${startItem}-${endItem} of ${filteredAlerts.length}`;
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>`;
        
        // Page numbers (show 5 pages max)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        startPage = Math.max(1, endPage - 4);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
        }
        
        // Next button
        paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>`;
        
        pagination.innerHTML = paginationHTML;
    }

    // Change page
    function changePage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        displayAlerts();
        updatePagination();
        
        // Clear selection and hide sidebar when changing pages
        selectedAlert = null;
        hideSidebar();
        
        // Remove selection from all items
        document.querySelectorAll('.alert-item').forEach(item => {
            item.classList.remove('selected');
        });
    }

    // Update statistics
    function updateStats() {
        document.getElementById('totalAlerts').textContent = alerts.length;
        document.getElementById('criticalAlerts').textContent = 
            alerts.filter(a => a.priority === 'critical').length;
        document.getElementById('unreadAlerts').textContent = 
            alerts.filter(a => (a.status || 'unread') === 'unread').length;
        
        // Recent alerts (last hour)
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        document.getElementById('recentAlerts').textContent = 
            alerts.filter(a => new Date(a.timestamp || a.time) > oneHourAgo).length;
    }

    // Apply filter from stat card click
    function applyStatFilter(filterType) {
        try {
            console.log(`Applying stat filter: ${filterType}`);
            
            // Remove active class from all stat items
            document.querySelectorAll('.stat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            const clickedItem = document.querySelector(`[data-filter="${filterType}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // Get filter elements
            const timeRangeEl = document.getElementById('timeRange');
            const priorityFilterEl = document.getElementById('priorityFilter');
            const statusFilterEl = document.getElementById('statusFilter');
            
            if (!timeRangeEl || !priorityFilterEl || !statusFilterEl) {
                console.error('Filter elements not found');
                return;
            }
            
            // Apply the appropriate filter
            switch (filterType) {
                case 'all':
                    // Clear all filters
                    timeRangeEl.value = '24h';
                    priorityFilterEl.value = 'all';
                    statusFilterEl.value = 'all';
                    break;
                case 'critical':
                    // Filter to critical priority, keep other filters
                    priorityFilterEl.value = 'critical';
                    break;
                case 'unread':
                    // Filter to unread status, keep other filters
                    statusFilterEl.value = 'unread';
                    break;
                case 'recent':
                    // Filter to last hour, keep other filters
                    timeRangeEl.value = '1h';
                    break;
                default:
                    console.warn(`Unknown filter type: ${filterType}`);
                    return;
            }
            
            // Apply the filters
            applyFilters();
            
            // Show visual feedback
            showFilterFeedback(filterType);
            
        } catch (error) {
            console.error('Error applying stat filter:', error);
            showError('Error applying filter: ' + error.message);
        }
    }
    
    // Show feedback for applied filter
    function showFilterFeedback(filterType) {
        const messages = {
            'all': 'Showing all events',
            'critical': 'Filtered to critical priority events',
            'unread': 'Filtered to unread events',
            'recent': 'Filtered to events from last hour',
            'ai_regenerated': 'AI analysis regenerated successfully'
        };
        
        const message = messages[filterType] || 'Filter applied';
        
        // Create temporary feedback element
        const feedback = document.createElement('div');
        feedback.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            z-index: 9999;
            font-size: var(--text-sm);
            animation: slideInRight 0.3s ease;
        `;
        feedback.textContent = message;
        document.body.appendChild(feedback);
        
        // Remove after 2 seconds
        setTimeout(() => {
            feedback.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 300);
        }, 2000);
    }

    // Clear all filters
    function resetFilters() {
        try {
            console.log('Resetting all filters');
            
            // Reset filter values
            const timeRangeEl = document.getElementById('timeRange');
            const priorityFilterEl = document.getElementById('priorityFilter');
            const statusFilterEl = document.getElementById('statusFilter');
            const limitFilterEl = document.getElementById('limitFilter');
            const ruleFilterEl = document.getElementById('ruleFilter');
            const containerFilterEl = document.getElementById('containerFilter');
            const userFilterEl = document.getElementById('userFilter');
            const processFilterEl = document.getElementById('processFilter');
            const commandFilterEl = document.getElementById('commandFilter');
            const fileFilterEl = document.getElementById('fileFilter');
            const sourceFilterEl = document.getElementById('sourceFilter');
            const k8sFilterEl = document.getElementById('k8sFilter');
            const outputFilterEl = document.getElementById('outputFilter');
            const aiAnalysisFilterEl = document.getElementById('aiAnalysisFilter');
            const sortByEl = document.getElementById('sortBy');
            
            // Reset select elements
            if (timeRangeEl) timeRangeEl.value = '24h';
            if (priorityFilterEl) priorityFilterEl.value = 'all';
            if (statusFilterEl) statusFilterEl.value = 'all';
            if (limitFilterEl) limitFilterEl.value = '25';
            if (aiAnalysisFilterEl) aiAnalysisFilterEl.value = 'all';
            if (sortByEl) sortByEl.value = 'timestamp_desc';
            
            // Reset text inputs
            if (ruleFilterEl) ruleFilterEl.value = '';
            if (containerFilterEl) containerFilterEl.value = '';
            if (userFilterEl) userFilterEl.value = '';
            if (processFilterEl) processFilterEl.value = '';
            if (commandFilterEl) commandFilterEl.value = '';
            if (fileFilterEl) fileFilterEl.value = '';
            if (sourceFilterEl) sourceFilterEl.value = '';
            if (k8sFilterEl) k8sFilterEl.value = '';
            if (outputFilterEl) outputFilterEl.value = '';
            
            // Reset current filters object
            currentFilters = {
                timeRange: '24h',
                priority: 'all',
                status: 'all',
                limit: '25',
                rule: '',
                container: '',
                user: '',
                process: '',
                command: '',
                file: '',
                source: '',
                k8s: '',
                output: '',
                aiAnalysis: 'all',
                sortBy: 'timestamp_desc'
            };
            
            // Remove active class from all stat items
            document.querySelectorAll('.stat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Apply default filters
            applyFilters();
            
            showFilterFeedback('reset');
            
        } catch (error) {
            console.error('Error resetting filters:', error);
            showError('Error resetting filters: ' + error.message);
        }
    }

    function clearFilters() {
        // Remove active class from all stat items
        document.querySelectorAll('.stat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        document.getElementById('timeRange').value = '24h';
        document.getElementById('priorityFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('limitFilter').value = '25';
        applyFilters();
        
        showFilterFeedback('all');
    }

    // Update stat card active states based on current filters
    function updateStatCards() {
        // Remove active class from all stat items
        document.querySelectorAll('.stat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Determine which filter is active
        const timeRange = document.getElementById('timeRange').value;
        const priority = document.getElementById('priorityFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        // Set active state based on current filters
        if (priority === 'critical') {
            document.querySelector('[data-filter="critical"]')?.classList.add('active');
        } else if (status === 'unread') {
            document.querySelector('[data-filter="unread"]')?.classList.add('active');
        } else if (timeRange === '1h') {
            document.querySelector('[data-filter="recent"]')?.classList.add('active');
        } else if (timeRange === '24h' && priority === 'all' && status === 'all') {
            document.querySelector('[data-filter="all"]')?.classList.add('active');
        }
        // If multiple filters are active or it's a custom combination, no stat card is highlighted
    }

    // Load chat history for specific alert
    function loadChatHistoryForAlert(alertId) {
        try {
            const savedHistory = localStorage.getItem(`chat_history_${alertId}`);
            if (savedHistory) {
                chatMessages = JSON.parse(savedHistory);
            } else {
                chatMessages = [
                    { 
                        role: 'assistant', 
                        content: 'Hi! I can help you analyze this security alert. Ask me anything about it - what it means, potential risks, recommended actions, or how it relates to other security events.' 
                    }
                ];
            }
            renderChatMessages();
        } catch (error) {
            console.error('Error loading chat history:', error);
            chatMessages = [
                { 
                    role: 'assistant', 
                    content: 'Hi! I can help you analyze this security alert. Ask me anything about it - what it means, potential risks, recommended actions, or how it relates to other security events.' 
                }
            ];
            renderChatMessages();
        }
    }

    // Save chat history for specific alert
    function saveChatHistoryForAlert(alertId) {
        try {
            localStorage.setItem(`chat_history_${alertId}`, JSON.stringify(chatMessages));
        } catch (error) {
            console.error('Error saving chat history:', error);
        }
    }

    // Check if AI analysis has empty content
    function hasEmptyAIContent(aiAnalysis) {
        try {
            if (!aiAnalysis) return true;
            
            let analysis = aiAnalysis;
            if (typeof aiAnalysis === 'string') {
                try {
                    analysis = JSON.parse(aiAnalysis);
                } catch (e) {
                    return false; // If it's not JSON, assume it has content
                }
            }
            
            // Check if it's the structured format with sections
            if (analysis['Security Impact'] || analysis['Next Steps'] || analysis['Remediation Steps']) {
                const sections = ['Security Impact', 'Next Steps', 'Remediation Steps'];
                return sections.every(section => 
                    !analysis[section] || 
                    !analysis[section].content || 
                    analysis[section].content.trim() === ''
                );
            }
            
            // Check fallback format
            if (analysis.securityImpact || analysis.nextSteps || analysis.remediationSteps) {
                return (!analysis.securityImpact || analysis.securityImpact.trim() === '') &&
                       (!analysis.nextSteps || analysis.nextSteps.trim() === '') &&
                       (!analysis.remediationSteps || analysis.remediationSteps.trim() === '');
            }
            
            return false;
        } catch (error) {
            console.error('Error checking AI content:', error);
            return true;
        }
    }

    // Regenerate AI analysis for a specific alert
    async function regenerateAIAnalysis(alertId) {
        try {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            const response = await fetch(`/api/alerts/${alertId}/reprocess`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    // Refresh the alert details
                    if (selectedAlert && selectedAlert.id === alertId) {
                        selectedAlert.ai_analysis = result.ai_analysis;
                        showAlertDetails(selectedAlert);
                    }
                    
                    // Show success message
                    showFilterFeedback('ai_regenerated');
                } else {
                    throw new Error(result.error || 'Failed to regenerate AI analysis');
                }
            } else {
                throw new Error('Failed to regenerate AI analysis');
            }
        } catch (error) {
            console.error('Error regenerating AI analysis:', error);
            alert('Failed to regenerate AI analysis: ' + error.message);
        } finally {
            // Restore button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // Format AI Analysis with markdown
    function formatAIAnalysis(aiAnalysis) {
        try {
            if (!aiAnalysis) {
                return '<div class="ai-analysis-empty"><em>No AI analysis available for this alert.</em></div>';
            }
            
            // Parse if it's a string
            let analysis = aiAnalysis;
            if (typeof aiAnalysis === 'string') {
                try {
                    analysis = JSON.parse(aiAnalysis);
                } catch (e) {
                    // If it's not JSON, treat as plain text
                    return marked.parse(aiAnalysis);
                }
            }
            
            // Check if it's the structured format with sections
            if (analysis['Security Impact'] || analysis['Next Steps'] || analysis['Remediation Steps']) {
                let formattedAnalysis = '';
                
                // Add provider info if available
                if (analysis.llm_provider) {
                    formattedAnalysis += `<div class="ai-provider-info"><strong>AI Provider:</strong> ${analysis.llm_provider}</div>\n\n`;
                }
                
                // Security Impact
                if (analysis['Security Impact'] && analysis['Security Impact'].content) {
                    formattedAnalysis += `## Security Impact\n\n${analysis['Security Impact'].content}\n\n`;
                }
                
                // Next Steps
                if (analysis['Next Steps'] && analysis['Next Steps'].content) {
                    formattedAnalysis += `## Next Steps\n\n${analysis['Next Steps'].content}\n\n`;
                }
                
                // Remediation Steps
                if (analysis['Remediation Steps'] && analysis['Remediation Steps'].content) {
                    formattedAnalysis += `## Remediation Steps\n\n${analysis['Remediation Steps'].content}\n\n`;
                }
                
                // Suggested Commands
                if (analysis['Suggested Commands'] && analysis['Suggested Commands'].content) {
                    formattedAnalysis += `## Suggested Commands\n\n${analysis['Suggested Commands'].content}\n\n`;
                }
                
                // If no content found, show empty state
                if (!formattedAnalysis.trim()) {
                    return '<div class="ai-analysis-empty"><em>AI analysis is available but has no content.</em></div>';
                }
                
                return marked.parse(formattedAnalysis);
            }
            
            // Fallback for other formats
            if (analysis.securityImpact || analysis.nextSteps || analysis.remediationSteps) {
                let formattedAnalysis = '';
                
                if (analysis.llm_provider) {
                    formattedAnalysis += `<div class="ai-provider-info"><strong>AI Provider:</strong> ${analysis.llm_provider}</div>\n\n`;
                }
                
                if (analysis.securityImpact) {
                    formattedAnalysis += `## Security Impact\n\n${analysis.securityImpact}\n\n`;
                }
                
                if (analysis.nextSteps) {
                    formattedAnalysis += `## Next Steps\n\n${analysis.nextSteps}\n\n`;
                }
                
                if (analysis.remediationSteps) {
                    formattedAnalysis += `## Remediation Steps\n\n${analysis.remediationSteps}\n\n`;
                }
                
                if (analysis.suggestedCommands) {
                    formattedAnalysis += `## Suggested Commands\n\n${analysis.suggestedCommands}\n\n`;
                }
                
                return marked.parse(formattedAnalysis);
            }
            
            // If it's just a string, parse as markdown
            if (typeof analysis === 'string') {
                return marked.parse(analysis);
            }
            
            // Last resort - stringify and escape
            return escapeHtml(JSON.stringify(analysis, null, 2));
            
        } catch (error) {
            console.error('Error formatting AI analysis:', error);
            return '<div class="ai-analysis-error"><em>Error displaying AI analysis.</em></div>';
        }
    }

    // Utility functions
    function formatTime(timestamp) {
        if (!timestamp) return 'Unknown';
        try {
            return new Date(timestamp).toLocaleString();
        } catch {
            return timestamp;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        const container = document.getElementById('alertsList');
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                <h3>Error</h3>
                <p>${message}</p>
            </div>
        `;
    }

    function hideSidebar() {
        const sidebar = document.querySelector('.events-sidebar');
        const container = document.querySelector('.events-container');
        const detailTitle = document.getElementById('detailTitle');
        const detailContent = document.getElementById('detailContent');
        
        // Remove active classes
        sidebar.classList.remove('active');
        container.classList.remove('with-sidebar');
        
        // Remove any forced styling from debugging
        sidebar.style.display = '';
        
        // Reset selected alert
        selectedAlert = null;
        
        // Reset sidebar content to initial clean state
        detailTitle.textContent = 'Select an event for details';
        detailContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <h4>No Event Selected</h4>
                <p>Click on any security event to view detailed information and chat with AI about it.</p>
            </div>
        `;
        
        // Clear chat messages
        chatMessages = [];
        
        // Remove selection from all alert items
        document.querySelectorAll('.alert-item').forEach(item => {
            item.classList.remove('selected');
        });
    }

    // Apply sorting to filtered alerts
    function applySorting() {
        if (!filteredAlerts || filteredAlerts.length === 0) return;
        
        switch (currentFilters.sortBy) {
            case 'timestamp_desc':
                filteredAlerts.sort((a, b) => {
                    const timeA = new Date(a.timestamp || a.time);
                    const timeB = new Date(b.timestamp || b.time);
                    return timeB - timeA;
                });
                break;
            case 'timestamp_asc':
                filteredAlerts.sort((a, b) => {
                    const timeA = new Date(a.timestamp || a.time);
                    const timeB = new Date(b.timestamp || b.time);
                    return timeA - timeB;
                });
                break;
            case 'priority_desc':
                const priorityOrder = { 'critical': 6, 'error': 5, 'warning': 4, 'notice': 3, 'info': 2, 'debug': 1 };
                filteredAlerts.sort((a, b) => {
                    const priorityA = priorityOrder[a.priority] || 0;
                    const priorityB = priorityOrder[b.priority] || 0;
                    return priorityB - priorityA;
                });
                break;
            case 'priority_asc':
                const priorityOrderAsc = { 'critical': 6, 'error': 5, 'warning': 4, 'notice': 3, 'info': 2, 'debug': 1 };
                filteredAlerts.sort((a, b) => {
                    const priorityA = priorityOrderAsc[a.priority] || 0;
                    const priorityB = priorityOrderAsc[b.priority] || 0;
                    return priorityA - priorityB;
                });
                break;
            case 'rule_asc':
                filteredAlerts.sort((a, b) => {
                    const ruleA = (a.rule || '').toLowerCase();
                    const ruleB = (b.rule || '').toLowerCase();
                    return ruleA.localeCompare(ruleB);
                });
                break;
            case 'rule_desc':
                filteredAlerts.sort((a, b) => {
                    const ruleA = (a.rule || '').toLowerCase();
                    const ruleB = (b.rule || '').toLowerCase();
                    return ruleB.localeCompare(ruleA);
                });
                break;
        }
    }

    // Update filter status indicator
    function updateFilterStatus() {
        const filterStatusEl = document.getElementById('filterStatus');
        if (!filterStatusEl) return;
        
        // Count active filters
        let activeFilters = 0;
        const filterLabels = [];
        
        if (currentFilters.timeRange !== 'all' && currentFilters.timeRange !== '24h') {
            activeFilters++;
            filterLabels.push(`Time: ${currentFilters.timeRange}`);
        }
        if (currentFilters.priority !== 'all') {
            activeFilters++;
            filterLabels.push(`Priority: ${currentFilters.priority}`);
        }
        if (currentFilters.status !== 'all') {
            activeFilters++;
            filterLabels.push(`Status: ${currentFilters.status}`);
        }
        if (currentFilters.rule) {
            activeFilters++;
            filterLabels.push(`Rule: ${currentFilters.rule}`);
        }
        if (currentFilters.container) {
            activeFilters++;
            filterLabels.push(`Container: ${currentFilters.container}`);
        }
        if (currentFilters.user) {
            activeFilters++;
            filterLabels.push(`User: ${currentFilters.user}`);
        }
        if (currentFilters.process) {
            activeFilters++;
            filterLabels.push(`Process: ${currentFilters.process}`);
        }
        if (currentFilters.command) {
            activeFilters++;
            filterLabels.push(`Command: ${currentFilters.command}`);
        }
        if (currentFilters.file) {
            activeFilters++;
            filterLabels.push(`File: ${currentFilters.file}`);
        }
        if (currentFilters.source) {
            activeFilters++;
            filterLabels.push(`Source: ${currentFilters.source}`);
        }
        if (currentFilters.k8s) {
            activeFilters++;
            filterLabels.push(`K8s: ${currentFilters.k8s}`);
        }
        if (currentFilters.output) {
            activeFilters++;
            filterLabels.push(`Content: ${currentFilters.output}`);
        }
        if (currentFilters.aiAnalysis !== 'all') {
            activeFilters++;
            filterLabels.push(`AI: ${currentFilters.aiAnalysis}`);
        }
        if (currentFilters.sortBy !== 'timestamp_desc') {
            activeFilters++;
            filterLabels.push(`Sort: ${currentFilters.sortBy}`);
        }
        
        // Update status display
        if (activeFilters === 0) {
            filterStatusEl.textContent = 'No filters active';
            filterStatusEl.className = 'filter-count';
        } else {
            filterStatusEl.textContent = `${activeFilters} filter${activeFilters > 1 ? 's' : ''} active`;
            filterStatusEl.className = 'filter-count active';
            filterStatusEl.title = filterLabels.join(', ');
        }
        
        // Update filter group styling
        updateFilterGroupStyling();
    }

    // Update filter group styling to show which have values
    function updateFilterGroupStyling() {
        const filterInputs = document.querySelectorAll('.filter-input, .filter-select');
        filterInputs.forEach(input => {
            const filterGroup = input.closest('.filter-group');
            if (input.value && input.value !== 'all' && input.value !== '24h' && input.value !== '25' && input.value !== 'timestamp_desc') {
                filterGroup.classList.add('has-value');
            } else {
                filterGroup.classList.remove('has-value');
            }
        });
    }

    // Save filter configuration
    function saveFilter() {
        const filterConfig = {
            name: prompt('Enter a name for this filter configuration:'),
            filters: { ...currentFilters },
            timestamp: Date.now()
        };
        
        if (!filterConfig.name) return;
        
        // Save to localStorage
        const savedFilters = JSON.parse(localStorage.getItem('falco_saved_filters') || '[]');
        savedFilters.push(filterConfig);
        localStorage.setItem('falco_saved_filters', JSON.stringify(savedFilters));
        
        showAlert('success', `Filter "${filterConfig.name}" saved successfully!`);
    }

    // Show alert function
    function showAlert(type, message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.style.maxWidth = '500px';
        
        alertDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Send test alert function
    async function sendTestAlert() {
        try {
            console.log('Sending test alert...');
            const response = await fetch('/api/test-alert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                showAlert('success', '✅ Test alert sent successfully! Refreshing alerts...');
                // Refresh alerts after a short delay
                setTimeout(() => {
                    loadAlerts();
                }, 2000);
            } else {
                const error = await response.text();
                showAlert('error', `❌ Failed to send test alert: ${error}`);
            }
        } catch (error) {
            console.error('Error sending test alert:', error);
            showAlert('error', `❌ Error sending test alert: ${error.message}`);
        }
    }
</script>
{% endblock %} 
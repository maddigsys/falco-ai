{% extends "settings_base.html" %}

{% block title %}Multi-Language Configuration{% endblock %}
{% block page_icon %}<i class="fas fa-globe"></i>{% endblock %}
{% block page_title %}Multi-Language Configuration{% endblock %}
{% block page_description %}Configure multilingual AI analysis, language preferences, and Babel LLM settings for global security monitoring{% endblock %}

{% block extra_css %}
<style>
    /* Master toggle styling */
    .master-toggle {
        background: var(--primary-10, rgba(0, 174, 199, 0.1));
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .master-toggle .form-check {
        margin: 0;
    }

    .master-toggle .form-check-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .disabled-section {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Provider Tabs similar to AI config */
    .provider-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding: 0.5rem;
        background: var(--bg-card);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }

    .provider-tab {
        flex: 1;
        background: transparent;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-sm);
        color: var(--text-light);
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .provider-tab:hover {
        background: rgba(0, 174, 199, 0.1);
        color: var(--primary-color);
        transform: translateY(-1px);
    }

    .provider-tab.active {
        background: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-md);
    }

    /* Language grid */
    .language-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .language-card {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }

    .language-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .language-card.active {
        border-color: var(--primary-color);
        background: rgba(0, 174, 199, 0.1);
    }

    .language-flag {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .language-name {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .language-speakers {
        font-size: 0.8rem;
        color: var(--text-light);
    }

    /* Status indicators */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .status-available {
        background: rgba(72, 187, 120, 0.1);
        color: #22543d;
        border: 1px solid #48bb78;
    }

    .status-unavailable {
        background: rgba(245, 101, 101, 0.1);
        color: #742a2a;
        border: 1px solid #f56565;
    }

    .status-downloading {
        background: rgba(66, 153, 225, 0.1);
        color: #2a4365;
        border: 1px solid #4299e1;
    }

    /* Model management */
    .model-info {
        background: rgba(0, 174, 199, 0.05);
        border: 1px solid rgba(0, 174, 199, 0.2);
        border-radius: var(--radius-sm);
        padding: 1rem;
        margin-top: 1rem;
    }

    .progress-container {
        margin-top: 1rem;
        display: none;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        background: var(--primary-gradient);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
        .language-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .provider-tabs {
            flex-direction: column;
        }
    }
    </style>
{% endblock %}

{% block content %}
<!-- Sticky Action Bar -->
<div class="sticky-action-bar">
    <div class="d-flex justify-content-between align-items-center">
        <div class="action-buttons">
            <button class="btn btn-primary btn-lg" onclick="saveAllConfig()">
                <i class="fas fa-save"></i>
                Save All Changes
            </button>
            <button class="btn btn-success" onclick="testBabelConnection()">
                <i class="fas fa-check-circle"></i>
                Test Babel LLM
            </button>
            <button class="btn btn-secondary" onclick="downloadBabelModel('babel-9b')">
                <i class="fas fa-download"></i>
                Download Model
            </button>
        </div>
        <div class="save-status" id="saveStatus">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Remember to save your changes
            </small>
        </div>
    </div>
</div>

<!-- Master Enable/Disable Toggle -->
<div class="master-toggle">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="enableMultilingual" checked onchange="toggleMultilingual()">
        <label class="form-check-label" for="enableMultilingual">
            <i class="fas fa-globe me-2"></i>
            <strong data-translate>Enable Multilingual Features</strong>
            <div class="text-muted small mt-1" data-translate>
                Turn off to save compute resources - system will use English-only AI analysis
            </div>
        </label>
    </div>
</div>

<div id="multilingualContent">
    <!-- System Status -->
    <div class="config-card">
        <div class="config-card-header">
                            <h3 class="config-card-title">
                    <i class="fas fa-chart-line"></i>
                    <span data-translate>System Status</span>
                    <span class="collapse-icon">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </h3>
        </div>
        <div class="config-card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="status-indicator" id="babelStatus">
                            <i class="fas fa-spinner fa-spin"></i>
                            Checking...
                        </div>
                        <div class="mt-2">
                            <strong>Babel LLM</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="status-indicator" id="languageCount">
                            <i class="fas fa-language"></i>
                            24 Languages
                        </div>
                        <div class="mt-2">
                            <strong>Supported</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="status-indicator" id="currentLanguage">
                            <i class="fas fa-flag"></i>
                            English
                        </div>
                        <div class="mt-2">
                            <strong>Current Language</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Tabs -->
    <div class="provider-tabs">
        <button class="provider-tab active" onclick="switchTab('general')">
            <i class="fas fa-cog"></i>
            <span data-translate>General Settings</span>
        </button>
        <button class="provider-tab" onclick="switchTab('babel')">
            <i class="fas fa-brain"></i>
            <span data-translate>Babel LLM</span>
        </button>
        <button class="provider-tab" onclick="switchTab('languages')">
            <i class="fas fa-language"></i>
            <span data-translate>Languages</span>
        </button>
        <button class="provider-tab" onclick="switchTab('models')">
            <i class="fas fa-download"></i>
            <span data-translate>Model Management</span>
        </button>
    </div>

    <!-- General Settings Tab -->
    <div id="general-tab" class="provider-config active">
        <div class="config-card">
            <div class="config-card-header">
                <h3 class="config-card-title">
                    <i class="fas fa-cog"></i>
                    General Language Settings
                </h3>
            </div>
            <div class="config-card-body">
                <form id="generalSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="defaultLanguage">
                                    <i class="fas fa-globe"></i>
                                    Default System Language
                                </label>
                                <select class="form-select" id="defaultLanguage" name="default_language">
                                    <option value="en" selected>ðŸ‡ºðŸ‡¸ English (Default)</option>
                                    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                                    <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                                    <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
                                    <option value="pt">ðŸ‡µðŸ‡¹ PortuguÃªs</option>
                                    <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                                    <!-- More options populated by JS -->
                                </select>
                                <div class="form-text">Default language for new users and fallback scenarios</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="autoDetectLanguage">
                                    <i class="fas fa-search"></i>
                                    Auto-Detect User Language
                                </label>
                                <select class="form-select" id="autoDetectLanguage" name="auto_detect_language">
                                    <option value="true" selected>Enabled - Use browser language preference</option>
                                    <option value="false">Disabled - Always use default language</option>
                                </select>
                                <div class="form-text">Automatically detect user's preferred language from browser</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="enableUITranslation">
                                    <i class="fas fa-language"></i>
                                    UI Translation Mode
                                </label>
                                <select class="form-select" id="enableUITranslation" name="enable_ui_translation">
                                    <option value="babel" selected>Babel LLM - Native AI translation</option>
                                    <option value="static">Static - Pre-defined translations only</option>
                                    <option value="disabled">Disabled - English only</option>
                                </select>
                                <div class="form-text">How to handle user interface translations</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="fallbackBehavior">
                                    <i class="fas fa-shield-alt"></i>
                                    Fallback Behavior
                                </label>
                                <select class="form-select" id="fallbackBehavior" name="fallback_behavior">
                                    <option value="english" selected>Fall back to English analysis</option>
                                    <option value="regular_ai">Use regular AI provider in English</option>
                                    <option value="error">Show error message</option>
                                </select>
                                <div class="form-text">What to do when multilingual analysis fails</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="persistLanguage" name="persist_language" checked>
                            <label class="form-check-label" for="persistLanguage">
                                <strong>Remember Language Preference</strong>
                            </label>
                            <div class="form-text">Store user's language choice in session/database</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="action-area">
                <button type="button" class="btn btn-primary" onclick="saveGeneralSettings()">
                    <i class="fas fa-save"></i>
                    Save General Settings
                </button>
            </div>
        </div>
    </div>

        <!-- Babel LLM Tab -->
        <div id="babel-tab" class="tab-content">
            <div class="config-card">
                <div class="config-section-title">
                    <i class="fas fa-brain"></i>
                    Babel LLM Configuration
                </div>
                <form id="babelSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="babelModel">Babel LLM Model</label>
                                <select class="form-select" id="babelModel" name="babel_model">
                                    <option value="babel-9b">babel-9b (Recommended - 9B parameters)</option>
                                    <option value="babel-83b">babel-83b (Advanced - 83B parameters)</option>
                                </select>
                                <small class="text-muted">babel-9b is faster, babel-83b is more accurate</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="babelTimeout">Request Timeout (seconds)</label>
                                <input type="number" class="form-control" id="babelTimeout" name="babel_timeout" value="60" min="10" max="300">
                                <small class="text-muted">Maximum time to wait for Babel LLM response</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="babelTemperature">Temperature</label>
                                <input type="range" class="form-range" id="babelTemperature" name="babel_temperature" value="0.7" min="0.1" max="1.0" step="0.1">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Conservative (0.1)</small>
                                    <small class="text-muted" id="temperatureValue">0.7</small>
                                    <small class="text-muted">Creative (1.0)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="babelMaxTokens">Max Tokens</label>
                                <input type="number" class="form-control" id="babelMaxTokens" name="babel_max_tokens" value="1000" min="100" max="4000">
                                <small class="text-muted">Maximum response length for security analysis</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="ollamaEndpoint">Ollama API Endpoint</label>
                        <input type="url" class="form-control" id="ollamaEndpoint" name="ollama_endpoint" value="http://ollama:11434">
                        <small class="text-muted">URL to your Ollama server (where Babel LLM runs)</small>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableBabelLLM" name="enable_babel_llm" checked>
                            <label class="form-check-label" for="enableBabelLLM">
                                <strong>Enable Babel LLM</strong>
                            </label>
                            <div class="text-muted">Use Babel LLM for multilingual AI analysis (requires model to be downloaded)</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Babel Settings
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testBabelConnection()">
                        <i class="fas fa-vial"></i>
                        Test Connection
                    </button>
                </form>
            </div>
        </div>

        <!-- Languages Tab -->
        <div id="languages-tab" class="tab-content">
            <div class="config-card">
                <div class="config-section-title">
                    <i class="fas fa-language"></i>
                    Supported Languages
                </div>
                <p class="text-muted mb-4">
                    Babel LLM supports 24 languages covering over 90% of global speakers. Select which languages to enable for your users.
                </p>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="selectAllLanguages()">
                        <i class="fas fa-check-double"></i>
                        Select All
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="selectNoneLanguages()">
                        <i class="fas fa-times"></i>
                        Select None
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="selectTopLanguages()">
                        <i class="fas fa-star"></i>
                        Top 10 Languages
                    </button>
                </div>

                <div class="language-grid" id="languageGrid">
                    <!-- Populated by JavaScript -->
                </div>

                <div class="mt-4">
                    <button type="button" class="btn btn-primary" onclick="saveLanguageSettings()">
                        <i class="fas fa-save"></i>
                        Save Language Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Model Management Tab -->
        <div id="models-tab" class="tab-content">
            <div class="config-card">
                <div class="config-section-title">
                    <i class="fas fa-download"></i>
                    Babel LLM Model Management
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Model Information:</strong> Babel LLM models are downloaded and stored locally via Ollama. This ensures privacy and eliminates API costs.
                </div>

                <div class="model-info">
                    <h5>Available Models</h5>
                    <div class="row" id="modelsContainer">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="mt-4">
                    <h5>Download Progress</h5>
                    <div id="downloadProgress" style="display: none;">
                        <div class="mb-2">
                            <span id="downloadStatus">Downloading babel-9b...</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="downloadProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="button" class="btn btn-primary" onclick="downloadBabelModel('babel-9b')">
                        <i class="fas fa-download"></i>
                        Download babel-9b (Recommended)
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="downloadBabelModel('babel-83b')">
                        <i class="fas fa-download"></i>
                        Download babel-83b (Advanced)
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="checkModelStatus()">
                        <i class="fas fa-sync"></i>
                        Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // Global state
    let languages = {};
    let enabledLanguages = new Set();
    let babelStatus = {};
    let currentConfig = {};
    let isMultilingualEnabled = true;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadConfiguration();
        checkBabelStatus();
        loadLanguages();
        setupEventListeners();
        
        // Check URL for initial language
        const urlParams = new URLSearchParams(window.location.search);
        const langParam = urlParams.get('lang');
        if (langParam) {
            setLanguage(langParam);
        }
    });

    // Master multilingual toggle
    function toggleMultilingual() {
        const enableCheckbox = document.getElementById('enableMultilingual');
        const content = document.getElementById('multilingualContent');
        isMultilingualEnabled = enableCheckbox.checked;
        
        if (isMultilingualEnabled) {
            content.classList.remove('disabled-section');
            showAlert('Multilingual features enabled', 'success');
        } else {
            content.classList.add('disabled-section');
            showAlert('Multilingual features disabled - system will use English-only analysis', 'warning');
        }
        
        // Save state
        updateMultilingualConfig('master_enabled', isMultilingualEnabled ? 'true' : 'false');
    }

    // Tab switching
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.provider-config').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.provider-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
        
        // Load specific content for the tab
        if (tabName === 'models') {
            refreshModelStatus();
        }
    }

    // Language switching with actual UI translation
    async function setLanguage(langCode) {
        if (!languages[langCode]) {
            console.warn('Language not supported:', langCode);
            return;
        }

        try {
            // Set language in session
            const response = await fetch(`/api/lang/${langCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.ok) {
                const result = await response.json();
                
                // Update current language display
                const currentLangEl = document.getElementById('currentLanguage');
                const langInfo = languages[langCode];
                if (currentLangEl && langInfo) {
                    currentLangEl.innerHTML = `<i class="fas fa-flag"></i> ${langInfo.flag} ${langInfo.name}`;
                    currentLangEl.className = 'status-indicator status-available';
                }

                // Translate UI elements if enabled
                if (isMultilingualEnabled && currentConfig.general_enable_ui_translation === 'babel') {
                    await translateUIElements(langCode);
                }

                showAlert(`Language changed to ${langInfo.name}`, 'success');
            }
        } catch (error) {
            console.error('Language switch error:', error);
            showAlert('Failed to change language', 'danger');
        }
    }

    // Translate UI elements
    async function translateUIElements(langCode) {
        if (langCode === 'en') return; // No translation needed for English

        const elementsToTranslate = [
            { selector: '[data-translate]', attribute: 'textContent' },
            { selector: '[data-translate-placeholder]', attribute: 'placeholder' },
            { selector: '[data-translate-title]', attribute: 'title' }
        ];

        for (const elementType of elementsToTranslate) {
            const elements = document.querySelectorAll(elementType.selector);
            
            for (const element of elements) {
                const originalText = element.getAttribute('data-original') || element[elementType.attribute];
                if (!element.getAttribute('data-original')) {
                    element.setAttribute('data-original', originalText);
                }

                try {
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: originalText,
                            language: langCode
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.translated !== originalText) {
                            element[elementType.attribute] = result.translated;
                        }
                    }
                } catch (error) {
                    console.error('Translation error for element:', error);
                }
            }
        }
    }

        // Load configuration
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/multilingual/config');
                if (response.ok) {
                    const config = await response.json();
                    populateConfigForm(config);
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
            }
        }

        // Check Babel LLM status
        async function checkBabelStatus() {
            try {
                const response = await fetch('/api/babel/status');
                if (response.ok) {
                    babelStatus = await response.json();
                    updateStatusIndicators();
                }
            } catch (error) {
                console.error('Error checking Babel status:', error);
                updateStatusIndicators(false);
            }
        }

        // Load languages
        async function loadLanguages() {
            try {
                const response = await fetch('/api/lang');
                if (response.ok) {
                    const data = await response.json();
                    languages = data.languages;
                    populateLanguageGrid();
                    populateLanguageSelects();
                }
            } catch (error) {
                console.error('Error loading languages:', error);
            }
        }

        // Update status indicators
        function updateStatusIndicators(available = null) {
            const babelStatusEl = document.getElementById('babelStatus');
            const currentLanguageEl = document.getElementById('currentLanguage');

            if (available === null) {
                available = babelStatus.available;
            }

            if (available) {
                babelStatusEl.innerHTML = '<i class="fas fa-check-circle"></i> Available';
                babelStatusEl.className = 'status-indicator status-available';
            } else {
                babelStatusEl.innerHTML = '<i class="fas fa-times-circle"></i> Unavailable';
                babelStatusEl.className = 'status-indicator status-unavailable';
            }

            // Update current language
            const currentLang = sessionStorage.getItem('currentLanguage') || 'en';
            const langInfo = languages[currentLang];
            if (langInfo) {
                currentLanguageEl.innerHTML = `<i class="fas fa-flag"></i> ${langInfo.flag} ${langInfo.name}`;
            }
        }

        // Populate language grid
        function populateLanguageGrid() {
            const grid = document.getElementById('languageGrid');
            grid.innerHTML = '';

            const languageData = {
                'en': { speakers: '1.5B', priority: 1 },
                'zh': { speakers: '1.4B', priority: 2 },
                'hi': { speakers: '700M', priority: 3 },
                'es': { speakers: '595M', priority: 4 },
                'ar': { speakers: '400M', priority: 5 },
                'fr': { speakers: '300M', priority: 6 },
                'bn': { speakers: '300M', priority: 7 },
                'pt': { speakers: '270M', priority: 8 },
                'ru': { speakers: '260M', priority: 9 },
                'ur': { speakers: '230M', priority: 10 },
                'id': { speakers: '200M', priority: 11 },
                'de': { speakers: '135M', priority: 12 },
                'ja': { speakers: '130M', priority: 13 },
                'sw': { speakers: '100M', priority: 14 },
                'tl': { speakers: '100M', priority: 15 },
                'ta': { speakers: '90M', priority: 16 },
                'vi': { speakers: '86M', priority: 17 },
                'tr': { speakers: '85M', priority: 18 },
                'it': { speakers: '85M', priority: 19 },
                'ko': { speakers: '80M', priority: 20 },
                'ha': { speakers: '80M', priority: 21 },
                'fa': { speakers: '80M', priority: 22 },
                'th': { speakers: '80M', priority: 23 },
                'my': { speakers: '50M', priority: 24 }
            };

            Object.entries(languages).forEach(([code, lang]) => {
                const data = languageData[code] || { speakers: 'N/A', priority: 99 };
                const card = document.createElement('div');
                card.className = 'language-card';
                card.dataset.lang = code;
                card.onclick = () => toggleLanguage(code);

                card.innerHTML = `
                    <div class="language-flag">${lang.flag}</div>
                    <div class="language-name">${lang.name}</div>
                    <div class="language-speakers">${data.speakers} speakers</div>
                `;

                grid.appendChild(card);

                // Enable by default for top 10 languages
                if (data.priority <= 10) {
                    enabledLanguages.add(code);
                    card.classList.add('active');
                }
            });
        }

        // Populate language selects
        function populateLanguageSelects() {
            const defaultLanguageSelect = document.getElementById('defaultLanguage');
            defaultLanguageSelect.innerHTML = '';

            Object.entries(languages).forEach(([code, lang]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${lang.flag} ${lang.name}`;
                defaultLanguageSelect.appendChild(option);
            });
        }

        // Toggle language selection
        function toggleLanguage(code) {
            const card = document.querySelector(`[data-lang="${code}"]`);
            if (enabledLanguages.has(code)) {
                enabledLanguages.delete(code);
                card.classList.remove('active');
            } else {
                enabledLanguages.add(code);
                card.classList.add('active');
            }
        }

        // Language selection helpers
        function selectAllLanguages() {
            enabledLanguages.clear();
            Object.keys(languages).forEach(code => {
                enabledLanguages.add(code);
                document.querySelector(`[data-lang="${code}"]`).classList.add('active');
            });
        }

        function selectNoneLanguages() {
            enabledLanguages.clear();
            document.querySelectorAll('.language-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        function selectTopLanguages() {
            selectNoneLanguages();
            const topLanguages = ['en', 'zh', 'hi', 'es', 'ar', 'fr', 'bn', 'pt', 'ru', 'ur'];
            topLanguages.forEach(code => {
                if (languages[code]) {
                    enabledLanguages.add(code);
                    document.querySelector(`[data-lang="${code}"]`).classList.add('active');
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Temperature slider
            const tempSlider = document.getElementById('babelTemperature');
            const tempValue = document.getElementById('temperatureValue');
            tempSlider.addEventListener('input', function() {
                tempValue.textContent = this.value;
            });

            // Form submissions
            document.getElementById('generalSettingsForm').addEventListener('submit', saveGeneralSettings);
            document.getElementById('babelSettingsForm').addEventListener('submit', saveBabelSettings);
        }

        // Save settings functions
        async function saveGeneralSettings(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/multilingual/config/general', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAlert('General settings saved successfully!', 'success');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                showAlert('Error saving general settings: ' + error.message, 'danger');
            }
        }

        async function saveBabelSettings(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/multilingual/config/babel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAlert('Babel LLM settings saved successfully!', 'success');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                showAlert('Error saving Babel settings: ' + error.message, 'danger');
            }
        }

        async function saveLanguageSettings() {
            try {
                const response = await fetch('/api/multilingual/config/languages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        enabled_languages: Array.from(enabledLanguages)
                    })
                });

                if (response.ok) {
                    showAlert('Language settings saved successfully!', 'success');
                } else {
                    throw new Error('Failed to save language settings');
                }
            } catch (error) {
                showAlert('Error saving language settings: ' + error.message, 'danger');
            }
        }

    // Enhanced model management functions
    async function downloadBabelModel(modelName) {
        const progressEl = document.getElementById('downloadProgress');
        const statusEl = document.getElementById('downloadStatus');
        const progressBar = document.getElementById('downloadProgressBar');

        progressEl.style.display = 'block';
        statusEl.textContent = `Downloading ${modelName}...`;
        progressBar.style.width = '0%';

        try {
            const response = await fetch('/api/babel/pull-model', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model_name: modelName})
            });

            if (response.ok) {
                const result = await response.json();
                
                // Show download initiated
                showAlert(`Download initiated for ${modelName}`, 'info');
                
                // Poll for progress
                pollDownloadProgress(modelName);
            } else {
                throw new Error('Failed to initiate model download');
            }
        } catch (error) {
            statusEl.textContent = 'Download failed: ' + error.message;
            progressBar.style.width = '0%';
            progressEl.style.display = 'none';
            showAlert('Error downloading model: ' + error.message, 'danger');
        }
    }

    async function pollDownloadProgress(modelName) {
        const progressEl = document.getElementById('downloadProgress');
        const statusEl = document.getElementById('downloadStatus');
        const progressBar = document.getElementById('downloadProgressBar');
        
        let attempts = 0;
        const maxAttempts = 60; // 5 minutes max
        
        const checkProgress = async () => {
            try {
                await refreshModelStatus();
                
                // Check if model is now available
                if (babelStatus.models && babelStatus.models.some(m => m.includes(modelName))) {
                    statusEl.textContent = `${modelName} downloaded successfully!`;
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressEl.style.display = 'none';
                    }, 2000);
                    showAlert(`${modelName} is now ready for use!`, 'success');
                    return;
                }
                
                attempts++;
                if (attempts < maxAttempts) {
                    // Update progress bar
                    const progress = Math.min((attempts / maxAttempts) * 100, 95);
                    progressBar.style.width = progress + '%';
                    statusEl.textContent = `Downloading ${modelName}... (${Math.round(progress)}%)`;
                    
                    setTimeout(checkProgress, 5000); // Check every 5 seconds
                } else {
                    statusEl.textContent = 'Download timeout - please check manually';
                    progressEl.style.display = 'none';
                    showAlert('Download may still be in progress - check model status', 'warning');
                }
            } catch (error) {
                console.error('Progress check error:', error);
                setTimeout(checkProgress, 5000);
            }
        };
        
        setTimeout(checkProgress, 2000); // Initial delay
    }

    async function refreshModelStatus() {
        try {
            const response = await fetch('/api/babel/status');
            if (response.ok) {
                babelStatus = await response.json();
                updateModelDisplay();
                updateStatusIndicators();
                return babelStatus;
            }
        } catch (error) {
            console.error('Error refreshing model status:', error);
        }
        return null;
    }

    function updateModelDisplay() {
        const modelsContainer = document.getElementById('modelsContainer');
        if (!modelsContainer) return;

        const availableModels = babelStatus.models || [];
        const modelData = [
            {
                name: 'babel-9b',
                title: 'Babel 9B (Recommended)',
                description: 'Fast and efficient - ideal for most use cases',
                size: '~5GB',
                performance: 'Fast',
                accuracy: 'Good'
            },
            {
                name: 'babel-83b',
                title: 'Babel 83B (Advanced)',
                description: 'Maximum accuracy - for demanding scenarios',
                size: '~50GB',
                performance: 'Slow',
                accuracy: 'Excellent'
            }
        ];

        modelsContainer.innerHTML = modelData.map(model => {
            const isDownloaded = availableModels.some(m => m.includes(model.name));
            const statusClass = isDownloaded ? 'status-available' : 'status-unavailable';
            const statusText = isDownloaded ? 'Downloaded' : 'Not Downloaded';
            const statusIcon = isDownloaded ? 'fas fa-check-circle' : 'fas fa-download';

            return `
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${model.title}</h5>
                            <p class="card-text">${model.description}</p>
                            <ul class="list-unstyled">
                                <li><strong>Size:</strong> ${model.size}</li>
                                <li><strong>Performance:</strong> ${model.performance}</li>
                                <li><strong>Accuracy:</strong> ${model.accuracy}</li>
                            </ul>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="status-indicator ${statusClass}">
                                    <i class="${statusIcon}"></i>
                                    ${statusText}
                                </span>
                                ${!isDownloaded ? `
                                    <button class="btn btn-primary btn-sm" onclick="downloadBabelModel('${model.name}')">
                                        <i class="fas fa-download"></i>
                                        Download
                                    </button>
                                ` : `
                                    <button class="btn btn-outline-secondary btn-sm" disabled>
                                        <i class="fas fa-check"></i>
                                        Ready
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

        // Test Babel connection
        async function testBabelConnection() {
            try {
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: 'Hello, this is a test.',
                        language: 'es'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('Babel LLM connection test successful!', 'success');
                } else {
                    throw new Error('Connection test failed');
                }
            } catch (error) {
                showAlert('Babel LLM connection test failed: ' + error.message, 'danger');
            }
        }

    // Save functions
    async function saveAllConfig() {
        const saveBtn = document.querySelector('button[onclick="saveAllConfig()"]');
        const originalText = saveBtn.innerHTML;
        
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;

        try {
            await Promise.all([
                saveGeneralSettings(),
                saveBabelSettings(),
                saveLanguageSettings()
            ]);
            
            showAlert('All settings saved successfully!', 'success');
            document.getElementById('saveStatus').innerHTML = '<small class="text-success"><i class="fas fa-check-circle"></i> All changes saved</small>';
        } catch (error) {
            showAlert('Error saving some settings: ' + error.message, 'danger');
        } finally {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }

    async function saveGeneralSettings() {
        const form = document.getElementById('generalSettingsForm');
        const formData = new FormData(form);
        const settings = Object.fromEntries(formData);

        const response = await fetch('/api/multilingual/config/general', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });

        if (!response.ok) {
            throw new Error('Failed to save general settings');
        }
    }

    async function saveBabelSettings() {
        const form = document.getElementById('babelSettingsForm');
        if (!form) return; // Form might not be loaded yet
        
        const formData = new FormData(form);
        const settings = Object.fromEntries(formData);

        const response = await fetch('/api/multilingual/config/babel', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });

        if (!response.ok) {
            throw new Error('Failed to save Babel settings');
        }
    }

    async function saveLanguageSettings() {
        const response = await fetch('/api/multilingual/config/languages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                enabled_languages: Array.from(enabledLanguages)
            })
        });

        if (!response.ok) {
            throw new Error('Failed to save language settings');
        }
    }

    // Helper function to update individual config
    async function updateMultilingualConfig(key, value) {
        try {
            await fetch('/api/multilingual/config/general', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({[key]: value})
            });
        } catch (error) {
            console.error('Config update error:', error);
        }
    }

    // Utility functions
    function showAlert(message, type) {
        // Remove existing alerts
        document.querySelectorAll('.alert.temp-alert').forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show temp-alert`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function populateConfigForm(config) {
        currentConfig = config;
        
        // Populate form fields
        Object.entries(config).forEach(([key, value]) => {
            const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = value === true || value === 'true';
                } else {
                    element.value = value;
                }
            }
        });

        // Set master toggle
        const masterEnabled = config.master_enabled !== 'false';
        document.getElementById('enableMultilingual').checked = masterEnabled;
        isMultilingualEnabled = masterEnabled;
        
        if (!masterEnabled) {
            document.getElementById('multilingualContent').classList.add('disabled-section');
        }
    }
</script>
{% endblock %} 
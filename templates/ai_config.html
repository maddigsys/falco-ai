{% extends "falco_base.html" %}

{% block title %}AI Configuration{% endblock %}
{% block page_icon %}<i class="fas fa-robot"></i>{% endblock %}
{% block page_title %}AI Configuration{% endblock %}
{% block page_description %}Configure AI providers for security analysis with enterprise-grade security and intelligent threat detection{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced AI config styling */
    .sticky-action-bar {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--primary);
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
        position: sticky;
        top: var(--space-md);
        z-index: 100;
        transition: all 0.3s ease;
    }

    .action-buttons {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
        align-items: center;
    }

    .save-status {
        font-weight: 500;
        white-space: nowrap;
        font-size: var(--text-sm);
    }

    .save-needed {
        color: var(--warning) !important;
        animation: pulse 2s infinite;
    }

    .save-complete {
        color: var(--success) !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Provider Tabs Styling */
    .provider-tabs {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-xl);
        padding: var(--space-sm);
        background: var(--bg-card);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
    }

    .provider-tab {
        flex: 1;
        background: transparent;
        border: none;
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        font-size: var(--text-sm);
    }

    .provider-tab:hover {
        background: rgba(0, 174, 199, 0.1);
        color: var(--falco-primary);
        transform: translateY(-1px);
    }

    .provider-tab.active {
        background: var(--primary-gradient);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .provider-tab i {
        font-size: 1.1rem;
    }

    /* Provider Config Sections */
    .provider-config {
        display: none;
        margin-top: var(--space-xl);
    }

    .provider-config.active {
        display: block;
    }

    /* Config Info Boxes */
    .config-info {
        background: linear-gradient(135deg, rgba(0, 174, 199, 0.05), rgba(0, 174, 199, 0.02));
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-xl);
        border-left: 4px solid var(--falco-primary);
        border: 1px solid var(--border-light);
    }

    .config-info strong {
        color: var(--falco-primary);
        font-weight: 600;
    }

    .portkey-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.02));
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--info);
        margin-bottom: var(--space-xl);
        border: 1px solid var(--border-light);
    }

    .portkey-info strong {
        color: var(--info);
        font-weight: 600;
    }

    /* Model Suggestion Chips */
    .model-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        margin-top: var(--space-sm);
    }

    .model-chip {
        background: var(--falco-white);
        border: 1px solid var(--border-light);
        color: var(--text-primary);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        box-shadow: var(--shadow-xs);
        font-weight: 500;
    }

    .model-chip:hover {
        background: rgba(0, 174, 199, 0.1);
        border-color: var(--falco-primary);
        color: var(--falco-primary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .model-chip.downloaded {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success);
        color: var(--success);
    }

    .model-chip.downloaded:before {
        content: "✓";
        font-weight: bold;
    }

    /* Progress Container */
    .progress-container {
        display: none;
        margin-top: var(--space-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-light);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .progress-bar {
        height: 2rem;
        background: var(--primary-gradient);
        color: white;
        text-align: center;
        line-height: 2rem;
        font-weight: 600;
        font-size: var(--text-sm);
        transition: width 0.3s ease;
        width: 0%;
    }

    /* Model Status */
    .model-status {
        display: flex;
        align-items: center;
        gap: var(--space-lg);
        margin-top: var(--space-lg);
        padding: var(--space-md);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
    }

    .status-text {
        flex: 1;
        font-weight: 500;
        font-size: var(--text-sm);
    }

    .status-text.downloaded {
        color: var(--success);
    }

    .status-text.downloading {
        color: var(--warning);
    }

    .status-text.not-available {
        color: var(--danger);
    }

    /* Connection Status */
    .connection-status {
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-xl);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-weight: 500;
        box-shadow: var(--shadow-sm);
        border: 1px solid;
    }

    .connection-status.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-color: var(--success);
    }

    .connection-status.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border-color: var(--danger);
    }

    .connection-status.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border-color: var(--warning);
    }

    /* Response Preview */
    .response-preview {
        background: var(--falco-white);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-xl);
        min-height: 200px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: var(--text-sm);
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: var(--shadow-sm);
        margin-top: 0;
    }

    .preview-header {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
    }

    /* Form styling improvements */
    .form-group {
        margin-bottom: var(--space-xl);
    }

    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .form-label i {
        color: var(--falco-primary);
        width: 1.2em;
        text-align: center;
    }

    .form-control, .form-select {
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        font-size: var(--text-sm);
        transition: all 0.2s ease;
        background: var(--bg-cards);
        color: var(--text-heading);
        box-shadow: var(--shadow-xs);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--falco-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .form-text {
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-top: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .form-text i {
        color: var(--falco-primary);
        opacity: 0.7;
    }

    .form-check {
        margin-bottom: var(--space-lg);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin: 0;
        border: 2px solid var(--border-light);
        border-radius: var(--radius-sm);
        background: var(--bg-cards);
        transition: all 0.2s ease;
    }

    .form-check-input:checked {
        background: var(--falco-primary);
        border-color: var(--falco-primary);
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .form-check-label {
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        cursor: pointer;
        margin: 0;
    }

    /* Row spacing */
    .row {
        margin-bottom: var(--space-lg);
    }

    .row:last-child {
        margin-bottom: 0;
    }

    /* Button spacing */
    .btn {
        margin-top: var(--space-md);
        margin-right: var(--space-sm);
    }

    .d-flex.gap-2 .btn {
        margin-top: 0;
        margin-right: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .sticky-action-bar {
            position: relative;
            margin: var(--space-md) 0;
            padding: var(--space-lg);
        }

        .action-buttons {
            flex-direction: column;
            gap: var(--space-sm);
            width: 100%;
        }

        .action-buttons .btn {
            width: 100%;
            justify-content: center;
        }

        .provider-tabs {
            flex-direction: column;
        }

        .provider-tab {
            text-align: center;
        }

        .model-suggestions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Sticky Action Bar -->
<div class="sticky-action-bar">
    <div class="d-flex justify-content-between align-items-center">
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveConfig()">
                <i class="fas fa-save"></i>
                Save All Changes
            </button>
            <button class="btn btn-success" onclick="testConnection()">
                <i class="fas fa-check-circle"></i>
                Test Connection
            </button>
            <button class="btn btn-secondary" onclick="generateSample()">
                <i class="fas fa-magic"></i>
                Generate Sample
            </button>
        </div>
        <div class="save-status" id="saveStatus">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Remember to save your changes
            </small>
        </div>
    </div>
</div>

<!-- Connection Status -->
<div id="connectionStatus"></div>

<!-- Current Status Summary -->
<div class="falco-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-info-circle"></i>
            Current Status Summary
        </h3>
    </div>
    <div class="card-body">
        <div id="statusInfo">
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin"></i>
                Loading status...
            </div>
        </div>
    </div>
</div>

<!-- General AI Configuration -->
<div class="falco-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-cogs"></i>
            General AI Settings
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="enabled" name="enabled">
                        <label class="form-check-label" for="enabled">
                            <i class="fas fa-robot"></i>
                            Enable AI Analysis
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Enable AI-powered security analysis for alerts
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="provider_name" class="form-label">
                        <i class="fas fa-server"></i>
                        AI Provider
                    </label>
                    <select class="form-select" id="provider_name" name="provider_name">
                        <option value="ollama">Ollama (Local)</option>
                        <option value="openai">OpenAI (via Portkey)</option>
                        <option value="gemini">Gemini (via Portkey)</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Select your preferred AI provider
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="temperature" class="form-label">
                        <i class="fas fa-thermometer-half"></i>
                        Temperature (0.0-1.0)
                    </label>
                    <input type="number" class="form-control" id="temperature" name="temperature" min="0.0" max="1.0" step="0.1" value="0.7">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Controls randomness in AI responses (0.0 = deterministic, 1.0 = creative)
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="max_tokens" class="form-label">
                        <i class="fas fa-layer-group"></i>
                        Max Tokens
                    </label>
                    <input type="number" class="form-control" id="max_tokens" name="max_tokens" min="100" max="4000" value="1000">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum tokens for AI responses
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="model_name" class="form-label">
                        <i class="fas fa-brain"></i>
                        Current Model
                    </label>
                    <input type="text" class="form-control" id="model_name" name="model_name" readonly>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Currently configured model (set via provider tabs)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="system_prompt" class="form-label">
                        <i class="fas fa-terminal"></i>
                        System Prompt (Optional)
                    </label>
                    <textarea class="form-control" id="system_prompt" name="system_prompt" rows="4" placeholder="Leave empty to use default system prompt for security analysis..."></textarea>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Custom system prompt for AI analysis. Leave empty to use the default optimized prompt.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portkey Security Layer Configuration -->
<div class="falco-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-shield-alt"></i>
            Portkey Security Layer
        </h3>
    </div>
    <div class="card-body">
        <div class="portkey-info">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Enterprise Security Gateway:</strong> Portkey acts as a security layer for all cloud AI providers (OpenAI, Gemini), 
                providing enterprise-grade logging, monitoring, rate limiting, and content filtering for all AI interactions.
                <br><br>
                <strong>Benefits:</strong>
                <ul class="mb-0 mt-2">
                    <li>🔒 Centralized security and access control</li>
                    <li>📊 Comprehensive logging and analytics</li>
                    <li>🚦 Rate limiting and cost management</li>
                    <li>🛡️ Content filtering and safety checks</li>
                    <li>🔄 Unified interface for multiple AI providers</li>
                </ul>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="portkey_api_key" class="form-label">
                        <i class="fas fa-key"></i>
                        Portkey API Key
                    </label>
                    <input type="password" class="form-control" id="portkey_api_key" name="portkey_api_key" placeholder="pk-...">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Your Portkey API key. Get it from <a href="https://portkey.ai" target="_blank">portkey.ai</a>
                    </div>
                </div>
            </div>
        </div>
        

        
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Setup Required:</strong> To use cloud AI providers (OpenAI, Gemini) through Portkey:
            <ol class="mb-0 mt-2">
                <li>Sign up at <a href="https://portkey.ai" target="_blank">portkey.ai</a></li>
                <li>Get your Portkey API key from the dashboard</li>
                <li>Configure your Portkey API key above</li>
                <li>Configure individual AI providers in the provider tabs below</li>
            </ol>
        </div>
    </div>
</div>

<!-- Provider Selection Tabs -->
<div class="provider-tabs">
    <button class="provider-tab active" onclick="showProvider('openai')" data-provider="openai">
        <i class="fab fa-openai"></i>
        OpenAI
    </button>

    <button class="provider-tab" onclick="showProvider('ollama')" data-provider="ollama">
        <i class="fas fa-server"></i>
        Ollama
    </button>
    <button class="provider-tab" onclick="showProvider('gemini')" data-provider="gemini">
        <i class="fab fa-google"></i>
        Gemini
    </button>
</div>

<!-- OpenAI Configuration -->
<div id="openai-config" class="provider-config falco-card active">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fab fa-openai"></i>
            OpenAI Configuration
        </h3>
    </div>
    <div class="card-body">
        <div class="config-info">
            <strong>OpenAI Integration:</strong> Configure OpenAI's GPT models for advanced security analysis with enterprise-grade API access.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="openai_virtual_key" class="form-label">
                        <i class="fas fa-key"></i>
                        Virtual Key (Portkey)
                    </label>
                    <input type="password" class="form-control" id="openai_virtual_key" name="openai_virtual_key" placeholder="openai_...">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Your OpenAI virtual key from Portkey
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="openai_model_name" class="form-label">
                        <i class="fas fa-brain"></i>
                        Model
                    </label>
                    <select class="form-select" id="openai_model_name" name="openai_model_name">
                        <option value="gpt-4">GPT-4 (Recommended)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Select the OpenAI model for analysis
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="openai_timeout" class="form-label">
                        <i class="fas fa-clock"></i>
                        Request Timeout (seconds)
                    </label>
                    <input type="number" class="form-control" id="openai_timeout" name="openai_timeout" min="5" max="120" value="30">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum time to wait for OpenAI response
                    </div>
                </div>
            </div>
        </div>
        
        <div class="model-suggestions">
            <div class="model-chip" onclick="selectModel('openai_model_name', 'gpt-4')">GPT-4</div>
            <div class="model-chip" onclick="selectModel('openai_model_name', 'gpt-4-turbo')">GPT-4 Turbo</div>
            <div class="model-chip" onclick="selectModel('openai_model_name', 'gpt-3.5-turbo')">GPT-3.5 Turbo</div>
        </div>
        
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-success" onclick="testProvider('openai')">
                <i class="fas fa-check-circle"></i>
                Test OpenAI
            </button>
        </div>
        
        <div class="response-preview" id="openai-preview" style="display: none;">
            <div class="preview-header">OpenAI Response Preview:</div>
            <div id="openai-preview-content"></div>
        </div>
    </div>
</div>



<!-- Ollama Configuration -->
<div id="ollama-config" class="provider-config falco-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-server"></i>
            Ollama Configuration
        </h3>
    </div>
    <div class="card-body">
        <div class="config-info">
            <strong>Ollama Local Models:</strong> Configure local AI models running on Ollama for privacy-focused analysis.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="ollama_api_url" class="form-label">
                        <i class="fas fa-link"></i>
                        Ollama API URL
                    </label>
                    <input type="url" class="form-control" id="ollama_api_url" name="ollama_api_url" value="http://ollama:11434/api/generate" placeholder="http://localhost:11434/api/generate">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Full API URL of your Ollama installation
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="ollama_model_name" class="form-label">
                        <i class="fas fa-brain"></i>
                        Model
                    </label>
                    <select class="form-select" id="ollama_model_name" name="ollama_model_name">
                        <option value="tinyllama">TinyLlama (Fast)</option>
                        <option value="qwen2:7b">Qwen2 7B (Recommended)</option>
                        <option value="llama3:latest">Llama3 Latest</option>
                        <option value="mistral:latest">Mistral Latest</option>
                        <option value="codellama:latest">CodeLlama Latest</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Select the Ollama model for analysis
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="ollama_timeout" class="form-label">
                        <i class="fas fa-clock"></i>
                        Request Timeout (seconds)
                    </label>
                    <input type="number" class="form-control" id="ollama_timeout" name="ollama_timeout" min="10" max="300" value="30">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum time to wait for Ollama response
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="ollama_keep_alive" class="form-label">
                        <i class="fas fa-memory"></i>
                        Keep Alive (minutes)
                    </label>
                    <input type="number" class="form-control" id="ollama_keep_alive" name="ollama_keep_alive" min="1" max="60" value="10">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        How long to keep model loaded in memory
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="ollama_parallel" class="form-label">
                        <i class="fas fa-layer-group"></i>
                        Parallel Requests
                    </label>
                    <input type="number" class="form-control" id="ollama_parallel" name="ollama_parallel" min="1" max="10" value="1">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Number of concurrent requests to process
                    </div>
                </div>
            </div>
        </div>
        
        <div class="model-suggestions">
            <div class="model-chip" onclick="selectModel('ollama_model_name', 'tinyllama')">TinyLlama</div>
            <div class="model-chip" onclick="selectModel('ollama_model_name', 'qwen2:7b')">Qwen2 7B</div>
            <div class="model-chip" onclick="selectModel('ollama_model_name', 'llama3:latest')">Llama3</div>
            <div class="model-chip" onclick="selectModel('ollama_model_name', 'mistral:latest')">Mistral</div>
        </div>
        
        <div class="model-status" id="ollama-status">
            <div class="status-text">Model status will be displayed here</div>
        </div>
        
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-warning" onclick="downloadModel('ollama')">
                <i class="fas fa-download"></i>
                Download Model
            </button>
            <button class="btn btn-success" onclick="testProvider('ollama')">
                <i class="fas fa-check-circle"></i>
                Test Ollama
            </button>
        </div>
        
        <div class="progress-container" id="ollama-progress">
            <div class="progress-bar" id="ollama-progress-bar">0%</div>
        </div>
        
        <div class="response-preview" id="ollama-preview" style="display: none;">
            <div class="preview-header">Ollama Response Preview:</div>
            <div id="ollama-preview-content"></div>
        </div>
    </div>
</div>

<!-- Gemini Configuration -->
<div id="gemini-config" class="provider-config falco-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fab fa-google"></i>
            Gemini Configuration
        </h3>
    </div>
    <div class="card-body">
        <div class="config-info">
            <strong>Google Gemini:</strong> Configure Google's Gemini models for advanced multimodal security analysis.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="gemini_virtual_key" class="form-label">
                        <i class="fas fa-key"></i>
                        Virtual Key (Portkey)
                    </label>
                    <input type="password" class="form-control" id="gemini_virtual_key" name="gemini_virtual_key" placeholder="gemini_...">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Your Gemini virtual key from Portkey
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="gemini_model_name" class="form-label">
                        <i class="fas fa-brain"></i>
                        Model
                    </label>
                    <select class="form-select" id="gemini_model_name" name="gemini_model_name">
                        <option value="gemini-pro">Gemini Pro</option>
                        <option value="gemini-pro-vision">Gemini Pro Vision</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Select the Gemini model for analysis
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="gemini_timeout" class="form-label">
                        <i class="fas fa-clock"></i>
                        Request Timeout (seconds)
                    </label>
                    <input type="number" class="form-control" id="gemini_timeout" name="gemini_timeout" min="5" max="120" value="30">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum time to wait for Gemini response
                    </div>
                </div>
            </div>
        </div>
        
        <div class="model-suggestions">
            <div class="model-chip" onclick="selectModel('gemini_model_name', 'gemini-pro')">Gemini Pro</div>
            <div class="model-chip" onclick="selectModel('gemini_model_name', 'gemini-1.5-flash')">Gemini 1.5 Flash</div>
            <div class="model-chip" onclick="selectModel('gemini_model_name', 'gemini-1.5-pro')">Gemini 1.5 Pro</div>
        </div>
        
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-success" onclick="testProvider('gemini')">
                <i class="fas fa-check-circle"></i>
                Test Gemini
            </button>
        </div>
        
        <div class="response-preview" id="gemini-preview" style="display: none;">
            <div class="preview-header">Gemini Response Preview:</div>
            <div id="gemini-preview-content"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // AI Configuration management JavaScript
    let currentProvider = 'openai';
    let configData = {};
    let hasUnsavedChanges = false;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentConfiguration();
        setupFormListeners();
        updateStatusInfo();
        setInterval(updateStatusInfo, 30000); // Update every 30 seconds
    });

    // Load current configuration
    async function loadCurrentConfiguration() {
        try {
            const response = await fetch('/api/ai/config');
            if (response.ok) {
                configData = await response.json();
                populateForm(configData);
            } else {
                throw new Error('Failed to load configuration');
            }
        } catch (error) {
            console.error('Error loading configuration:', error);
            showConnectionStatus('error', 'Failed to load configuration');
        }
    }

    // Populate form with configuration data
    function populateForm(config) {
        Object.keys(config).forEach(key => {
            const element = document.getElementById(key);
            if (element && config[key]) {
                const value = config[key].value || config[key]; // Handle both nested and flat structures
                if (element.type === 'checkbox') {
                    element.checked = value === 'true' || value === true;
                } else {
                    element.value = value;
                }
            }
        });
    }

    // Setup form change listeners
    function setupFormListeners() {
        const formElements = document.querySelectorAll('input, select, textarea');
        formElements.forEach(element => {
            element.addEventListener('change', function() {
                hasUnsavedChanges = true;
                updateSaveStatus();
            });
        });
    }

    // Update status info
    async function updateStatusInfo() {
        try {
            const response = await fetch('/api/ai/config');
            if (response.ok) {
                const status = await response.json();
                displayStatusInfo(status);
            }
        } catch (error) {
            console.error('Error loading status:', error);
        }
    }

    // Display status information
    function displayStatusInfo(config) {
        const statusDiv = document.getElementById('statusInfo');
        if (statusDiv && config) {
            const isEnabled = config.enabled?.value === 'true';
            const activeProvider = config.provider_name?.value || 'Not set';
            const portkeyConfigured = config.portkey_api_key?.value ? true : false;
            
            statusDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="alert alert-${isEnabled ? 'success' : 'warning'}">
                            <i class="fas fa-robot"></i>
                            <strong>AI Status</strong><br>
                            ${isEnabled ? 'Enabled' : 'Disabled'}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="alert alert-info">
                            <i class="fas fa-brain"></i>
                            <strong>Active Provider</strong><br>
                            ${activeProvider}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="alert alert-${portkeyConfigured ? 'success' : 'warning'}">
                            <i class="fas fa-shield-alt"></i>
                            <strong>Portkey Security</strong><br>
                            ${portkeyConfigured ? 'Configured' : 'Not configured'}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="alert alert-info">
                            <i class="fas fa-cogs"></i>
                            <strong>Max Tokens</strong><br>
                            ${config.max_tokens?.value || '500'}
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Show provider configuration
    function showProvider(provider) {
        // Hide all provider configs
        document.querySelectorAll('.provider-config').forEach(config => {
            config.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.provider-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected provider config
        document.getElementById(provider + '-config').classList.add('active');
        
        // Add active class to selected tab
        document.querySelector(`[data-provider="${provider}"]`).classList.add('active');
        
        currentProvider = provider;
    }

    // Select model
    function selectModel(fieldName, model) {
        const modelSelect = document.getElementById(fieldName);
        if (modelSelect) {
            modelSelect.value = model;
            hasUnsavedChanges = true;
            updateSaveStatus();
        }
    }

    // Test provider connection
    async function testProvider(provider) {
        try {
            const config = getCurrentProviderConfig(provider);
            
            // Add provider name to the config data for the API
            config.provider_name = provider;
            
            const response = await fetch('/api/ai/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });

            if (response.ok) {
                const result = await response.json();
                showConnectionStatus('success', `${provider.toUpperCase()} connection successful`);
                displayTestResult(provider, result);
            } else {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `${provider.toUpperCase()} test failed`);
            }
        } catch (error) {
            console.error(`Error testing ${provider}:`, error);
            showConnectionStatus('error', error.message || `${provider.toUpperCase()} test failed`);
        }
    }

    // Get current provider configuration
    function getCurrentProviderConfig(provider) {
        const config = {};
        const elements = document.querySelectorAll(`#${provider}-config input, #${provider}-config select`);
        elements.forEach(element => {
            if (element.type === 'checkbox') {
                config[element.name || element.id] = element.checked;
            } else {
                config[element.name || element.id] = element.value;
            }
        });
        return config;
    }

    // Display test result
    function displayTestResult(provider, result) {
        const previewDiv = document.getElementById(provider + '-preview');
        const contentDiv = document.getElementById(provider + '-preview-content');
        
        if (previewDiv && contentDiv) {
            contentDiv.textContent = result.response || 'Test successful';
            previewDiv.style.display = 'block';
        }
    }

    // Download model (for Ollama)
    async function downloadModel(provider) {
        if (provider !== 'ollama') return;
        
        const model = document.getElementById('ollama_model_name').value;
        const progressContainer = document.getElementById('ollama-progress');
        const progressBar = document.getElementById('ollama-progress-bar');
        
        progressContainer.style.display = 'block';
        
        try {
            const response = await fetch('/api/ollama/pull', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ model: model })
            });

            if (response.ok) {
                // Monitor download progress
                monitorDownloadProgress(model);
            } else {
                throw new Error('Failed to start download');
            }
        } catch (error) {
            console.error('Error downloading model:', error);
            showConnectionStatus('error', 'Failed to download model');
            progressContainer.style.display = 'none';
        }
    }

    // Monitor download progress
    async function monitorDownloadProgress(model) {
        const progressBar = document.getElementById('ollama-progress-bar');
        const statusText = document.querySelector('#ollama-status .status-text');
        
        const checkProgress = setInterval(async () => {
            try {
                const response = await fetch(`/api/ollama/status/${model}`);
                if (response.ok) {
                    const status = await response.json();
                    
                    if (status.progress) {
                        progressBar.style.width = status.progress + '%';
                        progressBar.textContent = status.progress + '%';
                    }
                    
                    if (status.status) {
                        statusText.textContent = status.status;
                        statusText.className = 'status-text ' + (status.completed ? 'downloaded' : 'downloading');
                    }
                    
                    if (status.completed) {
                        clearInterval(checkProgress);
                        document.getElementById('ollama-progress').style.display = 'none';
                        showConnectionStatus('success', 'Model downloaded successfully');
                    }
                }
            } catch (error) {
                clearInterval(checkProgress);
                console.error('Error checking progress:', error);
            }
        }, 2000);
    }

    // Save configuration
    async function saveConfig() {
        try {
            const allConfig = {};
            
            // Collect all form fields from all sections
            const allElements = document.querySelectorAll('input, select, textarea');
            allElements.forEach(element => {
                if (element.name || element.id) {
                    const fieldName = element.name || element.id;
                    if (element.type === 'checkbox') {
                        allConfig[fieldName] = element.checked ? 'true' : 'false';
                    } else if (element.value) {
                        allConfig[fieldName] = element.value;
                    }
                }
            });

            const response = await fetch('/api/ai/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(allConfig)
            });

            if (response.ok) {
                hasUnsavedChanges = false;
                configData = allConfig;
                showConnectionStatus('success', 'AI configuration saved successfully');
                updateSaveStatus();
                updateStatusInfo();
            } else {
                throw new Error('Failed to save configuration');
            }
        } catch (error) {
            console.error('Error saving configuration:', error);
            showConnectionStatus('error', 'Failed to save configuration');
        }
    }

    // Test connection
    async function testConnection() {
        await testProvider(currentProvider);
    }

    // Generate sample
    async function generateSample() {
        try {
            const response = await fetch('/api/ai/generate-sample', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ provider: currentProvider })
            });

            if (response.ok) {
                const result = await response.json();
                displayTestResult(currentProvider, result);
                showConnectionStatus('success', 'Sample generated successfully');
            } else {
                throw new Error('Failed to generate sample');
            }
        } catch (error) {
            console.error('Error generating sample:', error);
            showConnectionStatus('error', 'Failed to generate sample');
        }
    }

    // Show connection status
    function showConnectionStatus(type, message) {
        const statusDiv = document.getElementById('connectionStatus');
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="connection-status ${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (statusDiv.innerHTML.includes(message)) {
                    statusDiv.innerHTML = '';
                }
            }, 5000);
        }
    }

    // Update save status
    function updateSaveStatus() {
        const saveStatus = document.getElementById('saveStatus');
        if (saveStatus) {
            if (hasUnsavedChanges) {
                saveStatus.innerHTML = `
                    <small class="save-needed">
                        <i class="fas fa-exclamation-triangle"></i>
                        You have unsaved changes
                    </small>
                `;
            } else {
                saveStatus.innerHTML = `
                    <small class="save-complete">
                        <i class="fas fa-check-circle"></i>
                        All changes saved
                    </small>
                `;
            }
        }
    }

    // Prevent leaving page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>
{% endblock %}



{% extends "falco_base.html" %}

{% block title %}General Configuration{% endblock %}
{% block page_icon %}<i class="fas fa-cogs"></i>{% endblock %}
{% block page_title %}General Configuration{% endblock %}
{% block page_description %}Configure core system settings, alert processing, and data management for your Falco AI security platform{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced styling for config page */
    .sticky-action-bar {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--primary);
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
        position: sticky;
        top: 10px;
        z-index: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    /* Enhanced sticky behavior when scrolled */
    .sticky-action-bar.scrolled {
        top: 5px;
        padding: var(--space-lg) var(--space-xl);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary);
        background: rgba(var(--bg-cards-rgb, 255, 255, 255), 0.95);
    }

    /* Dark mode backdrop support */
    @media (prefers-color-scheme: dark) {
        .sticky-action-bar {
            background: rgba(var(--bg-cards-rgb, 33, 37, 41), 0.95);
        }
    }

    [data-bs-theme="dark"] .sticky-action-bar,
    .dark .sticky-action-bar {
        background: rgba(var(--bg-cards-rgb, 33, 37, 41), 0.95);
    }

    /* Fix button styling consistency */
    .action-buttons .btn-primary {
        background: var(--primary-gradient) !important;
        color: var(--text-inverse) !important;
        border: none !important;
    }

    .action-buttons .btn-success {
        background: var(--success-gradient) !important;
        color: var(--text-inverse) !important;
        border: none !important;
    }

    .action-buttons .btn-warning {
        background: var(--warning-gradient) !important;
        color: var(--text-inverse) !important;
        border: none !important;
    }

    .action-buttons .btn-secondary {
        background: linear-gradient(135deg, var(--gray-500), var(--gray-600)) !important;
        color: var(--text-inverse) !important;
        border: none !important;
    }

    .action-buttons {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
        align-items: center;
        transition: all 0.3s ease;
    }

    /* Compact action buttons when scrolled */
    .sticky-action-bar.scrolled .action-buttons {
        gap: var(--space-sm);
    }



    .save-status {
        font-weight: 500;
        white-space: nowrap;
        font-size: var(--text-sm);
    }

    .save-needed {
        color: var(--warning) !important;
        animation: pulse 2s infinite;
    }

    .save-complete {
        color: var(--success) !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Connection Status */
    .connection-status {
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-xl);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-weight: 500;
        box-shadow: var(--shadow-sm);
        border: 1px solid;
    }

    .connection-status.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-color: var(--success);
    }

    /* Summary Cards Styling - Button-like appearance */
    .summary-card {
        border-radius: var(--radius-lg);
        border: 2px solid transparent;
        margin-bottom: var(--space-lg);
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: var(--shadow-sm);
        cursor: pointer;
        user-select: none;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .summary-card:active {
        transform: translateY(0);
        transition: transform 0.1s ease;
    }

    /* Active cards - Primary button style */
    .summary-card.card-active {
        background: var(--bs-primary, var(--primary));
        border-color: var(--bs-primary, var(--primary));
        color: white;
    }

    .summary-card.card-active .summary-header,
    .summary-card.card-active .summary-header i,
    .summary-card.card-active .summary-header h6 {
        color: white;
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .summary-card.card-active .summary-item .label,
    .summary-card.card-active .summary-item .value {
        color: rgba(255, 255, 255, 0.9);
    }

    .summary-card.card-active .summary-item {
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* Inactive cards - Muted/danger style */
    .summary-card.card-inactive {
        background: var(--bs-secondary, #6c757d);
        border-color: var(--bs-secondary, #6c757d);
        color: white;
        opacity: 0.8;
    }

    .summary-card.card-inactive .summary-header,
    .summary-card.card-inactive .summary-header i,
    .summary-card.card-inactive .summary-header h6 {
        color: white;
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .summary-card.card-inactive .summary-item .label,
    .summary-card.card-inactive .summary-item .value {
        color: rgba(255, 255, 255, 0.8);
    }

    .summary-card.card-inactive .summary-item {
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* Dark mode adjustments */
    @media (prefers-color-scheme: dark) {
        .summary-card.card-active {
            background: var(--bs-primary, #0d6efd);
            border-color: var(--bs-primary, #0d6efd);
        }
        
        .summary-card.card-inactive {
            background: var(--bs-danger, #dc3545);
            border-color: var(--bs-danger, #dc3545);
        }
    }

    /* CSS custom property fallbacks for better theme support */
    :root {
        --summary-primary: var(--bs-primary, var(--primary, #0d6efd));
        --summary-secondary: var(--bs-secondary, var(--secondary, #6c757d));
        --summary-danger: var(--bs-danger, var(--danger, #dc3545));
    }

    [data-bs-theme="dark"] .summary-card.card-inactive,
    .dark .summary-card.card-inactive {
        background: var(--summary-danger);
        border-color: var(--summary-danger);
    }

    .summary-header {
        padding: var(--space-lg) var(--space-lg) var(--space-md) var(--space-lg);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        position: relative;
    }

    .summary-arrow {
        margin-left: auto;
        font-size: 0.85rem;
        opacity: 0.7;
        transition: all 0.3s ease;
    }

    .summary-card:hover .summary-arrow {
        opacity: 1;
        transform: translateX(3px);
    }

    .summary-header i {
        font-size: 1.2rem;
    }

    .summary-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .summary-content {
        padding: var(--space-lg);
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        min-height: 32px;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-item .label {
        font-weight: 500;
        font-size: 0.85rem;
        text-align: left;
        flex: 1;
    }

    .summary-item .value {
        font-weight: 600;
        font-size: 0.85rem;
        text-align: right;
        flex: 0 0 auto;
        max-width: 60%;
        word-wrap: break-word;
    }

    .summary-item .value .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .summary-item .value .badge i {
        font-size: 0.7rem;
        margin-right: 2px;
    }

    /* Section highlight effect */
    .section-highlight {
        animation: highlightPulse 2s ease-out;
    }

    @keyframes highlightPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb, 13, 110, 253), 0.4);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb, 13, 110, 253), 0.1);
            transform: scale(1.01);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb, 13, 110, 253), 0);
            transform: scale(1);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .summary-item {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-xs);
        }
        
        .summary-item .label,
        .summary-item .value {
            text-align: left;
            max-width: 100%;
        }
    }

    .connection-status.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border-color: var(--danger);
    }

    .connection-status.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border-color: var(--warning);
    }

    .connection-status.info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
        border-color: var(--info);
    }

    /* Config Info Boxes */
    .config-info {
        background: linear-gradient(135deg, rgba(0, 174, 199, 0.05), rgba(0, 174, 199, 0.02));
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-xl);
        border-left: 4px solid var(--falco-primary);
        border: 1px solid var(--border-light);
    }

    .config-info strong {
        color: var(--falco-primary);
        font-weight: 600;
    }

    /* Form styling improvements */
    .form-group {
        margin-bottom: var(--space-xl);
    }

    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .form-label i {
        color: var(--falco-primary);
        width: 1.2em;
        text-align: center;
    }

    .form-control, .form-select {
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        font-size: var(--text-sm);
        transition: all 0.2s ease;
        background: var(--bg-cards);
        color: var(--text-heading);
        box-shadow: var(--shadow-xs);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--falco-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .form-text {
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-top: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .form-text i {
        color: var(--falco-primary);
        opacity: 0.7;
    }

    .form-check {
        margin-bottom: var(--space-lg);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin: 0;
        border: 2px solid var(--border-light);
        border-radius: var(--radius-sm);
        background: var(--bg-cards);
        transition: all 0.2s ease;
    }

    .form-check-input:checked {
        background: var(--falco-primary);
        border-color: var(--falco-primary);
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .form-check-label {
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        cursor: pointer;
        margin: 0;
    }

    .form-check-label i {
        color: var(--falco-primary);
        width: 1.2em;
        text-align: center;
    }

    /* Alert styling */
    .alert {
        border-radius: var(--radius-md);
        border: 1px solid;
        padding: var(--space-lg);
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-color: var(--success);
    }

    .alert-danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border-color: var(--danger);
    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border-color: var(--warning);
    }

    .alert-info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
        border-color: var(--info);
    }

    .alert i {
        font-size: var(--text-lg);
        opacity: 0.8;
    }

    /* Row spacing */
    .row {
        margin-bottom: var(--space-lg);
    }

    .row:last-child {
        margin-bottom: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .sticky-action-bar {
            position: relative;
            margin: var(--space-md) 0;
            padding: var(--space-lg);
        }

        .action-buttons {
            flex-direction: column;
            gap: var(--space-sm);
            width: 100%;
        }

        .action-buttons .btn {
            width: 100%;
            justify-content: center;
        }

        .save-status {
            text-align: center;
            margin-top: var(--space-md);
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Sticky Action Bar -->
<div class="sticky-action-bar">
    <div class="d-flex justify-content-between align-items-center">
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveConfiguration()">
                <i class="fas fa-save"></i>
                Save All Changes
            </button>
            <button class="btn btn-success" onclick="testConfiguration()">
                <i class="fas fa-check-circle"></i>
                Test Configuration
            </button>
            <button class="btn btn-warning" onclick="resetConfiguration()">
                <i class="fas fa-undo"></i>
                Reset to Defaults
            </button>
            <button class="btn btn-secondary" onclick="exportConfiguration()">
                <i class="fas fa-download"></i>
                Export Settings
            </button>
        </div>
        <div class="save-status" id="saveStatus">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Remember to save your changes
            </small>
        </div>
    </div>
</div>

<!-- Connection Status -->
<div id="connectionStatus"></div>

<!-- Configuration Summary Card -->
<div class="falco-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-info-circle"></i>
            Current Configuration Summary
        </h3>
    </div>
    <div class="card-body">
        <div id="config-summary" class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading configuration summary...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Form -->
<form id="generalConfigForm">

<!-- Alert Processing Configuration -->
<div class="falco-card" id="alert-processing">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-filter"></i>
            Alert Processing
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="min_priority" class="form-label">
                        <i class="fas fa-exclamation-triangle"></i>
                        Minimum Priority Level
                    </label>
                    <select class="form-select" id="min_priority" name="min_priority">
                        <option value="emergency">Emergency</option>
                        <option value="alert">Alert</option>
                        <option value="critical">Critical</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="notice">Notice</option>
                        <option value="informational">Informational</option>
                        <option value="debug">Debug</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Alerts below this priority level will be automatically ignored
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="ignore_older_minutes" class="form-label">
                        <i class="fas fa-clock"></i>
                        Age Filter (Minutes)
                    </label>
                    <input type="number" class="form-control" id="ignore_older_minutes" name="ignore_older_minutes" min="0" max="1440">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Ignore alerts older than this many minutes (0 to disable)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="deduplication_enabled" name="deduplication_enabled">
                        <label class="form-check-label" for="deduplication_enabled">
                            <i class="fas fa-copy"></i>
                            Enable Alert Deduplication
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Prevent duplicate alerts from being processed multiple times
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="deduplication_window_minutes" class="form-label">
                        <i class="fas fa-window-maximize"></i>
                        Deduplication Window (Minutes)
                    </label>
                    <input type="number" class="form-control" id="deduplication_window_minutes" name="deduplication_window_minutes" min="1" max="1440">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        How long to remember and block duplicate alerts
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="rate_limit_enabled" class="form-label">
                        <i class="fas fa-tachometer-alt"></i>
                        Rate Limiting
                    </label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="rate_limit_enabled" name="rate_limit_enabled">
                        <label class="form-check-label" for="rate_limit_enabled">
                            Enable Alert Rate Limiting
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Limit the number of alerts processed per minute to prevent overload
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="max_alerts_per_minute" class="form-label">
                        <i class="fas fa-stopwatch"></i>
                        Max Alerts Per Minute
                    </label>
                    <input type="number" class="form-control" id="max_alerts_per_minute" name="max_alerts_per_minute" min="1" max="1000" value="60">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum number of alerts to process per minute (1-1000)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="batch_processing_enabled" class="form-label">
                        <i class="fas fa-layer-group"></i>
                        Batch Processing
                    </label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="batch_processing_enabled" name="batch_processing_enabled">
                        <label class="form-check-label" for="batch_processing_enabled">
                            Enable Alert Batching
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Group multiple alerts together for more efficient processing
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="batch_size" class="form-label">
                        <i class="fas fa-boxes"></i>
                        Batch Size
                    </label>
                    <input type="number" class="form-control" id="batch_size" name="batch_size" min="2" max="50" value="10">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Number of alerts to group together in each batch (2-50)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="alert_correlation_enabled" class="form-label">
                        <i class="fas fa-project-diagram"></i>
                        Alert Correlation
                    </label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="alert_correlation_enabled" name="alert_correlation_enabled">
                        <label class="form-check-label" for="alert_correlation_enabled">
                            Enable Alert Correlation
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Automatically link related alerts from the same source or incident
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="correlation_window_minutes" class="form-label">
                        <i class="fas fa-clock"></i>
                        Correlation Window (Minutes)
                    </label>
                    <input type="number" class="form-control" id="correlation_window_minutes" name="correlation_window_minutes" min="1" max="1440" value="15">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Time window to look for related alerts (1-1440 minutes)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Configuration -->
<div class="falco-card" id="system-config">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-server"></i>
            System Settings
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="log_level" class="form-label">
                        <i class="fas fa-list-alt"></i>
                        System Log Level
                    </label>
                    <select class="form-select" id="log_level" name="log_level">
                        <option value="DEBUG">Debug (Most Verbose)</option>
                        <option value="INFO">Info (Normal)</option>
                        <option value="WARNING">Warning (Important Only)</option>
                        <option value="ERROR">Error (Problems Only)</option>
                        <option value="CRITICAL">Critical (Severe Issues)</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Controls how much detail appears in system logs
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="web_ui_enabled" name="web_ui_enabled">
                        <label class="form-check-label" for="web_ui_enabled">
                            <i class="fas fa-desktop"></i>
                            Enable Web Dashboard
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Enable or disable the web-based dashboard interface
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="web_ui_port" class="form-label">
                        <i class="fas fa-plug"></i>
                        Dashboard Port
                    </label>
                    <input type="number" class="form-control" id="web_ui_port" name="web_ui_port" min="1" max="65535">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Port number for the web dashboard (requires restart)
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="falco_ai_port" class="form-label">
                        <i class="fas fa-network-wired"></i>
                        Webhook Port
                    </label>
                    <input type="number" class="form-control" id="falco_ai_port" name="falco_ai_port" min="1" max="65535">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Port for receiving Falco webhook events (requires restart)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Management -->
<div class="falco-card" id="data-management">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-database"></i>
            Data Management
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="max_alerts_storage" class="form-label">
                        <i class="fas fa-archive"></i>
                        Maximum Stored Alerts
                    </label>
                    <input type="number" class="form-control" id="max_alerts_storage" name="max_alerts_storage" min="100" max="100000">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum number of alerts to keep in the database
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="alert_retention_days" class="form-label">
                        <i class="fas fa-calendar-alt"></i>
                        Alert Retention (Days)
                    </label>
                    <input type="number" class="form-control" id="alert_retention_days" name="alert_retention_days" min="1" max="3650">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        How many days to keep alerts before automatic deletion
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="auto_cleanup_enabled" name="auto_cleanup_enabled">
                        <label class="form-check-label" for="auto_cleanup_enabled">
                            <i class="fas fa-broom"></i>
                            Enable Automatic Cleanup
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Automatically delete old alerts based on retention settings
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="cleanup_schedule" class="form-label">
                        <i class="fas fa-clock"></i>
                        Cleanup Schedule
                    </label>
                    <select class="form-select" id="cleanup_schedule" name="cleanup_schedule">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        How often to run the automatic cleanup process
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Tuning -->
<div class="falco-card" id="advanced-features">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-tachometer-alt"></i>
            Performance Tuning
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="worker_processes" class="form-label">
                        <i class="fas fa-cogs"></i>
                        Worker Processes
                    </label>
                    <input type="number" class="form-control" id="worker_processes" name="worker_processes" min="1" max="16" value="4">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Number of worker processes for handling alerts (1-16)
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="max_memory_usage" class="form-label">
                        <i class="fas fa-memory"></i>
                        Max Memory Usage (MB)
                    </label>
                    <input type="number" class="form-control" id="max_memory_usage" name="max_memory_usage" min="512" max="8192" value="2048">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum memory the system can use (512-8192 MB)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="cache_enabled" name="cache_enabled">
                        <label class="form-check-label" for="cache_enabled">
                            <i class="fas fa-layer-group"></i>
                            Enable Caching
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Enable in-memory caching for better performance
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="cache_size_mb" class="form-label">
                        <i class="fas fa-hdd"></i>
                        Cache Size (MB)
                    </label>
                    <input type="number" class="form-control" id="cache_size_mb" name="cache_size_mb" min="64" max="2048" value="256">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Maximum size of the cache in megabytes (64-2048 MB)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</form>
{% endblock %}

{% block extra_js %}
<script>
    // Configuration management JavaScript
    let configData = {};
    let hasUnsavedChanges = false;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentConfiguration();
        setupFormListeners();
        setupAutoSave();
        setupStickyActionBar();
    });

    // Load current configuration
    async function loadCurrentConfiguration() {
        try {
            const response = await fetch('/api/general/config');
            if (response.ok) {
                configData = await response.json();
                populateForm(configData);
                updateConfigSummary();
            } else {
                throw new Error('Failed to load configuration');
            }
        } catch (error) {
            console.error('Error loading configuration:', error);
            showConnectionStatus('error', 'Failed to load configuration');
        }
    }

    // Populate form with configuration data
    function populateForm(config) {
        Object.keys(config).forEach(key => {
            const element = document.getElementById(key);
            if (element && config[key]) {
                const value = config[key].value || config[key];
                if (element.type === 'checkbox') {
                    element.checked = value === 'true' || value === true;
                } else {
                    element.value = value;
                }
            }
        });
    }

    // Update configuration summary
    function updateConfigSummary() {
        const summaryDiv = document.getElementById('config-summary');
        if (summaryDiv && configData) {
            // Extract values from the nested config structure
            const getValue = (key) => configData[key]?.value || 'Not set';
            const getBoolValue = (key) => configData[key]?.value === 'true';
            const formatBool = (isEnabled) => isEnabled ? 
                '<span class="badge bg-success"><i class="fas fa-check"></i> Enabled</span>' : 
                '<span class="badge bg-secondary"><i class="fas fa-times"></i> Disabled</span>';
            
            // Determine card status based on key features
            const alertProcessingActive = getBoolValue('deduplication_enabled') || getBoolValue('rate_limit_enabled');
            const systemActive = getBoolValue('web_ui_enabled');
            const dataManagementActive = getValue('max_alerts_storage') !== 'Not set';
            const advancedActive = getBoolValue('batch_processing_enabled') || getBoolValue('alert_correlation_enabled');
            
            summaryDiv.innerHTML = `
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-card ${alertProcessingActive ? 'card-active' : 'card-inactive'}" onclick="scrollToSection('alert-processing')" role="button" tabindex="0">
                        <div class="summary-header">
                            <i class="fas fa-filter"></i>
                            <h6>Alert Processing</h6>
                            <i class="fas fa-chevron-right summary-arrow"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-item">
                                <span class="label">Min Priority:</span>
                                <span class="value text-capitalize">${getValue('min_priority')}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Rate Limiting:</span>
                                <span class="value">${formatBool(getBoolValue('rate_limit_enabled'))}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Deduplication:</span>
                                <span class="value">${formatBool(getBoolValue('deduplication_enabled'))}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-card ${systemActive ? 'card-active' : 'card-inactive'}" onclick="scrollToSection('system-config')" role="button" tabindex="0">
                        <div class="summary-header">
                            <i class="fas fa-server"></i>
                            <h6>System</h6>
                            <i class="fas fa-chevron-right summary-arrow"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-item">
                                <span class="label">Log Level:</span>
                                <span class="value">${getValue('log_level')}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Web UI:</span>
                                <span class="value">${formatBool(getBoolValue('web_ui_enabled'))}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Webhook Port:</span>
                                <span class="value">${getValue('falco_ai_port')}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-card ${dataManagementActive ? 'card-active' : 'card-inactive'}" onclick="scrollToSection('data-management')" role="button" tabindex="0">
                        <div class="summary-header">
                            <i class="fas fa-database"></i>
                            <h6>Data Management</h6>
                            <i class="fas fa-chevron-right summary-arrow"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-item">
                                <span class="label">Max Alerts:</span>
                                <span class="value">${getValue('max_alerts_storage')}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Retention:</span>
                                <span class="value">${getValue('alert_retention_days')} days</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Ignore Older:</span>
                                <span class="value">${getValue('ignore_older_minutes')} min</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="summary-card ${advancedActive ? 'card-active' : 'card-inactive'}" onclick="scrollToSection('advanced-features')" role="button" tabindex="0">
                        <div class="summary-header">
                            <i class="fas fa-cogs"></i>
                            <h6>Advanced Features</h6>
                            <i class="fas fa-chevron-right summary-arrow"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-item">
                                <span class="label">Batch Processing:</span>
                                <span class="value">${formatBool(getBoolValue('batch_processing_enabled'))}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Alert Correlation:</span>
                                <span class="value">${formatBool(getBoolValue('alert_correlation_enabled'))}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Batch Size:</span>
                                <span class="value">${getValue('batch_size')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Setup form change listeners
    function setupFormListeners() {
        const formElements = document.querySelectorAll('input, select, textarea');
        formElements.forEach(element => {
            element.addEventListener('change', function() {
                hasUnsavedChanges = true;
                updateSaveStatus();
            });
        });
    }

    // Setup auto-save functionality
    function setupAutoSave() {
        setInterval(function() {
            if (hasUnsavedChanges) {
                saveConfiguration(true); // Silent save
            }
        }, 30000); // Auto-save every 30 seconds
    }

    // Save configuration
    async function saveConfiguration(silent = false) {
        try {
            const form = document.getElementById('generalConfigForm');
            const formData = new FormData(form);
            const config = {};
            
            // Collect all form data
            const formElements = document.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                if (element.type === 'checkbox') {
                    config[element.name || element.id] = element.checked;
                } else if (element.name || element.id) {
                    config[element.name || element.id] = element.value;
                }
            });

            const response = await fetch('/api/general/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });

            if (response.ok) {
                hasUnsavedChanges = false;
                // Update configData to match the response structure
                Object.keys(config).forEach(key => {
                    if (!configData[key]) configData[key] = {};
                    configData[key].value = config[key];
                });
                updateConfigSummary();
                if (!silent) {
                    showConnectionStatus('success', 'Configuration saved successfully');
                }
                updateSaveStatus();
            } else {
                throw new Error('Failed to save configuration');
            }
        } catch (error) {
            console.error('Error saving configuration:', error);
            showConnectionStatus('error', 'Failed to save configuration');
        }
    }

    // Test configuration
    async function testConfiguration() {
        try {
            // Collect current form data for testing
            const config = {};
            const formElements = document.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                if (element.type === 'checkbox') {
                    config[element.name || element.id] = element.checked;
                } else if (element.name || element.id) {
                    config[element.name || element.id] = element.value;
                }
            });

            const response = await fetch('/api/general/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success !== false) {
                    showConnectionStatus('success', 'Configuration test passed - All settings are valid');
                } else {
                    showConnectionStatus('error', `Configuration test failed: ${result.message}`);
                }
            } else {
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'Configuration test failed');
            }
        } catch (error) {
            console.error('Error testing configuration:', error);
            showConnectionStatus('error', error.message || 'Configuration test failed');
        }
    }

    // Reset configuration
    async function resetConfiguration() {
        if (confirm('Are you sure you want to reset all settings to their defaults? This action cannot be undone.')) {
            try {
                const response = await fetch('/api/general/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    location.reload(); // Reload page to show reset values
                } else {
                    throw new Error('Failed to reset configuration');
                }
            } catch (error) {
                console.error('Error resetting configuration:', error);
                showConnectionStatus('error', 'Failed to reset configuration');
            }
        }
    }

    // Export configuration
    async function exportConfiguration() {
        try {
            const response = await fetch('/api/export');
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'falco-ai-config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showConnectionStatus('success', 'Configuration exported successfully');
            } else {
                throw new Error('Failed to export configuration');
            }
        } catch (error) {
            console.error('Error exporting configuration:', error);
            showConnectionStatus('error', 'Failed to export configuration');
        }
    }

    // Show connection status
    function showConnectionStatus(type, message) {
        const statusDiv = document.getElementById('connectionStatus');
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="connection-status ${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (statusDiv.innerHTML.includes(message)) {
                    statusDiv.innerHTML = '';
                }
            }, 5000);
        }
    }

    // Update save status
    function updateSaveStatus() {
        const saveStatus = document.getElementById('saveStatus');
        if (saveStatus) {
            if (hasUnsavedChanges) {
                saveStatus.innerHTML = `
                    <small class="save-needed">
                        <i class="fas fa-exclamation-triangle"></i>
                        You have unsaved changes
                    </small>
                `;
            } else {
                saveStatus.innerHTML = `
                    <small class="save-complete">
                        <i class="fas fa-check-circle"></i>
                        All changes saved
                    </small>
                `;
            }
        }
    }

    // Prevent leaving page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Smooth scroll to configuration section
    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            // Calculate offset to account for sticky header/navbar
            const offset = 100; // Adjust this value based on your header height
            const elementPosition = section.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });

            // Add a subtle highlight effect to the target section
            section.classList.add('section-highlight');
            setTimeout(() => {
                section.classList.remove('section-highlight');
            }, 2000);
        }
    }

    // Keyboard accessibility for summary cards
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('summary-card') && (e.key === 'Enter' || e.key === ' ')) {
            e.preventDefault();
            e.target.click();
        }
    });

    // Enhanced sticky action bar behavior
    function setupStickyActionBar() {
        const actionBar = document.querySelector('.sticky-action-bar');
        const configSummary = document.getElementById('config-summary');
        let isScrolled = false;

        if (!actionBar) return;

        function updateStickyBar() {
            const scrollY = window.scrollY;
            const summaryBottom = configSummary ? configSummary.getBoundingClientRect().bottom + window.scrollY : 200;
            
            // Add scrolled class when user scrolls past the configuration summary
            if (scrollY > summaryBottom && !isScrolled) {
                isScrolled = true;
                actionBar.classList.add('scrolled');
                
                // Show a subtle indicator that settings can be saved
                if (hasUnsavedChanges) {
                    actionBar.style.borderTopColor = 'var(--warning)';
                }
            } else if (scrollY <= summaryBottom && isScrolled) {
                isScrolled = false;
                actionBar.classList.remove('scrolled');
                actionBar.style.borderTopColor = 'var(--primary)';
            }
        }

        // Throttled scroll listener for better performance
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(updateStickyBar, 10);
        });

        // Update on resize
        window.addEventListener('resize', updateStickyBar);
    }
</script>
{% endblock %} 
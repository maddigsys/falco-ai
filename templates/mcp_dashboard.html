{% extends "falco_base.html" %}

{% block title %}MCP Dashboard{% endblock %}
{% block page_icon %}<i class="fas fa-plug"></i>{% endblock %}
{% block page_title %}MCP Dashboard{% endblock %}
{% block page_description %}Model Context Protocol management and monitoring with real-time status and tools{% endblock %}

{% block extra_css %}
<style>
    /* MCP Dashboard Layout - Based on Runtime Events */
    .mcp-container {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-xl);
        min-height: calc(100vh - 140px);
        height: auto;
        transition: all 0.3s ease;
    }

    .mcp-container.with-sidebar {
        grid-template-columns: 3fr 2fr;
    }

    .mcp-main {
        display: flex;
        flex-direction: column;
        overflow: visible;
        height: auto;
    }

    .mcp-sidebar {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--accent);
        box-shadow: var(--shadow-lg);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease;
        min-width: 400px;
        max-width: none;
        height: auto;
        max-height: 80vh;
    }

    .mcp-sidebar.active {
        display: flex;
    }
    
    .detail-header {
        padding: var(--space-md);
        border-bottom: 2px solid var(--border-light);
        background: var(--bg-cards);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .detail-title {
        margin: 0;
        color: var(--text-heading);
        font-size: var(--text-base);
        font-weight: 600;
    }
    
    .detail-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-lg);
        cursor: pointer;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }
    
    .detail-close:hover {
        background: var(--bg-secondary);
        color: var(--text-heading);
    }
    
    .detail-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-md);
        background: var(--bg-cards);
        max-height: calc(80vh - 80px);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* MCP Status Cards */
    .mcp-status-card {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        padding: 0;
        margin-bottom: var(--space-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--primary);
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        flex-shrink: 0;
        flex: none;
        overflow: hidden;
    }

    .mcp-status-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-md) var(--space-lg);
        background: var(--bg-cards);
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .mcp-status-header:hover {
        background: var(--bg-secondary);
    }

    .mcp-status-title {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .mcp-status-title i {
        color: var(--primary);
    }

    .mcp-status-toggle {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-base);
        cursor: pointer;
        transition: all 0.2s ease;
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
    }

    .mcp-status-toggle:hover {
        color: var(--primary);
        background: var(--bg-secondary);
    }

    .mcp-status-toggle i {
        transition: transform 0.3s ease;
    }

    .mcp-status-toggle.collapsed i {
        transform: rotate(-90deg);
    }

    .mcp-status-content {
        padding: var(--space-lg);
        transition: all 0.3s ease;
        max-height: 1000px;
        overflow: hidden;
    }

    .mcp-status-content.collapsed {
        max-height: 0;
        padding: 0 var(--space-lg);
    }

    /* MCP Configuration Styles */
    .mcp-config-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .mcp-config-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .mcp-config-label {
        font-weight: 600;
        color: var(--text-heading);
        font-size: var(--text-sm);
        margin: 0;
    }

    .mcp-config-input,
    .mcp-config-select {
        padding: var(--space-sm);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        background: var(--bg-cards);
        color: var(--text-heading);
        font-size: var(--text-sm);
        transition: all 0.2s ease;
        font-family: inherit;
    }

    .mcp-config-input:focus,
    .mcp-config-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 174, 199, 0.1);
    }

    .mcp-config-input::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
    }

    .mcp-config-actions {
        display: flex;
        gap: var(--space-sm);
        justify-content: flex-end;
    }

    .btn-mcp-config {
        background: var(--primary-gradient);
        color: var(--text-inverse);
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .btn-mcp-config:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-mcp-config.secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid var(--border-light);
    }

    .btn-mcp-config.secondary:hover {
        color: var(--primary);
        border-color: var(--primary);
    }

    /* Quick Stats */
    .mcp-stats-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        flex-shrink: 0;
        flex: none;
    }

    .mcp-stat-item {
        background: var(--bg-cards);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        border: 2px solid var(--border-light);
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .mcp-stat-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        background: rgba(0, 174, 199, 0.05);
    }
    
    .mcp-stat-item:active {
        transform: translateY(0);
        box-shadow: var(--shadow-md);
    }
    
    .mcp-stat-item.active {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-md);
    }
    
    .mcp-stat-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
    }

    .mcp-stat-number {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--text-heading);
        margin-bottom: var(--space-xs);
        transition: all 0.2s ease;
    }

    .mcp-stat-label {
        font-size: var(--text-xs);
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .mcp-stat-item.success .mcp-stat-number { color: #10b981; }
    .mcp-stat-item.warning .mcp-stat-number { color: #f59e0b; }
    .mcp-stat-item.info .mcp-stat-number { color: #0ea5e9; }
    .mcp-stat-item.danger .mcp-stat-number { color: #ef4444; }
    
    .mcp-stat-item:hover .mcp-stat-number {
        color: var(--primary);
        transform: scale(1.05);
    }
    
    .mcp-stat-item:hover .mcp-stat-label {
        color: var(--text-heading);
    }
    
    .mcp-stat-item.active .mcp-stat-number {
        color: var(--primary);
    }
    
    .mcp-stat-item.active .mcp-stat-label {
        color: var(--primary);
        font-weight: 600;
    }

    /* MCP Tools List */
    .mcp-tools-container {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--accent);
        box-shadow: var(--shadow-lg);
        overflow: visible;
        flex: none;
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: auto;
    }

    .mcp-tools-header {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-cards);
        flex-shrink: 0;
    }

    .mcp-tools-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .mcp-tools-title i {
        color: var(--accent);
    }

    .mcp-tools-count {
        background: var(--primary);
        color: var(--text-inverse);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: 600;
    }

    .mcp-tools-controls {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }

    .mcp-tools-body {
        flex: 1;
        overflow: visible;
        padding: var(--space-lg);
        height: auto;
        min-height: auto;
    }

    .mcp-tool-item {
        background: var(--bg-secondary);
        border: 2px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        width: 100%;
        box-sizing: border-box;
        min-height: 120px;
    }

    .mcp-tool-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
        background: rgba(0, 174, 199, 0.05);
        transform: translateX(2px);
    }

    .mcp-tool-item:last-child {
        margin-bottom: 0;
    }

    .mcp-tool-item.selected {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.1);
        box-shadow: var(--shadow-md);
    }

    .mcp-tool-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-xs);
    }

    .mcp-tool-name {
        font-weight: 600;
        color: var(--text-heading);
        flex: 1;
        font-size: var(--text-base);
        line-height: 1.4;
    }

    .mcp-tool-status {
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        margin-left: var(--space-sm);
        flex-shrink: 0;
    }

    .status-available { background: #10b981; color: white; }
    .status-unavailable { background: #6b7280; color: white; }
    .status-error { background: #ef4444; color: white; }

    .mcp-tool-description {
        color: var(--text-secondary);
        font-size: var(--text-sm);
        margin-bottom: var(--space-sm);
        line-height: 1.5;
        margin-top: var(--space-sm);
    }

    .mcp-tool-actions {
        display: flex;
        gap: var(--space-sm);
        margin-top: var(--space-md);
        justify-content: flex-end;
    }

    .btn-mcp-tool {
        background: var(--primary-gradient);
        color: var(--text-inverse);
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        min-width: 80px;
        justify-content: center;
    }

    .btn-mcp-tool:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-mcp-tool.secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-light);
    }

    .btn-mcp-tool.secondary:hover {
        color: var(--primary);
        border-color: var(--primary);
    }

    /* Tool Categories */
    .tool-category {
        margin-bottom: var(--space-xl);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-light);
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }

    .tool-category:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
    }

    .category-title {
        background: var(--bg-cards);
        padding: var(--space-lg) var(--space-xl);
        margin: 0;
        border-bottom: 1px solid var(--border-light);
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-heading);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .category-title:hover {
        background: var(--bg-secondary);
    }

    .category-title i {
        color: var(--primary);
        margin-right: var(--space-sm);
    }

    .category-count {
        background: var(--primary);
        color: var(--text-inverse);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: 600;
    }

    .category-tools {
        padding: var(--space-lg);
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }

    /* Quick Actions */
    .mcp-actions-card {
        background: var(--bg-cards);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
        border: 2px solid var(--border-medium);
        border-top: 4px solid var(--success);
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        flex-shrink: 0;
        flex: none;
    }

    .mcp-actions-title {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-heading);
        margin: 0 0 var(--space-md) 0;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .mcp-actions-title i {
        color: var(--success);
    }

    .mcp-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
    }

    .btn-mcp-action {
        background: var(--primary-gradient);
        color: var(--text-inverse);
        border: none;
        padding: var(--space-md);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        justify-content: center;
    }

    .btn-mcp-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-mcp-action.success {
        background: var(--success-gradient);
    }

    .btn-mcp-action.info {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }

    .btn-mcp-action.warning {
        background: var(--warning-gradient);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--space-md);
        opacity: 0.5;
    }

    .empty-state h4 {
        margin: 0 0 var(--space-sm) 0;
        color: var(--text-heading);
    }

    .empty-state p {
        margin: 0;
        font-size: var(--text-sm);
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--text-secondary);
    }

    .loading i {
        font-size: 2rem;
        margin-bottom: var(--space-md);
        color: var(--primary);
    }

    /* Alert Messages */
    .alert {
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-bottom: var(--space-md);
        border: 1px solid transparent;
        font-weight: 500;
    }

    .alert-success {
        background: var(--success-light);
        color: var(--success);
        border-color: rgba(16, 185, 129, 0.2);
    }

    .alert-danger {
        background: var(--critical-light);
        color: var(--critical);
        border-color: rgba(239, 68, 68, 0.2);
    }

    .alert-info {
        background: var(--info-light);
        color: var(--info);
        border-color: rgba(14, 165, 233, 0.2);
    }

    .alert-warning {
        background: var(--warning-light);
        color: var(--warning);
        border-color: rgba(217, 119, 6, 0.2);
    }

    /* Tool Details Styles */
    .tool-details {
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
    }

    .tool-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-sm);
    }

    .tool-header h4 {
        margin: 0;
        color: var(--text-heading);
        font-size: var(--text-lg);
        font-weight: 600;
        flex: 1;
    }

    .tool-category-badge {
        background: var(--primary);
        color: var(--text-inverse);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .tool-description {
        color: var(--text-secondary);
        font-size: var(--text-sm);
        line-height: 1.5;
        margin: 0;
    }

    .tool-status-section,
    .tool-parameters-section,
    .tool-actions-section {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .tool-status-section h5,
    .tool-parameters-section h5,
    .tool-actions-section h5 {
        margin: 0;
        color: var(--text-heading);
        font-size: var(--text-sm);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        padding: var(--space-sm);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: 600;
    }

    .status-indicator.status-available {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .status-indicator.status-unavailable {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
    }

    .status-indicator.status-error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .status-indicator i {
        font-size: var(--text-xs);
    }

    .parameters-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .parameter-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-sm);
        transition: all 0.2s ease;
    }

    .parameter-item:hover {
        border-color: var(--primary);
        background: rgba(0, 174, 199, 0.05);
    }

    .parameter-name {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-xs);
    }

    .parameter-name strong {
        color: var(--text-heading);
        font-size: var(--text-sm);
    }

    .parameter-type {
        background: var(--bg-cards);
        color: var(--text-secondary);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
    }

    .parameter-description {
        color: var(--text-secondary);
        font-size: var(--text-xs);
        line-height: 1.4;
    }

    .tool-actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-sm);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .mcp-config-grid {
            grid-template-columns: 1fr;
        }
        
        .mcp-stats-summary {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .mcp-actions-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .mcp-container {
            grid-template-columns: 1fr;
        }
        
        .mcp-container.with-sidebar {
            grid-template-columns: 1fr;
        }
        
        .mcp-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100vh;
            z-index: 1000;
            border-radius: 0;
        }
        
        .mcp-stats-summary {
            grid-template-columns: 1fr;
        }
        
        .category-tools {
            padding: var(--space-md);
        }
        
        .mcp-tool-item {
            padding: var(--space-md);
        }
    }

    .tool-actions-grid .btn-mcp-action {
        padding: var(--space-sm);
        font-size: var(--text-xs);
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="mcp-container">
    <!-- Main MCP Area -->
    <div class="mcp-main">
        <!-- MCP Status Card -->
        <div class="mcp-status-card">
            <div class="mcp-status-header" onclick="toggleMCPStatus()">
                <h2 class="mcp-status-title">
                    <i class="fas fa-plug"></i>
                    MCP Status & Configuration
                </h2>
                <button class="mcp-status-toggle" id="mcpStatusToggle">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            
            <div class="mcp-status-content" id="mcpStatusContent">
                <div class="mcp-config-grid">
                    <div class="mcp-config-group">
                        <label class="mcp-config-label">AI Provider</label>
                        <select id="aiProvider" class="mcp-config-select">
                            <option value="ollama">Ollama (Local)</option>
                            <option value="openai">OpenAI (Cloud)</option>
                            <option value="gemini">Google Gemini (Cloud)</option>
                        </select>
                    </div>
                    <div class="mcp-config-group">
                        <label class="mcp-config-label">Model Name</label>
                        <input type="text" id="aiModel" class="mcp-config-input" placeholder="e.g., tinyllama, gpt-4">
                    </div>
                    <div class="mcp-config-group">
                        <label class="mcp-config-label">API URL</label>
                        <input type="text" id="aiApiUrl" class="mcp-config-input" placeholder="e.g., http://ollama:11434">
                    </div>
                    <div class="mcp-config-group">
                        <label class="mcp-config-label">MCP Enabled</label>
                        <select id="mcpEnabled" class="mcp-config-select">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>
                <div class="mcp-config-actions">
                    <button class="btn-mcp-config" onclick="saveMCPConfig()">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                    <button class="btn-mcp-config secondary" onclick="resetMCPConfig()">
                        <i class="fas fa-undo"></i>
                        Reset to Defaults
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mcp-stats-summary">
            <div class="mcp-stat-item success" onclick="showSection('overview')" data-section="overview" title="MCP Overview">
                <div class="mcp-stat-number" id="serverStatus">-</div>
                <div class="mcp-stat-label">Server Status</div>
            </div>
            <div class="mcp-stat-item info" onclick="showSection('tools')" data-section="tools" title="Available Tools">
                <div class="mcp-stat-number" id="toolsCount">-</div>
                <div class="mcp-stat-label">Tools</div>
            </div>
            <div class="mcp-stat-item warning" onclick="showSection('clients')" data-section="clients" title="Connected Clients">
                <div class="mcp-stat-number" id="clientsCount">-</div>
                <div class="mcp-stat-label">Clients</div>
            </div>
            <div class="mcp-stat-item danger" onclick="showSection('activity')" data-section="activity" title="Recent Activity">
                <div class="mcp-stat-number" id="activityCount">-</div>
                <div class="mcp-stat-label">Activity</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mcp-actions-card">
            <h3 class="mcp-actions-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h3>
            <div class="mcp-actions-grid">
                <button class="btn-mcp-action" onclick="testMCPIntegration()">
                    <i class="fas fa-play"></i>
                    Test Integration
                </button>
                <button class="btn-mcp-action success" onclick="connectClients()">
                    <i class="fas fa-link"></i>
                    Connect Clients
                </button>
                <button class="btn-mcp-action info" onclick="exportConfig()">
                    <i class="fas fa-download"></i>
                    Export Config
                </button>
                <button class="btn-mcp-action warning" onclick="refreshStatus()">
                    <i class="fas fa-sync"></i>
                    Refresh Status
                </button>
            </div>
        </div>

        <!-- MCP Tools List -->
        <div class="mcp-tools-container">
            <div class="mcp-tools-header">
                <div class="mcp-tools-title">
                    <i class="fas fa-tools"></i>
                    MCP Tools & Resources
                    <span class="mcp-tools-count" id="toolsCountDisplay">0</span>
                </div>
                <div class="mcp-tools-controls">
                    <span class="pagination-info" id="toolsInfo">Loading...</span>
                </div>
            </div>
            <div class="mcp-tools-body">
                <div id="toolsList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading MCP tools...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar - Tool Details & Configuration -->
    <div class="mcp-sidebar">
        <div class="detail-header">
            <h3 class="detail-title">
                <i class="fas fa-info-circle"></i>
                <span id="detailTitle">Select a tool for details</span>
            </h3>
            <button class="detail-close" onclick="hideSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-body" id="detailContent">
            <div class="empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <h4>No Tool Selected</h4>
                <p>Click on any MCP tool to view detailed information and configuration options.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let mcpStatus = {};
    let mcpTools = [];
    let selectedTool = null;
    let currentSection = 'overview';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize status card as collapsed
        const statusContent = document.getElementById('mcpStatusContent');
        const statusToggle = document.getElementById('mcpStatusToggle');
        statusContent.classList.add('collapsed');
        statusToggle.classList.add('collapsed');
        
        loadMCPStatus();
        loadMCPTools();
        setInterval(loadMCPStatus, 30000); // Refresh every 30 seconds
    });

    // Toggle MCP Status Card
    function toggleMCPStatus() {
        const content = document.getElementById('mcpStatusContent');
        const toggle = document.getElementById('mcpStatusToggle');
        
        content.classList.toggle('collapsed');
        toggle.classList.toggle('collapsed');
    }

    // Load MCP Status
    function loadMCPStatus() {
        fetch('/api/mcp/status')
            .then(response => response.json())
            .then(data => {
                mcpStatus = data;
                updateStatusDisplay(data);
            })
            .catch(error => {
                console.error('Error loading MCP status:', error);
                showError('Failed to load MCP status');
            });
    }

    // Update Status Display
    function updateStatusDisplay(data) {
        // Update stats
        document.getElementById('serverStatus').textContent = data.overall_status === 'active' ? 'Active' : 'Inactive';
        document.getElementById('toolsCount').textContent = mcpTools.length;
        document.getElementById('clientsCount').textContent = data.metrics.active_integrations;
        document.getElementById('activityCount').textContent = data.metrics.context_enrichments;
        
        // Update tools count display
        document.getElementById('toolsCountDisplay').textContent = mcpTools.length;
        document.getElementById('toolsInfo').textContent = `${mcpTools.length} tools available`;
        
        // Update stat item colors based on status
        const serverStat = document.querySelector('[data-section="overview"]');
        const toolsStat = document.querySelector('[data-section="tools"]');
        const clientsStat = document.querySelector('[data-section="clients"]');
        const activityStat = document.querySelector('[data-section="activity"]');
        
        if (data.overall_status === 'active') {
            serverStat.classList.add('success');
            serverStat.classList.remove('danger');
        } else {
            serverStat.classList.add('danger');
            serverStat.classList.remove('success');
        }
        
        if (mcpTools.length > 0) {
            toolsStat.classList.add('info');
            toolsStat.classList.remove('warning');
        } else {
            toolsStat.classList.add('warning');
            toolsStat.classList.remove('info');
        }
        
        if (data.metrics.active_integrations > 0) {
            clientsStat.classList.add('success');
            clientsStat.classList.remove('warning');
        } else {
            clientsStat.classList.add('warning');
            clientsStat.classList.remove('success');
        }
    }

    // Load MCP Tools
    function loadMCPTools() {
        fetch('/api/mcp/status')
            .then(response => response.json())
            .then(data => {
                // Include all functional MCP tools with real backend implementations
                mcpTools = [
                    // Security Alerts Tools
                    {
                        name: 'get_security_alerts',
                        description: 'Retrieve security alerts with filtering options',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            status: { type: 'string', description: 'Alert status filter (all, unread, read, dismissed)' },
                            priority: { type: 'string', description: 'Priority filter (all, critical, error, warning, info)' },
                            limit: { type: 'integer', description: 'Number of alerts to return' },
                            time_range: { type: 'string', description: 'Time range filter (1h, 24h, 7d, 30d)' }
                        }
                    },
                    {
                        name: 'analyze_security_alert',
                        description: 'Get AI analysis for a specific security alert',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            alert_id: { type: 'integer', description: 'Alert ID to analyze' },
                            language: { type: 'string', description: 'Analysis language' }
                        }
                    },
                    {
                        name: 'chat_with_security_ai',
                        description: 'Chat with the security AI assistant',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            message: { type: 'string', description: 'User message' },
                            persona: { type: 'string', description: 'AI persona (security_analyst, incident_responder, threat_hunter, report_generator)' },
                            language: { type: 'string', description: 'Chat language' },
                            context: { type: 'object', description: 'Additional context' }
                        }
                    },
                    {
                        name: 'get_security_dashboard',
                        description: 'Generate security dashboard data',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            dashboard_type: { type: 'string', description: 'Dashboard type (general, security, executive, operational)' },
                            time_range: { type: 'string', description: 'Time range for dashboard' },
                            include_charts: { type: 'boolean', description: 'Include chart data' }
                        }
                    },
                    {
                        name: 'search_security_events',
                        description: 'Semantic search across security events',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            query: { type: 'string', description: 'Search query' },
                            limit: { type: 'integer', description: 'Search result limit' },
                            certainty: { type: 'number', description: 'Search certainty threshold' }
                        }
                    },
                    {
                        name: 'get_alert_statistics',
                        description: 'Get comprehensive alert statistics and metrics',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            time_range: { type: 'string', description: 'Statistics time range' },
                            include_breakdown: { type: 'boolean', description: 'Include breakdown data' }
                        }
                    },
                    {
                        name: 'reprocess_alert',
                        description: 'Reprocess an alert with fresh AI analysis',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            alert_id: { type: 'integer', description: 'Alert ID to reprocess' }
                        }
                    },
                    {
                        name: 'bulk_generate_ai_analysis',
                        description: 'Generate AI analysis for all alerts missing it',
                        status: 'available',
                        category: 'Security Alerts',
                        parameters: {
                            force_regenerate: { type: 'boolean', description: 'Force regeneration of existing analysis' }
                        }
                    },
                    
                    // Threat Intelligence & Analysis
                    {
                        name: 'get_threat_intelligence',
                        description: 'Get AI-powered threat intelligence analysis',
                        status: 'available',
                        category: 'Threat Intelligence',
                        parameters: {
                            analysis_type: { type: 'string', description: 'Analysis type (patterns, indicators, predictions, summary)' },
                            time_range_days: { type: 'integer', description: 'Time range in days' }
                        }
                    },
                    
                    // Configuration Tools
                    {
                        name: 'get_ai_config',
                        description: 'Get current AI configuration',
                        status: 'available',
                        category: 'Configuration',
                        parameters: {}
                    },
                    {
                        name: 'get_slack_config',
                        description: 'Get Slack integration configuration',
                        status: 'available',
                        category: 'Configuration',
                        parameters: {}
                    },
                    {
                        name: 'get_system_health',
                        description: 'Get system health status for all components',
                        status: 'available',
                        category: 'Configuration',
                        parameters: {}
                    },
                    
                    // Advanced Analytics
                    {
                        name: 'cluster_alerts',
                        description: 'Cluster similar alerts using AI',
                        status: 'available',
                        category: 'Advanced Analytics',
                        parameters: {
                            min_cluster_size: { type: 'integer', description: 'Minimum cluster size' },
                            time_range: { type: 'string', description: 'Time range for clustering' }
                        }
                    },
                    {
                        name: 'predict_threats',
                        description: 'Predict potential threats based on current patterns',
                        status: 'available',
                        category: 'Advanced Analytics',
                        parameters: {
                            prediction_horizon: { type: 'integer', description: 'Prediction horizon in days' },
                            confidence_threshold: { type: 'number', description: 'Confidence threshold' }
                        }
                    },
                    
                    // Alternative MCP Implementation
                    {
                        name: 'analyze_system_state',
                        description: 'Analyze current system state for security vulnerabilities',
                        status: 'available',
                        category: 'System Analysis',
                        parameters: {
                            components: { type: 'array', description: 'System components to analyze' }
                        }
                    }
                ];
                renderTools();
                // Update the status display with the correct tool count
                if (mcpStatus.overall_status) {
                    updateStatusDisplay(mcpStatus);
                }
            })
            .catch(error => {
                console.error('Error loading MCP tools:', error);
                showError('Failed to load MCP tools');
            });
    }

    // Render Tools
    function renderTools() {
        const container = document.getElementById('toolsList');
        
        if (mcpTools.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tools"></i>
                    <h4>No Tools Available</h4>
                    <p>No MCP tools are currently available. Check your configuration.</p>
                </div>
            `;
            return;
        }
        
        // Group tools by category
        const toolsByCategory = {};
        mcpTools.forEach(tool => {
            const category = tool.category || 'Other';
            if (!toolsByCategory[category]) {
                toolsByCategory[category] = [];
            }
            toolsByCategory[category].push(tool);
        });
        
        // Generate HTML for each category
        let toolsHTML = '';
        Object.keys(toolsByCategory).forEach(category => {
            const tools = toolsByCategory[category];
            toolsHTML += `
                <div class="tool-category">
                    <h4 class="category-title">
                        <i class="fas fa-folder"></i>
                        ${category}
                        <span class="category-count">${tools.length} tools</span>
                    </h4>
                    <div class="category-tools">
                        ${tools.map(tool => `
                            <div class="mcp-tool-item" onclick="selectTool('${tool.name}')" data-tool="${tool.name}">
                                <div class="mcp-tool-header">
                                    <div class="mcp-tool-name">${tool.name}</div>
                                    <div class="mcp-tool-status status-${tool.status}">${tool.status}</div>
                                </div>
                                <div class="mcp-tool-description">${tool.description}</div>
                                <div class="mcp-tool-actions">
                                    <button class="btn-mcp-tool" onclick="event.stopPropagation(); testTool('${tool.name}')">
                                        <i class="fas fa-play"></i>
                                        Test
                                    </button>
                                    <button class="btn-mcp-tool secondary" onclick="event.stopPropagation(); viewToolDetails('${tool.name}')">
                                        <i class="fas fa-info"></i>
                                        Details
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = toolsHTML;
    }

    // Select Tool
    function selectTool(toolName) {
        const tool = mcpTools.find(t => t.name === toolName);
        if (!tool) return;
        
        selectedTool = tool;
        
        // Update selection
        document.querySelectorAll('.mcp-tool-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.querySelector(`[data-tool="${toolName}"]`).classList.add('selected');
        
        // Show sidebar
        showSidebar();
        
        // Update sidebar content
        document.getElementById('detailTitle').textContent = tool.name;
        document.getElementById('detailContent').innerHTML = `
            <div class="tool-details">
                <div class="tool-header">
                    <h4>${tool.name}</h4>
                    <span class="tool-category-badge">${tool.category}</span>
                </div>
                <p class="tool-description">${tool.description}</p>
                
                <div class="tool-status-section">
                    <h5>Status</h5>
                    <div class="status-indicator status-${tool.status}">
                        <i class="fas fa-circle"></i>
                        ${tool.status.charAt(0).toUpperCase() + tool.status.slice(1)}
                    </div>
                </div>
                
                <div class="tool-parameters-section">
                    <h5>Parameters</h5>
                    <div class="parameters-list">
                        ${Object.entries(tool.parameters).map(([key, param]) => `
                            <div class="parameter-item">
                                <div class="parameter-name">
                                    <strong>${key}</strong>
                                    <span class="parameter-type">${param.type}</span>
                                </div>
                                <div class="parameter-description">${param.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="tool-actions-section">
                    <h5>Actions</h5>
                    <div class="tool-actions-grid">
                        <button class="btn-mcp-action" onclick="testTool('${tool.name}')">
                            <i class="fas fa-play"></i>
                            Test Tool
                        </button>
                        <button class="btn-mcp-action secondary" onclick="viewToolDetails('${tool.name}')">
                            <i class="fas fa-info"></i>
                            Details
                        </button>
                        <button class="btn-mcp-action secondary" onclick="viewToolLogs('${tool.name}')">
                            <i class="fas fa-file-alt"></i>
                            Logs
                        </button>
                        <button class="btn-mcp-action secondary" onclick="exportToolConfig('${tool.name}')">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Show Sidebar
    function showSidebar() {
        const sidebar = document.querySelector('.mcp-sidebar');
        const container = document.querySelector('.mcp-container');
        
        sidebar.classList.add('active');
        container.classList.add('with-sidebar');
    }

    // Hide Sidebar
    function hideSidebar() {
        const sidebar = document.querySelector('.mcp-sidebar');
        const container = document.querySelector('.mcp-container');
        
        sidebar.classList.remove('active');
        container.classList.remove('with-sidebar');
        
        selectedTool = null;
        
        document.querySelectorAll('.mcp-tool-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        document.getElementById('detailTitle').textContent = 'Select a tool for details';
        document.getElementById('detailContent').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <h4>No Tool Selected</h4>
                <p>Click on any MCP tool to view detailed information and configuration options.</p>
            </div>
        `;
    }

    // Show Section
    function showSection(sectionName) {
        currentSection = sectionName;
        
        // Update active state
        document.querySelectorAll('.mcp-stat-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
        
        // Update content based on section
        switch(sectionName) {
            case 'overview':
                showAlert('info', 'Overview', 'MCP system overview and status information');
                break;
            case 'tools':
                showAlert('info', 'Tools', 'Available MCP tools and their capabilities');
                break;
            case 'clients':
                showAlert('info', 'Clients', 'Connected MCP clients and external integrations');
                break;
            case 'activity':
                showAlert('info', 'Activity', 'Recent MCP activity and system logs');
                break;
        }
    }

    // MCP Functions
    function testMCPIntegration() {
        fetch('/api/mcp/test-integration')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'MCP Integration Test', data.message);
                } else {
                    showAlert('danger', 'MCP Integration Test', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error', 'Failed to test MCP integration');
            });
    }

    function connectClients() {
        fetch('/api/mcp/connect-clients', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Client Connection', data.message);
                } else {
                    showAlert('danger', 'Client Connection', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error', 'Failed to connect clients');
            });
    }

    function exportConfig() {
        fetch('/api/mcp/export-config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.config, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mcp-config.json';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showAlert('success', 'Export', 'Configuration exported successfully');
                } else {
                    showAlert('danger', 'Export', 'Failed to export configuration');
                }
            })
            .catch(error => {
                showAlert('danger', 'Error', 'Failed to export configuration');
            });
    }

    function refreshStatus() {
        loadMCPStatus();
        loadMCPTools();
        showAlert('info', 'Refresh', 'Status refreshed successfully');
    }

    function testTool(toolName) {
        showAlert('info', 'Tool Test', `Testing tool: ${toolName}`);
        // This would call the actual tool test API
    }

    function viewToolDetails(toolName) {
        showAlert('info', 'Tool Details', `Viewing details for: ${toolName}`);
        // This would show detailed tool information
    }

    function viewToolLogs(toolName) {
        showAlert('info', 'Tool Logs', `Viewing logs for: ${toolName}`);
        // This would show tool-specific logs
    }

    function exportToolConfig(toolName) {
        const tool = mcpTools.find(t => t.name === toolName);
        if (tool) {
            const config = {
                tool_name: tool.name,
                category: tool.category,
                description: tool.description,
                parameters: tool.parameters,
                status: tool.status,
                export_timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${toolName}-config.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            showAlert('success', 'Export', `Configuration for ${toolName} exported successfully`);
        }
    }

    function saveMCPConfig() {
        const config = {
            ai_provider: document.getElementById('aiProvider').value,
            ai_model: document.getElementById('aiModel').value,
            ai_api_url: document.getElementById('aiApiUrl').value,
            mcp_enabled: document.getElementById('mcpEnabled').value
        };
        
        fetch('/api/mcp/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Configuration', 'MCP configuration saved successfully');
                } else {
                    showAlert('danger', 'Configuration', 'Failed to save configuration');
                }
            })
            .catch(error => {
                showAlert('danger', 'Error', 'Failed to save configuration');
            });
    }

    function resetMCPConfig() {
        if (confirm('Are you sure you want to reset MCP configuration to defaults?')) {
            document.getElementById('aiProvider').value = 'ollama';
            document.getElementById('aiModel').value = 'tinyllama';
            document.getElementById('aiApiUrl').value = 'http://ollama:11434';
            document.getElementById('mcpEnabled').value = 'true';
            showAlert('info', 'Configuration', 'Configuration reset to defaults');
        }
    }

    function showAlert(type, title, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <strong>${title}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.mcp-main');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    function showError(message) {
        const container = document.getElementById('toolsList');
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                <h4>Error</h4>
                <p>${message}</p>
            </div>
        `;
    }
</script>
{% endblock %} 